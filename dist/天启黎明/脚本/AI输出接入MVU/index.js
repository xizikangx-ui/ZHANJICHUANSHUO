var __webpack_modules__ = {
  "./src/天启黎明/脚本/AI输出接入MVU/index.ts"() {
    eval("{\n$(() => {\n    errorCatched(async () => {\n        await waitGlobalInitialized('Mvu');\n        const syncing_message_ids = new Set();\n        const synced_message_content = new Map();\n        async function syncMessageToMvu(message_id) {\n            if (syncing_message_ids.has(message_id))\n                return;\n            const message = getChatMessages(message_id, { include_swipes: false })[0];\n            if (!message || message.role !== 'assistant' || message.is_hidden)\n                return;\n            const content = message.message?.trim() ?? '';\n            if (!content)\n                return;\n            if (synced_message_content.get(message_id) === content)\n                return;\n            syncing_message_ids.add(message_id);\n            try {\n                const old_data = Mvu.getMvuData({ type: 'message', message_id });\n                const new_data = await Mvu.parseMessage(content, old_data);\n                await Mvu.replaceMvuData(new_data, { type: 'message', message_id });\n                synced_message_content.set(message_id, content);\n                console.info(`[天启黎明][MVU桥接] 已同步楼层 ${message_id}`);\n            }\n            catch (error) {\n                console.warn(`[天启黎明][MVU桥接] 同步楼层 ${message_id} 失败`, error);\n            }\n            finally {\n                syncing_message_ids.delete(message_id);\n            }\n        }\n        eventOn(tavern_events.MESSAGE_RECEIVED, message_id => {\n            void syncMessageToMvu(message_id);\n        });\n        eventOn(tavern_events.MESSAGE_UPDATED, message_id => {\n            void syncMessageToMvu(message_id);\n        });\n        eventOn(tavern_events.CHAT_CHANGED, () => {\n            syncing_message_ids.clear();\n            synced_message_content.clear();\n        });\n        const latest = getChatMessages(-1, { include_swipes: false })[0];\n        if (latest && latest.role === 'assistant') {\n            void syncMessageToMvu(latest.message_id);\n        }\n    })();\n});\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiLi9zcmMv5aSp5ZCv6buO5piOL+iEmuacrC9BSei+k+WHuuaOpeWFpU1WVS9pbmRleC50cyIsIm1hcHBpbmdzIjoiO0FBQUEsQ0FBQyxDQUFDLEdBQUcsRUFBRTtJQUNMLFlBQVksQ0FBQyxLQUFLLElBQUksRUFBRTtRQUN0QixNQUFNLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRW5DLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUM5QyxNQUFNLHNCQUFzQixHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1FBRXpELEtBQUssVUFBVSxnQkFBZ0IsQ0FBQyxVQUFrQjtZQUNoRCxJQUFJLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7Z0JBQUUsT0FBTztZQUVoRCxNQUFNLE9BQU8sR0FBRyxlQUFlLENBQUMsVUFBVSxFQUFFLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDMUUsSUFBSSxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLFdBQVcsSUFBSSxPQUFPLENBQUMsU0FBUztnQkFBRSxPQUFPO1lBRTFFLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDO1lBQzlDLElBQUksQ0FBQyxPQUFPO2dCQUFFLE9BQU87WUFDckIsSUFBSSxzQkFBc0IsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEtBQUssT0FBTztnQkFBRSxPQUFPO1lBRS9ELG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUNwQyxJQUFJLENBQUM7Z0JBQ0gsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQztnQkFDakUsTUFBTSxRQUFRLEdBQUcsTUFBTSxHQUFHLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDM0QsTUFBTSxHQUFHLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQztnQkFDcEUsc0JBQXNCLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztnQkFDaEQsT0FBTyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsVUFBVSxFQUFFLENBQUMsQ0FBQztZQUNwRCxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDZixPQUFPLENBQUMsSUFBSSxDQUFDLHNCQUFzQixVQUFVLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM3RCxDQUFDO29CQUFTLENBQUM7Z0JBQ1QsbUJBQW1CLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3pDLENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxVQUFVLENBQUMsRUFBRTtZQUNuRCxLQUFLLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3BDLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLGFBQWEsQ0FBQyxlQUFlLEVBQUUsVUFBVSxDQUFDLEVBQUU7WUFDbEQsS0FBSyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNwQyxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxhQUFhLENBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRTtZQUN2QyxtQkFBbUIsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUM1QixzQkFBc0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNqQyxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sTUFBTSxHQUFHLGVBQWUsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pFLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssV0FBVyxFQUFFLENBQUM7WUFDMUMsS0FBSyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDM0MsQ0FBQztJQUNILENBQUMsQ0FBQyxFQUFFLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXMiOlsic3JjOi8vdGF2ZXJuX2hlbHBlcl90ZW1wbGF0ZS9zcmMv5aSp5ZCv6buO5piOL+iEmuacrC9BSei+k+WHuuaOpeWFpU1WVS9pbmRleC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIkKCgpID0+IHtcbiAgZXJyb3JDYXRjaGVkKGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCB3YWl0R2xvYmFsSW5pdGlhbGl6ZWQoJ012dScpO1xuXG4gICAgY29uc3Qgc3luY2luZ19tZXNzYWdlX2lkcyA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgIGNvbnN0IHN5bmNlZF9tZXNzYWdlX2NvbnRlbnQgPSBuZXcgTWFwPG51bWJlciwgc3RyaW5nPigpO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gc3luY01lc3NhZ2VUb012dShtZXNzYWdlX2lkOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgIGlmIChzeW5jaW5nX21lc3NhZ2VfaWRzLmhhcyhtZXNzYWdlX2lkKSkgcmV0dXJuO1xuXG4gICAgICBjb25zdCBtZXNzYWdlID0gZ2V0Q2hhdE1lc3NhZ2VzKG1lc3NhZ2VfaWQsIHsgaW5jbHVkZV9zd2lwZXM6IGZhbHNlIH0pWzBdO1xuICAgICAgaWYgKCFtZXNzYWdlIHx8IG1lc3NhZ2Uucm9sZSAhPT0gJ2Fzc2lzdGFudCcgfHwgbWVzc2FnZS5pc19oaWRkZW4pIHJldHVybjtcblxuICAgICAgY29uc3QgY29udGVudCA9IG1lc3NhZ2UubWVzc2FnZT8udHJpbSgpID8/ICcnO1xuICAgICAgaWYgKCFjb250ZW50KSByZXR1cm47XG4gICAgICBpZiAoc3luY2VkX21lc3NhZ2VfY29udGVudC5nZXQobWVzc2FnZV9pZCkgPT09IGNvbnRlbnQpIHJldHVybjtcblxuICAgICAgc3luY2luZ19tZXNzYWdlX2lkcy5hZGQobWVzc2FnZV9pZCk7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBvbGRfZGF0YSA9IE12dS5nZXRNdnVEYXRhKHsgdHlwZTogJ21lc3NhZ2UnLCBtZXNzYWdlX2lkIH0pO1xuICAgICAgICBjb25zdCBuZXdfZGF0YSA9IGF3YWl0IE12dS5wYXJzZU1lc3NhZ2UoY29udGVudCwgb2xkX2RhdGEpO1xuICAgICAgICBhd2FpdCBNdnUucmVwbGFjZU12dURhdGEobmV3X2RhdGEsIHsgdHlwZTogJ21lc3NhZ2UnLCBtZXNzYWdlX2lkIH0pO1xuICAgICAgICBzeW5jZWRfbWVzc2FnZV9jb250ZW50LnNldChtZXNzYWdlX2lkLCBjb250ZW50KTtcbiAgICAgICAgY29uc29sZS5pbmZvKGBb5aSp5ZCv6buO5piOXVtNVlXmoaXmjqVdIOW3suWQjOatpealvOWxgiAke21lc3NhZ2VfaWR9YCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLndhcm4oYFvlpKnlkK/pu47mmI5dW01WVeahpeaOpV0g5ZCM5q2l5qW85bGCICR7bWVzc2FnZV9pZH0g5aSx6LSlYCwgZXJyb3IpO1xuICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgc3luY2luZ19tZXNzYWdlX2lkcy5kZWxldGUobWVzc2FnZV9pZCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZXZlbnRPbih0YXZlcm5fZXZlbnRzLk1FU1NBR0VfUkVDRUlWRUQsIG1lc3NhZ2VfaWQgPT4ge1xuICAgICAgdm9pZCBzeW5jTWVzc2FnZVRvTXZ1KG1lc3NhZ2VfaWQpO1xuICAgIH0pO1xuXG4gICAgZXZlbnRPbih0YXZlcm5fZXZlbnRzLk1FU1NBR0VfVVBEQVRFRCwgbWVzc2FnZV9pZCA9PiB7XG4gICAgICB2b2lkIHN5bmNNZXNzYWdlVG9NdnUobWVzc2FnZV9pZCk7XG4gICAgfSk7XG5cbiAgICBldmVudE9uKHRhdmVybl9ldmVudHMuQ0hBVF9DSEFOR0VELCAoKSA9PiB7XG4gICAgICBzeW5jaW5nX21lc3NhZ2VfaWRzLmNsZWFyKCk7XG4gICAgICBzeW5jZWRfbWVzc2FnZV9jb250ZW50LmNsZWFyKCk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBsYXRlc3QgPSBnZXRDaGF0TWVzc2FnZXMoLTEsIHsgaW5jbHVkZV9zd2lwZXM6IGZhbHNlIH0pWzBdO1xuICAgIGlmIChsYXRlc3QgJiYgbGF0ZXN0LnJvbGUgPT09ICdhc3Npc3RhbnQnKSB7XG4gICAgICB2b2lkIHN5bmNNZXNzYWdlVG9NdnUobGF0ZXN0Lm1lc3NhZ2VfaWQpO1xuICAgIH1cbiAgfSkoKTtcbn0pO1xuXG4iXSwibmFtZXMiOltdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///./src/天启黎明/脚本/AI输出接入MVU/index.ts\n\n}");
  }
};

var __webpack_exports__ = {};

__webpack_modules__["./src/天启黎明/脚本/AI输出接入MVU/index.ts"]();