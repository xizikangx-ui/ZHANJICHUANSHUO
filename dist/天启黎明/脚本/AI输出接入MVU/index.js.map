{"version":3,"file":"index.js","mappings":"AAAAA,EAAE,KACAC,aAAaC,gBACLC,sBAAsB,OAE5B,MAAMC,EAAsB,IAAIC,IAC1BC,EAAyB,IAAIC,IAEnCL,eAAeM,EAAiBC,GAC9B,GAAIL,EAAoBM,IAAID,GAAa,OAEzC,MAAME,EAAUC,gBAAgBH,EAAY,CAAEI,gBAAgB,IAAS,GACvE,IAAKF,GAA4B,cAAjBA,EAAQG,MAAwBH,EAAQI,UAAW,OAEnE,MAAMC,EAAUL,EAAQA,SAASM,QAAU,GAC3C,GAAKD,GACDV,EAAuBY,IAAIT,KAAgBO,EAA/C,CAEAZ,EAAoBe,IAAIV,GACxB,IACE,MAAMW,EAAWC,IAAIC,WAAW,CAAEC,KAAM,UAAWd,eAC7Ce,QAAiBH,IAAII,aAAaT,EAASI,SAC3CC,IAAIK,eAAeF,EAAU,CAAED,KAAM,UAAWd,eACtDH,EAAuBqB,IAAIlB,EAAYO,GACvCY,QAAQC,KAAK,uBAAuBpB,IACtC,CAAE,MAAOqB,GACPF,QAAQG,KAAK,sBAAsBtB,OAAiBqB,EACtD,C,QACE1B,EAAoB4B,OAAOvB,EAC7B,CAb8D,CAchE,CAEAwB,QAAQC,cAAcC,iBAAkB1B,IACjCD,EAAiBC,KAGxBwB,QAAQC,cAAcE,gBAAiB3B,IAChCD,EAAiBC,KAGxBwB,QAAQC,cAAcG,aAAc,KAClCjC,EAAoBkC,QACpBhC,EAAuBgC,UAGzB,MAAMC,EAAS3B,iBAAiB,EAAG,CAAEC,gBAAgB,IAAS,GAC1D0B,GAA0B,cAAhBA,EAAOzB,MACdN,EAAiB+B,EAAO9B,aA7CjCR","sources":["src://tavern_helper_template/src/天启黎明/脚本/AI输出接入MVU/index.ts"],"sourcesContent":["$(() => {\n  errorCatched(async () => {\n    await waitGlobalInitialized('Mvu');\n\n    const syncing_message_ids = new Set<number>();\n    const synced_message_content = new Map<number, string>();\n\n    async function syncMessageToMvu(message_id: number): Promise<void> {\n      if (syncing_message_ids.has(message_id)) return;\n\n      const message = getChatMessages(message_id, { include_swipes: false })[0];\n      if (!message || message.role !== 'assistant' || message.is_hidden) return;\n\n      const content = message.message?.trim() ?? '';\n      if (!content) return;\n      if (synced_message_content.get(message_id) === content) return;\n\n      syncing_message_ids.add(message_id);\n      try {\n        const old_data = Mvu.getMvuData({ type: 'message', message_id });\n        const new_data = await Mvu.parseMessage(content, old_data);\n        await Mvu.replaceMvuData(new_data, { type: 'message', message_id });\n        synced_message_content.set(message_id, content);\n        console.info(`[天启黎明][MVU桥接] 已同步楼层 ${message_id}`);\n      } catch (error) {\n        console.warn(`[天启黎明][MVU桥接] 同步楼层 ${message_id} 失败`, error);\n      } finally {\n        syncing_message_ids.delete(message_id);\n      }\n    }\n\n    eventOn(tavern_events.MESSAGE_RECEIVED, message_id => {\n      void syncMessageToMvu(message_id);\n    });\n\n    eventOn(tavern_events.MESSAGE_UPDATED, message_id => {\n      void syncMessageToMvu(message_id);\n    });\n\n    eventOn(tavern_events.CHAT_CHANGED, () => {\n      syncing_message_ids.clear();\n      synced_message_content.clear();\n    });\n\n    const latest = getChatMessages(-1, { include_swipes: false })[0];\n    if (latest && latest.role === 'assistant') {\n      void syncMessageToMvu(latest.message_id);\n    }\n  })();\n});\n\n"],"names":["$","errorCatched","async","waitGlobalInitialized","syncing_message_ids","Set","synced_message_content","Map","syncMessageToMvu","message_id","has","message","getChatMessages","include_swipes","role","is_hidden","content","trim","get","add","old_data","Mvu","getMvuData","type","new_data","parseMessage","replaceMvuData","set","console","info","error","warn","delete","eventOn","tavern_events","MESSAGE_RECEIVED","MESSAGE_UPDATED","CHAT_CHANGED","clear","latest"],"sourceRoot":""}