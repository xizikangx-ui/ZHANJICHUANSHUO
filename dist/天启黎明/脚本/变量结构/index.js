import{registerMvuSchema as t}from'https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/util/mvu_zod.js';const e=z,r=e.z.object({界面:e.z.object({建卡:e.z.object({已开始:e.z.boolean().prefault(!1),角色姓名:e.z.string().prefault(''),职业:e.z.enum(['指挥官','战姬','权柄使役者']).prefault('指挥官'),战姬类型:e.z.enum(['侦察型','轻型','中型','重型','要塞型','地面支援姬']).prefault('轻型'),年龄:e.z.coerce.number().transform(t=>_.clamp(t,12,80)).prefault(21),性别:e.z.enum(['男性','女性']).prefault('男性'),作弊模式:e.z.boolean().prefault(!1),剧情模式:e.z.boolean().prefault(!1)}).prefault({}),楼层文本:e.z.object({正文:e.z.string().prefault(''),原文:e.z.string().prefault(''),更新时间:e.z.coerce.number().prefault(0)}).prefault({}),在场角色:e.z.array(e.z.object({姓名:e.z.string().prefault('未命名'),好感度:e.z.coerce.number().transform(t=>_.clamp(t,-200,1e3)).prefault(0),等级:e.z.string().prefault('新手'),态度:e.z.string().prefault('中立'),内心想法:e.z.string().prefault(''),基础属性:e.z.record(e.z.string().describe('属性名'),e.z.coerce.number().prefault(0)).prefault({}),更新时间:e.z.coerce.number().prefault(0)}).prefault({})).prefault([]),模块折叠:e.z.object({在场角色:e.z.boolean().prefault(!1),长期NPC:e.z.boolean().prefault(!1)}).prefault({}),游戏结束:e.z.object({已结束:e.z.boolean().prefault(!1),原因:e.z.string().prefault(''),时间戳:e.z.coerce.number().prefault(0)}).prefault({}),空战反馈:e.z.object({待反馈:e.z.boolean().prefault(!1),摘要:e.z.string().prefault(''),时间戳:e.z.coerce.number().prefault(0)}).prefault({})}).prefault({}),世界:e.z.object({当前时间:e.z.string().prefault('联合纪年177年8月28日 08:00'),当前地点:e.z.string().prefault('联合第六集团军 卡尔斯空港城'),天气:e.z.string().prefault('阴，低能见度'),战区威胁等级:e.z.enum(['低','中','高','极危']).prefault('中'),近期事务:e.z.record(e.z.string().describe('事务名'),e.z.string().describe('事务描述')).prefault({}),新手引导:e.z.object({剧情模式:e.z.boolean().prefault(!1),训练判定:e.z.enum(['未受训','已受训']).prefault('未受训'),阶段:e.z.enum(['入学手续','课程周','希尔顿试验室任务','自由推进']).prefault('入学手续'),入学手续进度:e.z.coerce.number().transform(t=>_.clamp(t,0,4)).prefault(0),课程周进度:e.z.coerce.number().transform(t=>_.clamp(t,0,7)).prefault(0),已完成入学手续:e.z.boolean().prefault(!1),已完成课程周:e.z.boolean().prefault(!1),已接希尔顿任务:e.z.boolean().prefault(!1),最后推进说明:e.z.string().prefault('')}).prefault({}),长期NPC列表:e.z.record(e.z.string().describe('NPC姓名'),e.z.object({姓名:e.z.string().prefault('未命名'),好感度:e.z.coerce.number().transform(t=>_.clamp(t,-200,1e3)).prefault(0),等级:e.z.string().prefault('新手'),好感阶段:e.z.enum(['死敌','危险','警惕','熟悉','朋友','挚友','亲密','伴侣']).prefault('警惕'),态度:e.z.string().prefault('中立'),内心想法:e.z.string().prefault(''),基础属性:e.z.record(e.z.string().describe('属性名'),e.z.coerce.number().prefault(0)).prefault({}),性行为次数:e.z.coerce.number().transform(t=>_.clamp(t,0,99999)).prefault(0),贞洁状态:e.z.enum(['处女','非处女']).prefault('处女'),关系标签:e.z.array(e.z.string()).prefault([]),首次记录时间:e.z.coerce.number().prefault(0),最后更新时间:e.z.coerce.number().prefault(0)}).prefault({})).prefault({}),NPC关系追踪:e.z.record(e.z.string().describe('NPC姓名'),e.z.object({连续出现计数:e.z.coerce.number().transform(t=>_.clamp(t,0,9999)).prefault(0),最近出现轮次:e.z.coerce.number().transform(t=>_.clamp(t,0,999999)).prefault(0),玩家随行请求命中次数:e.z.coerce.number().transform(t=>_.clamp(t,0,9999)).prefault(0),最近玩家请求时间:e.z.coerce.number().prefault(0),是否已转长期:e.z.boolean().prefault(!1)}).prefault({})).prefault({})}).prefault({}),主角:e.z.object({档案:e.z.object({代号:e.z.string().prefault('待命战姬'),阵营:e.z.string().prefault('战姬武装部'),职阶:e.z.string().prefault('预备役'),身份路径:e.z.string().prefault('轻型战姬')}).prefault({}),人类属性:e.z.object({力量:e.z.coerce.number().transform(t=>_.clamp(t,0,5)).prefault(1),敏捷:e.z.coerce.number().transform(t=>_.clamp(t,0,5)).prefault(1),体质:e.z.coerce.number().transform(t=>_.clamp(t,0,5)).prefault(1),感知:e.z.coerce.number().transform(t=>_.clamp(t,0,5)).prefault(1),意志:e.z.coerce.number().transform(t=>_.clamp(t,0,5)).prefault(1),魅力:e.z.coerce.number().transform(t=>_.clamp(t,0,5)).prefault(1),学识:e.z.coerce.number().transform(t=>_.clamp(t,0,5)).prefault(1)}).prefault({}),锻炼:e.z.object({力量:e.z.coerce.number().transform(t=>_.clamp(t,0,100)).prefault(0),敏捷:e.z.coerce.number().transform(t=>_.clamp(t,0,100)).prefault(0),体质:e.z.coerce.number().transform(t=>_.clamp(t,0,100)).prefault(0),感知:e.z.coerce.number().transform(t=>_.clamp(t,0,100)).prefault(0),意志:e.z.coerce.number().transform(t=>_.clamp(t,0,100)).prefault(0),魅力:e.z.coerce.number().transform(t=>_.clamp(t,0,100)).prefault(0),学识:e.z.coerce.number().transform(t=>_.clamp(t,0,100)).prefault(0)}).prefault({}),属性:e.z.object({魔力评级:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(20),力量加成:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(18),体质加成:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(18),抗污染值:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(18),飞行速度:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(20),防御评级:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(12)}).prefault({}),成长:e.z.object({战姬老练等级:e.z.coerce.number().transform(t=>_.clamp(t,1,20)).prefault(1),权柄使役者等级:e.z.coerce.number().transform(t=>_.clamp(t,1,20)).prefault(1),魔力碎片:e.z.coerce.number().transform(t=>_.clamp(t,0,999999)).prefault(0),下一级所需魔力碎片:e.z.coerce.number().transform(t=>_.clamp(t,0,999999)).prefault(10),权柄碎片:e.z.coerce.number().transform(t=>_.clamp(t,0,999999)).prefault(0),权柄本源:e.z.boolean().prefault(!1)}).prefault({}),灵装化:e.z.object({启用:e.z.boolean().prefault(!1),手动切换:e.z.boolean().prefault(!1),灵装模式:e.z.enum(['待机','标准','过载']).prefault('标准'),每回合耗魔:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(8),每回合耗槽:e.z.coerce.number().transform(t=>_.clamp(t,0,9)).prefault(1),上次结算轮次:e.z.coerce.number().transform(t=>_.clamp(t,0,9999)).prefault(0)}).prefault({}),资源:e.z.object({当前生命:e.z.coerce.number().transform(t=>_.clamp(t,0,9999)).prefault(100),最大生命:e.z.coerce.number().transform(t=>_.clamp(t,1,9999)).prefault(100),当前魔力:e.z.coerce.number().transform(t=>_.clamp(t,0,9999)).prefault(100),最大魔力:e.z.coerce.number().transform(t=>_.clamp(t,1,9999)).prefault(100),污染值:e.z.coerce.number().transform(t=>_.clamp(t,0,100)).prefault(0),行动点:e.z.coerce.number().transform(t=>_.clamp(t,0,9)).prefault(1),移动点:e.z.coerce.number().transform(t=>_.clamp(t,0,9)).prefault(1),灵装槽当前:e.z.coerce.number().transform(t=>_.clamp(t,0,99)).prefault(10),灵装槽上限:e.z.coerce.number().transform(t=>_.clamp(t,1,99)).prefault(10)}).prefault({}),基础能力:e.z.object({已选:e.z.array(e.z.string()).prefault([])}).prefault({}),技能树:e.z.object({可用技能点:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(4),已用技能点:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),已解锁:e.z.record(e.z.string().describe('节点ID'),e.z.boolean()).prefault({}),自定义:e.z.string().prefault('')}).prefault({}),权柄:e.z.object({权柄名称:e.z.string().prefault(''),权柄途径:e.z.enum(['生命','历史','群星','黎明','黑夜','力量','希望','勇气','梦想']).prefault('生命'),碎片数:e.z.coerce.number().transform(t=>_.clamp(t,0,99999)).prefault(0),赋予技能:e.z.string().prefault(''),审核通过:e.z.boolean().prefault(!1),审核备注:e.z.string().prefault('')}).prefault({}),背景:e.z.object({原文:e.z.string().prefault(''),摘要:e.z.string().prefault('')}).prefault({}),战术:e.z.object({战斗模式:e.z.enum(['非战斗','空战','地面战']).prefault('非战斗'),是否战斗中:e.z.boolean().prefault(!1),当前阵线:e.z.enum(['后卫','中线','前线','交锋区']).prefault('中线'),制空权:e.z.enum(['我方','敌方','争夺中']).prefault('争夺中'),当前轮次:e.z.coerce.number().transform(t=>_.clamp(t,1,999)).prefault(1),重型移动计数:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),火力惩罚:e.z.string().prefault('无'),词条区:e.z.record(e.z.string().describe('单位名'),e.z.array(e.z.string()).prefault([])).prefault({}),空战:e.z.object({菜单开启:e.z.boolean().prefault(!1),流程阶段:e.z.enum(['遭遇','行动点计算','站位划分','制空判定','行动序列','回合执行','空战结算']).prefault('遭遇'),天气:e.z.enum(['万里无云','天气晴朗','阴雨连绵','雷暴雨天','台风天']).prefault('天气晴朗'),天气判定值:e.z.coerce.number().transform(t=>_.clamp(t,1,100)).prefault(11),天气命中修正:e.z.coerce.number().transform(t=>_.clamp(t,-50,50)).prefault(5),天气探测修正:e.z.coerce.number().transform(t=>_.clamp(t,-100,100)).prefault(0),天气移速倍率:e.z.coerce.number().transform(t=>_.clamp(t,.1,3)).prefault(1),空域层:e.z.enum(['湍流层','云层','高空','标准空域','低空','地面']).prefault('标准空域'),格距米:e.z.coerce.number().transform(t=>_.clamp(t,100,2e3)).prefault(500),我方单位:e.z.object({侦察型:e.z.coerce.number().transform(t=>_.clamp(t,0,99)).prefault(0),轻型:e.z.coerce.number().transform(t=>_.clamp(t,0,99)).prefault(0),中型:e.z.coerce.number().transform(t=>_.clamp(t,0,99)).prefault(0),重型:e.z.coerce.number().transform(t=>_.clamp(t,0,99)).prefault(0),要塞型:e.z.coerce.number().transform(t=>_.clamp(t,0,99)).prefault(0),其他:e.z.coerce.number().transform(t=>_.clamp(t,0,99)).prefault(0)}).prefault({}),敌方单位:e.z.object({侦察型:e.z.coerce.number().transform(t=>_.clamp(t,0,99)).prefault(0),轻型:e.z.coerce.number().transform(t=>_.clamp(t,0,99)).prefault(0),中型:e.z.coerce.number().transform(t=>_.clamp(t,0,99)).prefault(0),重型:e.z.coerce.number().transform(t=>_.clamp(t,0,99)).prefault(0),要塞型:e.z.coerce.number().transform(t=>_.clamp(t,0,99)).prefault(0),其他:e.z.coerce.number().transform(t=>_.clamp(t,0,99)).prefault(0)}).prefault({}),我方制空点:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),敌方制空点:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),制空修正:e.z.coerce.number().transform(t=>_.clamp(t,-1,1)).prefault(0),重武器命中条件:e.z.string().prefault('无'),触发突袭轮:e.z.boolean().prefault(!1),突袭来源:e.z.string().prefault('无'),当前行动序列:e.z.array(e.z.string()).prefault([]),台风眼格:e.z.array(e.z.string()).prefault([]),侦查单位类型:e.z.enum(['侦察型','轻型','中型','重型及以上']).prefault('侦察型'),侦查目标类型:e.z.enum(['侦察型','轻型','中型','重型','要塞']).prefault('轻型'),侦查结果:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),目标隐匿剩余:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),我方闪避值:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(3),敌方闪避值:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(3),我方近失叠加命中:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),敌方近失叠加命中:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),最近命中详情:e.z.string().prefault(''),我方总耐久:e.z.coerce.number().transform(t=>_.clamp(t,0,99999)).prefault(100),敌方总耐久:e.z.coerce.number().transform(t=>_.clamp(t,0,99999)).prefault(100),已结算回合:e.z.coerce.number().transform(t=>_.clamp(t,0,9999)).prefault(0),最近结算摘要:e.z.string().prefault('')}).prefault({})}).prefault({}),装备:e.z.object({灵装:e.z.string().prefault('联合标准轻型灵装'),武器:e.z.record(e.z.string().describe('武器名'),e.z.object({等级:e.z.coerce.number().transform(t=>_.clamp(t,0,8)).prefault(1),射程:e.z.coerce.number().transform(t=>_.clamp(t,0,8)).prefault(2),描述:e.z.string().prefault('制式武器')}).prefault({})).prefault({}),防具:e.z.record(e.z.string().describe('防具部位'),e.z.string()).prefault({}),特殊配件:e.z.record(e.z.string().describe('配件名'),e.z.string().describe('效果描述')).prefault({})}).prefault({}),异常状态:e.z.record(e.z.string().describe('状态名'),e.z.object({等级:e.z.enum(['严重','致命','快速致命']).prefault('严重'),效果:e.z.string().prefault('暂无效果描述'),剩余轮次:e.z.coerce.number().transform(t=>_.clamp(t,0,99)).prefault(1)}).prefault({})).prefault({}),技能检定:e.z.object({最近动作:e.z.string().prefault('无'),关联属性:e.z.enum(['力量','敏捷','体质','感知','意志','魅力','学识','无']).prefault('无'),原始骰点:e.z.coerce.number().transform(t=>_.clamp(t,1,10)).prefault(1),属性加值:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),难度减值:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),难度说明:e.z.string().prefault('常规难度'),总值:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),结果:e.z.enum(['大成功','成功','失败','大失败']).prefault('失败'),结果描述:e.z.string().prefault('暂无检定'),封锁行为:e.z.string().prefault(''),封锁至轮次:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),更新时间:e.z.coerce.number().prefault(0)}).prefault({})}).prefault({}),战利品:e.z.object({显示战利品:e.z.boolean().prefault(!1),当前容器:e.z.record(e.z.string().describe('容器名'),e.z.object({类型:e.z.enum(['普通','高级']).prefault('普通'),已开启:e.z.boolean().prefault(!1)}).prefault({})).prefault({}),最近获取:e.z.record(e.z.string().describe('物品名'),e.z.object({品质:e.z.enum(['通用','良好','优秀','机密','实验','收藏']).prefault('通用'),数量:e.z.coerce.number().transform(t=>_.clamp(t,1,999)).prefault(1),价值:e.z.coerce.number().transform(t=>_.clamp(t,1,999999999)).prefault(1)}).prefault({})).prefault({}),副本:e.z.object({已激活:e.z.boolean().prefault(!1),副本名称:e.z.string().prefault(''),实验室等级:e.z.enum(['基础实验室','被封锁的实验室','被封锁的机密实验室','被封锁的顶点实验室']).prefault('基础实验室'),地图规模:e.z.enum(['小型','中型','大型']).prefault('小型'),房间总数:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),当前房间索引:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),已探索房间:e.z.coerce.number().transform(t=>_.clamp(t,0,999)).prefault(0),最近房间:e.z.string().prefault(''),最近结算:e.z.string().prefault(''),房间列表:e.z.array(e.z.object({序号:e.z.coerce.number().transform(t=>_.clamp(t,1,999)).prefault(1),房间名:e.z.string().prefault(''),房间类型:e.z.enum(['一般','不错','危险','隐藏']).prefault('一般'),容器:e.z.object({普通:e.z.coerce.number().transform(t=>_.clamp(t,0,9)).prefault(0),高级:e.z.coerce.number().transform(t=>_.clamp(t,0,9)).prefault(0),上锁:e.z.boolean().prefault(!1),已搜索:e.z.boolean().prefault(!1)}).prefault({})}).prefault({})).prefault([])}).prefault({}),仓库:e.z.object({联合币:e.z.coerce.number().transform(t=>_.clamp(t,0,99999999)).prefault(0),芯片:e.z.coerce.number().transform(t=>_.clamp(t,0,999999)).prefault(0),物品:e.z.record(e.z.string().describe('物品名'),e.z.object({品质:e.z.enum(['通用','良好','优秀','机密','实验','收藏']).prefault('通用'),数量:e.z.coerce.number().transform(t=>_.clamp(t,0,999999)).prefault(0),价值:e.z.coerce.number().transform(t=>_.clamp(t,1,999999999)).prefault(1),分类:e.z.string().prefault('杂项'),描述:e.z.string().prefault(''),词条:e.z.array(e.z.string()).prefault([]),可交易:e.z.boolean().prefault(!0)}).prefault({})).prefault({}),独特收藏品:e.z.array(e.z.string()).prefault([])}).prefault({})}).prefault({}),战场日志:e.z.record(e.z.string().describe('日志标题'),e.z.string().describe('日志内容')).prefault({})}).prefault({});function a(t,e=0){const r=Number(t);return Number.isFinite(r)?r:e}function n(){return Math.floor(6*Math.random())+1}const s=[{name:'新手',need:10},{name:'入门',need:50},{name:'标准',need:100},{name:'熟练',need:500},{name:'专业',need:1e3},{name:'精锐',need:2e3},{name:'传奇',need:6e3}];function o(t){if(!t||'object'!=typeof t)return;const e=String(_.get(t,'界面.建卡.职业','')),r='战姬'===e||String(_.get(t,'主角.档案.身份路径','')).includes('战姬'),n='权柄使役者'===e||String(_.get(t,'主角.档案.身份路径','')).includes('权柄');if(r){let e=_.clamp(a(_.get(t,'主角.成长.战姬老练等级',1),1),1,s.length),r=Math.max(0,a(_.get(t,'主角.成长.魔力碎片',0),0));for(;e<s.length;){const t=s[e-1].need;if(r<t)break;r-=t,e+=1}_.set(t,'主角.成长.战姬老练等级',e),_.set(t,'主角.成长.魔力碎片',r),_.set(t,'主角.成长.下一级所需魔力碎片',e<s.length?s[e-1].need:0)}if(n){const e=Math.max(0,a(_.get(t,'主角.成长.权柄碎片',0),0)),r=Boolean(_.get(t,'主角.成长.权柄本源',!1));let n=1;e>=50&&(n=2),e>=100&&(n=3),e>=1e3&&r&&(n=4),_.set(t,'主角.成长.权柄使役者等级',n)}}function c(t,e=3){if(!t||'object'!=typeof t)return;const r=_.get(t,'战场日志',{});if(!_.isObjectLike(r))return void _.set(t,'战场日志',{});const a=Object.entries(r);a.length<=e||_.set(t,'战场日志',Object.fromEntries(a.slice(-e)))}function i(t){if(t&&'object'==typeof t)if(_.isObjectLike(_.get(t,'界面.空战反馈'))||_.set(t,'界面.空战反馈',{待反馈:!1,摘要:'',时间戳:0}),_.isObjectLike(_.get(t,'主角.战术.词条区'))||_.set(t,'主角.战术.词条区',{}),_.isObjectLike(_.get(t,'主角.战术.空战'))){const e=_.get(t,'主角.战术.空战');_.defaultsDeep(e,{菜单开启:!1,流程阶段:'遭遇',天气:'天气晴朗',天气判定值:11,天气命中修正:5,天气探测修正:0,天气移速倍率:1,空域层:'标准空域',格距米:500,我方单位:{侦察型:0,轻型:0,中型:0,重型:0,要塞型:0,其他:0},敌方单位:{侦察型:0,轻型:0,中型:0,重型:0,要塞型:0,其他:0},我方制空点:0,敌方制空点:0,制空修正:0,重武器命中条件:'无',触发突袭轮:!1,突袭来源:'无',当前行动序列:[],台风眼格:[],侦查单位类型:'侦察型',侦查目标类型:'轻型',侦查结果:0,目标隐匿剩余:0,我方闪避值:3,敌方闪避值:3,我方近失叠加命中:0,敌方近失叠加命中:0,最近命中详情:'',我方总耐久:100,敌方总耐久:100,已结算回合:0,最近结算摘要:''})}else _.set(t,'主角.战术.空战',{菜单开启:!1,流程阶段:'遭遇',天气:'天气晴朗',天气判定值:11,天气命中修正:5,天气探测修正:0,天气移速倍率:1,空域层:'标准空域',格距米:500,我方单位:{侦察型:0,轻型:0,中型:0,重型:0,要塞型:0,其他:0},敌方单位:{侦察型:0,轻型:0,中型:0,重型:0,要塞型:0,其他:0},我方制空点:0,敌方制空点:0,制空修正:0,重武器命中条件:'无',触发突袭轮:!1,突袭来源:'无',当前行动序列:[],台风眼格:[],侦查单位类型:'侦察型',侦查目标类型:'轻型',侦查结果:0,目标隐匿剩余:0,我方闪避值:3,敌方闪避值:3,我方近失叠加命中:0,敌方近失叠加命中:0,最近命中详情:'',我方总耐久:100,敌方总耐久:100,已结算回合:0,最近结算摘要:''})}const u=/空战|超视距空战|偷袭|灵装化后攻击|异种进攻|敌袭|遭遇战|进入战斗/i,l=/攻击|射击|开火|突击|轰炸|压制|反击|偷袭|超视距空战|异种进攻|近战/i,f=/战斗结束|结束空战|脱离接触|脱战|全歼|击退|撤退|撤离/i,p=/异种|敌人|敌军|敌对|领主|巢穴|袭击|警报|交火|接敌|战场/i,g=/开始战斗|进入战斗|遭遇战|交战状态|空战开始|地面战开始|异种进攻|敌袭/i;function m(t){const e=String(t??'');return!!e.trim()&&(!!g.test(e)||(!(!u.test(e)||!p.test(e))||!(!/(开火|射击|突击|压制|反击|轰炸|近战)/i.test(e)||!p.test(e))))}function d(t,e){if(i(t),!m(e))return!1;if(Boolean(_.get(t,'主角.战术.是否战斗中',!1)))return!0;_.set(t,'主角.战术.战斗模式','空战'),_.set(t,'主角.战术.是否战斗中',!0),_.set(t,'主角.战术.空战.菜单开启',!0),_.set(t,'主角.战术.空战.流程阶段','遭遇'),_.set(t,'主角.战术.空战.已结算回合',0);const r=String(_.get(t,'世界.战区威胁等级','中')),n='极危'===r?180:'高'===r?140:'中'===r?110:90;_.set(t,'主角.战术.空战.我方总耐久',a(_.get(t,'主角.资源.当前生命',100),100)),_.set(t,'主角.战术.空战.敌方总耐久',Math.max(30,a(_.get(t,'主角.战术.空战.敌方总耐久',n),n)));const s=/超视距空战/i.test(e)?'超视距空战突袭':/偷袭/i.test(e)?'偷袭得手':/异种进攻/i.test(e)?'异种进攻遭遇':'常规遭遇',o=/超视距空战|偷袭/i.test(e);return _.set(t,'主角.战术.空战.触发突袭轮',o),_.set(t,'主角.战术.空战.突袭来源',o?s:'无'),o&&_.set(t,'主角.资源.行动点',a(_.get(t,'主角.资源.行动点',1),1)+1),_.set(t,`战场日志.空战开始-${Date.now()}`,`空战激活词命中：${s}`),c(t,3),!0}function b(t,e){if(i(t),'空战'!==_.get(t,'主角.战术.战斗模式','非战斗'))return!1;if(!_.get(t,'主角.战术.是否战斗中',!1))return!1;if(!l.test(e)&&!f.test(e))return!1;const r=_.get(t,'主角.战术.空战');let s=a(_.get(r,'我方总耐久',_.get(t,'主角.资源.当前生命',100)),100),o=a(_.get(r,'敌方总耐久',100),100);const u=_.clamp(Math.trunc(a(_.get(r,'天气命中修正',0),0)/10),-2,2),p=_.clamp(a(_.get(r,'制空修正',0),0),-1,1),g=function(t){const e=_.get(t,'主角.装备.武器',{});if(!_.isObjectLike(e))return 1;const r=Object.values(e)[0];return Math.max(1,a(_.get(r,'等级',1),1))}(t),m=String(_.get(r,'重武器命中条件','')),d=/需侦察|需.*辅助/.test(m),b=a(_.get(r,'我方单位.侦察型',0),0)>0||a(_.get(r,'我方单位.轻型',0),0)>0,h=a(_.get(r,'我方近失叠加命中',0),0),S=a(_.get(r,'敌方近失叠加命中',0),0),y=a(_.get(r,'敌方闪避值',3),3),M=a(_.get(r,'我方闪避值',3),3),j=/全自动|连续射击|连发/.test(e),v=(t,e,r=1)=>{const a=n()+t-e,s=Math.max(1,(n()+g)*r);return a>6?{diff:a,damage:s+g*pt(),note:'致命攻击',near_miss:!1,invalid:!1}:a>4?{diff:a,damage:s,note:'命中',near_miss:!1,invalid:!1}:a>2?{diff:a,damage:Math.max(1,Math.floor(s/2)),note:'基本命中',near_miss:!1,invalid:!1}:a>1?{diff:a,damage:Math.max(1,g*_.random(1,2)),note:'擦弹',near_miss:!1,invalid:!1}:1===a||0===a?{diff:a,damage:0,note:'近失弹',near_miss:!0,invalid:!1}:{diff:a,damage:0,note:'无效攻击',near_miss:!1,invalid:!0}};let w=0,D=0,O='';if(d&&!b)O='重武器缺乏侦察/轻型辅助，命中无效';else{const t=u+p+h,e=v(t,y);if(D=e.diff,w+=e.damage,O=e.note,_.set(r,'我方近失叠加命中',e.near_miss?h+10:0),j){let e=1,n=t-10;for(;e<6&&n+6>=y;){const t=v(n,y);w+=t.damage,O+=` / 连射${e+1}:${t.note}`,t.near_miss&&_.set(r,'我方近失叠加命中',a(_.get(r,'我方近失叠加命中',0),0)+10),t.invalid||(D=t.diff),e+=1,n-=10}}}o=Math.max(0,o-w);const k=v(Math.max(0,-p)+S,M),C=k.diff,N=k.damage;_.set(r,'敌方近失叠加命中',k.near_miss?S+10:0),s=Math.max(0,s-N),_.set(t,'主角.资源.当前生命',s),_.set(r,'我方总耐久',s),_.set(r,'敌方总耐久',o),_.set(r,'已结算回合',a(_.get(r,'已结算回合',0),0)+1);const P=`回合${_.get(r,'已结算回合',0)}：我方${O}(差值${D})造成${w}；敌方${k.note}(差值${C})造成${N}`;_.set(r,'最近命中详情',P),_.set(r,'最近结算摘要',P),_.set(t,`战场日志.空战回合-${Date.now()}`,P),c(t,3);if(!f.test(e)&&!(s<=0||o<=0))return!0;_.set(t,'主角.战术.是否战斗中',!1),_.set(t,'主角.战术.战斗模式','非战斗'),_.set(r,'流程阶段','空战结算');const A=function(t,e){const r=_.get(t,'主角.战术.空战',{}),n=Object.entries(_.get(t,'战场日志',{})).slice(-3).map(([t,e])=>`${t}:${e}`).join('；');return`空战结算(${e})：回合${a(r.已结算回合,0)}，天气=${r.天气}(命中修正${a(r.天气命中修正,0)})，制空权=${_.get(t,'主角.战术.制空权','争夺中')}，我方耐久=${a(r.我方总耐久,0)}，敌方耐久=${a(r.敌方总耐久,0)}，最近日志=${n}。请严格按此结果叙事。`}(t,s<=0?'我方崩溃':o<=0?'敌方被歼灭':'战术脱离');return _.set(t,'界面.空战反馈',{待反馈:!0,摘要:A,时间戳:Date.now()}),_.set(t,'世界.近期事务.空战结算',A),_.set(t,`战场日志.空战结束-${Date.now()}`,A),c(t,3),!0}function h(t){let e=t.replace(/<update(?:variable)?>[\s\S]*?<\/update(?:variable)?>/gim,'').replace(/<update(?:variable)?>[\s\S]*$/gim,'').replace(/<StatusPlaceHolderImpl\/>/gim,'').replace(/<OnStageCharacters>[\s\S]*?<\/OnStageCharacters>/gim,'').replace(/<NpcRelationHints>[\s\S]*?<\/NpcRelationHints>/gim,'').replace(/```[\s\S]*?\$\('body'\)\.load\([\s\S]*?```/gim,'');const r=e.match(/<content>([\s\S]*?)<\/content>/im);return e=r?.[1]?r[1]:e.replace(/<(?:think|thinking|context|disclaimer|tucao|current_event|progress)[^>]*>[\s\S]*?<\/(?:think|thinking|context|disclaimer|tucao|current_event|progress)>/gim,'').replace(/<(?:think|thinking|context|disclaimer|tucao|current_event|progress)[^>]*\/>/gim,''),e=e.replace(/```[\s\S]*?```/gim,'').replace(/<\|im_end\|>/gim,'').replace(/<\/?[^>\n]+>/g,'').replace(/\r/g,'').replace(/\n{3,}/g,'\n\n').trim(),e}const S=new Set(['写卡助手','主角','玩家','你们','我们','他们','她们','众人','新人','新生','学员','守卫','后勤员','教官','校长','学院','战姬','异种','系统','任务','空战','地面战','行政楼','塔楼','林荫道','广场','战场','回复','楼层','变量','日志','世界','主状态栏']),y=/^(对着|朝着|向着|就在|站在|位于|那个|这个|那位|这位|新来的|那个谁)/,M=/(写卡助手|主角|玩家|新生|学员|守卫|后勤员|教官|校长|学院|任务|系统|状态栏|日志|空战|地面战|高空|低空|云层|标准空域|湍流层|交锋区|前线|中线|后卫|三点钟|六点钟)/;function j(t,e){return!!t&&(!e.has(t)&&(!S.has(t)&&(!M.test(t)&&(!y.test(t)&&(!/[0-9０-９一二三四五六七八九十百千万]/.test(t)&&(!/(的|了|着|在|中|上|下)$/.test(t)&&(!!/^[\u4e00-\u9fa5·]{2,6}$/.test(t)&&!/(学院|战姬|异种|系统|任务|队|组|区域|阵线)$/.test(t))))))))}function v(t,e){return t.filter(t=>j(String(t?.姓名??''),e))}function w(t,e){const r=String(t??'').split(/[\n。！？]/).map(t=>t.trim()).filter(Boolean).find(t=>t.includes(e));return r?r.slice(0,48):''}function D(t){const e=String(t??'');return/敌视|厌恶|愤怒|杀意/.test(e)?'敌视':/警惕|戒备|冷淡|防备|审视/.test(e)?'警惕':/友好|善意|微笑|点头|温和/.test(e)?'友好':/亲密|信任|依赖|靠近/.test(e)?'亲近':'中立'}function O(t,e){const r=h(String(t??''));if(!r)return[];const a=new Set(e?.exclude_names??[]),n=new Map((e?.old_onstage??[]).map(t=>[t.姓名,t])),s=new Map,o=(t,e)=>{const r=String(t??'').trim().replace(/^[“"《【[(]+|[”"》】)\]]+$/g,'').replace(/[，。！？；：、,.?!;:]/g,'').trim();j(r,a)&&s.set(r,(s.get(r)??0)+e)};for(const t of r.matchAll(/(?:名叫|叫做|被称为|称作|称为)([\u4e00-\u9fa5·]{2,6})/g))o(t[1],3);for(const t of r.matchAll(/([\u4e00-\u9fa5·]{2,6})(?:说|问|道|看向|看了|望向|转身|停下|点头|皱眉|回应|示意|开口|轻声|沉声|抬手|抬头|侧过头|挑了挑眉|笑了笑|叹了口气)/g))o(t[1],2);for(const t of r.matchAll(/([\u4e00-\u9fa5·]{2,6})[，、]\s*(?:[“"「『]|又|便|就|正|轻|冷|低|抬|看|说|问|道)/g))o(t[1],1.6);for(const t of r.matchAll(/([\u4e00-\u9fa5·]{2,6})/g))o(t[1],.05);for(const t of n.keys())r.includes(t)&&s.set(t,Math.max(s.get(t)??0,2));const c=[];for(const[t,e]of s.entries()){if(e<2.8)continue;const a=n.get(t),s=w(r,t);c.push({姓名:t,好感度:N(a?.好感度??0,0),等级:String(a?.等级??'新手'),态度:a?.态度||D(s),内心想法:a?.内心想法||(s?`从当前楼层推断：${s}`:'从当前楼层推断中。'),基础属性:_.isObjectLike(a?.基础属性)?_.cloneDeep(a?.基础属性):{},更新时间:Date.now()})}return c}function k(t){_.isObjectLike(_.get(t,'界面'))||_.set(t,'界面',{}),Array.isArray(_.get(t,'界面.在场角色'))||_.set(t,'界面.在场角色',[]),_.isObjectLike(_.get(t,'界面.模块折叠'))?_.defaults(_.get(t,'界面.模块折叠'),{在场角色:!1,长期NPC:!1}):_.set(t,'界面.模块折叠',{在场角色:!1,长期NPC:!1}),_.isObjectLike(_.get(t,'世界.长期NPC列表'))||_.set(t,'世界.长期NPC列表',{}),_.isObjectLike(_.get(t,'世界.NPC关系追踪'))||_.set(t,'世界.NPC关系追踪',{}),_.isObjectLike(_.get(t,'战利品'))||_.set(t,'战利品',{}),_.defaultsDeep(_.get(t,'战利品'),{显示战利品:!1,当前容器:{},最近获取:{},副本:{已激活:!1,副本名称:'',实验室等级:'基础实验室',地图规模:'小型',房间总数:0,当前房间索引:0,已探索房间:0,最近房间:'',最近结算:'',房间列表:[]},仓库:{联合币:0,芯片:0,物品:{},独特收藏品:[]}})}function C(t){t&&'object'==typeof t&&(_.get(t,'界面.建卡.已开始',!1)||(_.set(t,'界面.在场角色',[]),_.set(t,'世界.长期NPC列表',{}),_.set(t,'世界.NPC关系追踪',{})))}function N(t,e=0){return _.clamp(a(t,e),-200,1e3)}function P(t,e=!1){return e?'伴侣':t<=-50?'死敌':t<=-20?'危险':t<=0?'警惕':t<=100?'熟悉':t<=400?'朋友':t<=600?'挚友':'亲密'}function A(t,e){const r=String(t??''),a=new Set;for(const t of e)t&&r.includes(t)&&a.add(t);return a}function x(t,e){const r=`世界.NPC关系追踪.${e}`;return _.isObjectLike(_.get(t,r))||_.set(t,r,{连续出现计数:0,最近出现轮次:0,玩家随行请求命中次数:0,最近玩家请求时间:0,是否已转长期:!1}),_.get(t,r)}function L(t,e,r){const a=`世界.长期NPC列表.${e}`,n=_.get(t,a),s=_.isObjectLike(n)?n:{姓名:e,好感度:0,等级:'新手',好感阶段:'警惕',态度:'中立',内心想法:'',基础属性:{},性行为次数:0,贞洁状态:'处女',关系标签:[],首次记录时间:Date.now(),最后更新时间:0},o=N(r?.好感度,s.好感度),c=N(s.好感度,0),i=o>c?Math.min(c+5,o):o,u=Array.isArray(s.关系标签)&&s.关系标签.includes('伴侣'),l={...s,姓名:e,好感度:i,等级:String(r?.等级||s.等级||'新手'),态度:String(r?.态度||s.态度||'中立'),内心想法:String(r?.内心想法||s.内心想法||''),基础属性:{...s.基础属性??{},...r?.基础属性??{}},最后更新时间:Date.now()};return l.好感阶段=P(l.好感度,u),_.set(t,a,l),l}function E(t,e,r){const a=_.get(t,'界面.在场角色',[]).find(t=>t.姓名===e),n=L(t,e,a);x(t,e).是否已转长期=!0,_.set(t,`世界.长期NPC列表.${e}.关系标签`,_.uniq([...n.关系标签??[],r]))}const B=/随行|跟随|主动跟随|任务搭档|结成朋友|更亲密关系/,H=/表白|喜欢|爱/,I=/我也喜欢|接受|愿意|在一起|答应/,q=/发生关系|交合|做爱|上床|亲密行为完成/;function R(t){const e=String(_.get(t,'世界.当前地点','')),r=/大图书馆/.test(e),a=_.get(t,'界面.在场角色',[]),n=_.get(t,'世界.长期NPC列表',{}),s=_.uniq([...a.map(t=>String(t.姓名||'')),...Object.keys(n)]).filter(t=>/薇薇安娜/.test(t));if(0!==s.length)for(const e of s){if(!r){_.remove(a,t=>String(t?.姓名??'')===e);continue}const n=_.get(t,`世界.长期NPC列表.${e}`,{}),s=N(_.get(n,'好感度',0),0);let o='审视中的礼貌',c='她在评估你是否理解“记录真实”与“承担后果”之间的重量。';s>=1&&(o='克制友善',c='她愿意多给你一条线索，但仍保持必要的距离与边界。'),s>=101&&(o='谨慎信任',c='她开始把你视作可合作的记录者，而非短暂访客。'),s>=401&&(o='高位盟友',c='她愿意在关键节点给出判断，但仍避免替你做决定。'),s>=601&&(o='深度信任',c='她允许你触及更深层的历史片段，但要求你承担相应代价。'),('伴侣'===String(_.get(n,'好感阶段',P(s)))||Array.isArray(_.get(n,'关系标签'))&&_.get(n,'关系标签').includes('伴侣'))&&(o='伴侣（成熟克制）',c='她的亲密建立在尊重与分寸上，不依恋、不占有，只在关键时刻并肩。',_.set(t,`世界.长期NPC列表.${e}.好感阶段`,'伴侣')),_.set(t,`世界.长期NPC列表.${e}.态度`,o),_.set(t,`世界.长期NPC列表.${e}.内心想法`,c),_.set(t,`世界.长期NPC列表.${e}.最后更新时间`,Date.now());const i=a.findIndex(t=>String(t?.姓名??'')===e);i>=0&&(a[i].态度=o,a[i].内心想法=`本回合：${c}`,a[i].更新时间=Date.now())}}function T(t,e,r,a){const n=function(t){const e=String(t??'').trim();return e?/作为AI|我无法|系统提示|规则要求|标签|JSON|变量|mvu|statusplaceholder/i.test(e)?'':e.slice(0,120):''}(a);return/维多利伽|victorica/i.test(t)?r?{attitude:'伴侣（成熟克制）',thought:'她把亲密放在“并肩生存”之后，不索取承诺，只用行动守住彼此的退路。'}:e>=601?{attitude:'深度信任',thought:'她愿意把你纳入她的长期计划，但依旧保持对风险与损失的冷静估算。'}:e>=401?{attitude:'可靠同伴',thought:'她把你视作能托付后背的人，交流更直接，也更重视行动结果。'}:e>=101?{attitude:'谨慎友好',thought:'她开始主动共享情报与判断，但仍会先确认你是否准备好承担后果。'}:e>=1?{attitude:'克制合作',thought:'她仍有戒备，却愿意给你一次被验证的机会。'}:{attitude:'警戒疏离',thought:'她先确认撤离路线与掩体，再决定是否回应你的提议。'}:/梅莉|梅莉·冯·塔尔思科/i.test(t)?r?{attitude:'伴侣（成熟克制）',thought:'她将情感表达压进理性与分寸里，优先维护共同目标与边界。'}:e>=601?{attitude:'深度信任',thought:'她会让你参与核心决策，但仍以严谨标准要求每一步推演。'}:e>=401?{attitude:'高信赖协作',thought:'她把你视作可长期协同的对象，愿意共享研究进展与战术判断。'}:e>=101?{attitude:'礼貌亲近',thought:'她的语气更温和，但核心思路依旧是精确、可验证与可执行。'}:e>=1?{attitude:'克制友善',thought:'她愿意交流，但会先观察你是否具备稳定执行力。'}:{attitude:'审慎观望',thought:'她在判断你是短期变量，还是值得纳入长期布局的对象。'}:n?{attitude:'中立',thought:n}:{attitude:'中立',thought:'她在衡量局势与你的选择，尚未给出明确立场。'}}function F(t){const e=_.get(t,'界面.在场角色',[])??[],r=_.get(t,'世界.长期NPC列表',{})??{},a=_.uniq([...e.map(t=>String(t?.姓名??'')),...Object.keys(r)]).filter(Boolean);for(const r of a){const a=`世界.长期NPC列表.${r}`,n=_.get(t,a,{}),s=N(_.get(n,'好感度',0),0),o=_.get(n,'关系标签',[]),c='伴侣'===String(_.get(n,'好感阶段',''))||Array.isArray(o)&&o.includes('伴侣'),i=String(_.get(n,'内心想法','')||e.find(t=>t.姓名===r)?.内心想法||''),u=T(r,s,c,i);_.has(t,a)&&(_.set(t,`${a}.态度`,u.attitude),_.set(t,`${a}.内心想法`,u.thought),_.set(t,`${a}.最后更新时间`,Date.now()),c&&_.set(t,`${a}.好感阶段`,'伴侣'));const l=e.findIndex(t=>String(t?.姓名??'')===r);l>=0&&(e[l].态度=u.attitude,e[l].内心想法=`本回合：${u.thought}`,e[l].更新时间=Date.now())}}const G=/进入副本|进入希尔顿实验室|开始副本|副本探索|下副本|进入实验室/i,J=/离开副本|副本结束|撤离副本|通关副本|退出实验室/i,Y=/前往|推进|移动到|去往|转移到|深入|进入房间/i,U=/搜索|搜刮|开箱|打开容器|翻找|调查容器|检查容器/i,V=/爆破|炸开|大当量|强行炸门|炸门/i,K={一般:['保安室','食堂','破损的生物实验室','职员办公室','职员宿舍','工作间','车间','车库'],不错:['培养皿房间','初级武器实验室','图书馆','生物实验室','研究员办公室','破损的物理实验室','休息区','地库','化学实验室'],危险:['危险房间','测试场地','破损的通风区','泄露的生物实验室','工业设施','颠倒的物理实验室','破损的房间'],隐藏:['高级武器实验室','总裁办公室','总裁休息间','保险仓库','物理实验室','不死鸟武器储藏点']},Q={通用:[1,1e3],良好:[1001,5e3],优秀:[5001,2e4],机密:[20001,5e4],实验:[50001,2e5],收藏:[200001,2e7]},W={通用:0,良好:1,优秀:2,机密:3,实验:4,收藏:5},X=['高精度','抗污染','快拆','穿甲','高频','稳定供能','灵装共鸣','自动校准','扩容弹仓','轻量化'],Z=['金手表','金色钢笔','盛宴雕塑','古董银杯','鎏金怀表'],tt=/黑市.*(出售|卖出|卖掉|抛售|卖)/i,et=/黑市.*(购买|买入|买下|买)/i;function rt(t){const e=Math.max(0,Math.floor(t/20)),r=2+e,a=Math.max(1,4-e);let n=2;e>=2&&(n=Math.max(1,n-Math.floor(e/2)));const s=1+r+a+n+1,o=Math.random()*s;return o<1?'隐藏':o<1+r?'不错':o<1+r+a?'一般':'危险'}function at(t){if('隐藏'===t)return{普通:0,高级:4,上锁:!1,已搜索:!1};if('不错'===t){return Math.random()<.35?{普通:0,高级:_.random(2,5),上锁:!0,已搜索:!1}:{普通:1,高级:1,上锁:!1,已搜索:!1}}if('一般'===t)return{普通:2,高级:0,上锁:!1,已搜索:!1};return{普通:Math.random()<.7?1:0,高级:0,上锁:!1,已搜索:!1}}function nt(t,e){const r=_.random(1,100);return'被封锁的顶点实验室'===t?r>=96?'收藏':r>=75?'实验':r>=45?'机密':r>=20?'优秀':e?'良好':'通用':'被封锁的机密实验室'===t?r>=97?'收藏':r>=82?'实验':r>=55?'机密':r>=25?'优秀':e?'良好':'通用':'被封锁的实验室'===t?r>=95?'实验':r>=75?'机密':r>=45?'优秀':r>=20?'良好':'通用':r>=98?'实验':r>=85?'机密':r>=60?'优秀':r>=30?'良好':'通用'}function st(t,e,r,n,s,o,c,i,u=!0){if('联合币'===e)return void _.set(t,'战利品.仓库.联合币',a(_.get(t,'战利品.仓库.联合币',0),0)+n);if('芯片'===e)return void _.set(t,'战利品.仓库.芯片',a(_.get(t,'战利品.仓库.芯片',0),0)+n);const l=`战利品.仓库.物品.${e}`,f=a(_.get(t,`${l}.数量`,0),0),p=_.get(t,`${l}.词条`,[]);if(_.set(t,l,{品质:r,数量:f+n,价值:c,分类:s,描述:o,词条:_.uniq([...Array.isArray(p)?p:[],...i]),可交易:u}),/收藏|机密|实验/.test(r)){const r=_.get(t,'战利品.仓库.独特收藏品',[]);_.set(t,'战利品.仓库.独特收藏品',_.uniq([...Array.isArray(r)?r:[],e]))}}function ot(t,e,r,n){const s=n??('高级'===r?3:2),o={},c={武器:['制式步枪','战术手枪','高频匕首','实验型枪机','灵装增幅器'],资源:['联合币','芯片','魔力碎片','修复套件'],收藏:['古董怀表','残损铭牌','星辉玻片','封蜡档案'],医疗:['急救针剂','应急医疗箱','生物稳定剂']};for(let n=0;n<s;n+=1){const n=nt(e,'高级'===r),s='通用'===n||'良好'===n?_.sample(['资源','医疗','武器'])??'资源':_.sample(['武器','收藏','资源'])??'武器',i='收藏'===s&&Math.random()<.45,u=(()=>i?_.sample(Z)??'金手表':'收藏'===n?Math.random()<.25?'不死鸟实验原型':'机密馆藏':'实验'===n?'顶点实验模块':'机密'===n?'机密数据芯片':_.sample(c[s])??'联合币')(),l='联合币'===u?_.random(40,280):'芯片'===u?_.random(1,4):1,[f,p]=Q[n],g=_.random(f,p),m=i?[]:_.sampleSize(X,W[n]);o[u]={品质:n,数量:a(_.get(o,`${u}.数量`,0),0)+l,价值:g},st(t,u,n,l,s,`${r}容器掉落`,g,m,!0)}return o}function ct(t,e){for(const[r,n]of Object.entries(e)){const e=a(_.get(t,`${r}.数量`,0),0);t[r]={品质:String(n?.品质??_.get(t,`${r}.品质`,'通用')),数量:e+a(n?.数量,0),价值:a(n?.价值,a(_.get(t,`${r}.价值`,1),1))}}}function it(t,e){k(t);const r=function(t){return/顶点实验室/.test(t)?'被封锁的顶点实验室':/机密实验室/.test(t)?'被封锁的机密实验室':/被封锁的实验室/.test(t)?'被封锁的实验室':'基础实验室'}(e),n=function(t,e){return/大型/.test(t)?'大型':/中型/.test(t)?'中型':/小型/.test(t)?'小型':'被封锁的顶点实验室'===e||'被封锁的机密实验室'===e?'大型':'被封锁的实验室'===e?'中型':'小型'}(e,r),s=20*a(_.get(t,'主角.人类属性.感知',1),1);if(G.test(e)){const e=function(t,e){const r='小型'===t?5:'中型'===t?12:20,a=[];for(let t=1;t<=r;t+=1){const r=rt(e),n=_.sample(K[r])??('一般'===r?'工作间':'未知房间');a.push({序号:t,房间名:n,房间类型:r,容器:at(r)})}return a}(n,s);return _.set(t,'战利品.副本',{已激活:!0,副本名称:'希尔顿实验室',实验室等级:r,地图规模:n,房间总数:e.length,当前房间索引:0,已探索房间:1,最近房间:e[0]?.房间名??'',最近结算:`副本生成完成：${r}/${n}/${e.length}房`,房间列表:e}),_.set(t,'战利品.显示战利品',!0),void _.set(t,'世界.近期事务.副本',`已进入希尔顿实验室（${r}，${n}）`)}if(!_.get(t,'战利品.副本.已激活',!1))return;const o=_.get(t,'战利品.副本.房间列表',[]);if(!Array.isArray(o)||0===o.length)return;let i=_.clamp(a(_.get(t,'战利品.副本.当前房间索引',0),0),0,o.length-1);if(Y.test(e)&&(i=Math.min(o.length-1,i+1),_.set(t,'战利品.副本.当前房间索引',i),_.set(t,'战利品.副本.已探索房间',Math.max(a(_.get(t,'战利品.副本.已探索房间',1),1),i+1)),_.set(t,'战利品.副本.最近房间',String(o[i]?.房间名??'未知'))),U.test(e)){const n=o[i];if(n?.容器?.已搜索)_.set(t,'战利品.最近获取',{}),_.set(t,'战利品.副本.最近结算',`房间${i+1}已搜索过，本次无新增战利品`),_.set(t,'战利品.显示战利品',!0);else{const s={},o=V.test(e)&&Boolean(n?.容器?.上锁),u=o?1:void 0,l=a(n?.容器?.普通,0),f=a(n?.容器?.高级,0);for(let e=0;e<l;e+=1){ct(s,ot(t,_.get(t,'战利品.副本.实验室等级',r),'普通',u))}for(let e=0;e<f;e+=1){ct(s,ot(t,_.get(t,'战利品.副本.实验室等级',r),'高级',u))}_.set(n,'容器.已搜索',!0),_.set(t,'战利品.最近获取',s),_.set(t,'战利品.显示战利品',!0),_.set(t,'战利品.副本.最近结算',o?'上锁门爆破，容器内容缩水为1槽/容器':`房间${i+1}完成搜索`),_.set(t,`战场日志.战利品-${Date.now()}`,`副本房间${i+1}:${n?.房间名??'未知'} 已结算战利品`),c(t,3)}}J.test(e)&&(_.set(t,'战利品.副本.已激活',!1),_.set(t,'世界.近期事务.副本','已撤离希尔顿实验室'))}function ut(t,e){if(!/黑市|学院南侧/.test(e))return;/进入黑市|前往黑市|到黑市|学院南侧黑市/.test(e)&&(_.set(t,'世界.当前地点','威曼普学院南侧黑市'),_.set(t,'世界.近期事务.黑市','已进入学院南侧黑市（仅联合币储蓄卡交易）'));const r=_.get(t,'战利品.仓库.物品',{}),n=Object.keys(r);if(tt.test(e)){const r=[...A(e,n)];for(const n of r){const r=e.match(new RegExp(`${_.escapeRegExp(n)}\\D*(\\d+)`,'i')),s=Math.max(1,a(r?.[1],1)),o=a(_.get(t,`战利品.仓库.物品.${n}.数量`,0),0);if(o<=0)continue;const c=Math.min(o,s),i=a(_.get(t,`战利品.仓库.物品.${n}.价值`,1),1);if(!Boolean(_.get(t,`战利品.仓库.物品.${n}.可交易`,!0)))continue;const u=Math.floor(i*c*.1);_.set(t,'战利品.仓库.联合币',a(_.get(t,'战利品.仓库.联合币',0),0)+u);const l=o-c;l<=0?_.unset(t,`战利品.仓库.物品.${n}`):_.set(t,`战利品.仓库.物品.${n}.数量`,l),_.set(t,'战利品.副本.最近结算',`黑市售出 ${n} x${c}，入账${u}联合币（折价90%）`)}}if(et.test(e)){const r=['收藏','实验','机密','优秀','良好','通用'].find(t=>e.includes(t))??'良好',[n,s]=Q[r],o=_.random(n,s),c=a(_.get(t,'战利品.仓库.联合币',0),0);if(c>=o){_.set(t,'战利品.仓库.联合币',c-o);const e=`${r}黑市货-${Date.now().toString().slice(-4)}`;st(t,e,r,1,'黑市','黑市购入',o,_.sampleSize(X,W[r]),!0),_.set(t,'战利品.副本.最近结算',`黑市购入 ${e}（${r}） 花费${o}联合币`)}else _.set(t,'战利品.副本.最近结算',`黑市购入失败：联合币不足（需${o}，现有${c}）`)}}function _t(t,e){if(!t||'object'!=typeof t)return;if(!('战姬'===_.get(t,'界面.建卡.职业','')||String(_.get(t,'主角.档案.身份路径','')).includes('战姬')))return _.set(t,'主角.灵装化.启用',!1),void _.set(t,'战利品.显示战利品',!1);const r=a(_.get(t,'主角.战术.当前轮次',0),0),n=String(_.get(t,'主角.战术.当前阵线','')),s=String(_.get(t,'世界.战区威胁等级','')),o=Boolean(_.get(t,'主角.灵装化.手动切换',!1)),c=r>1||'前线'===n||'交锋区'===n||'高'===s||'极危'===s,i=/战斗|交战|接敌|开火|敌袭|突击|火力压制|回合|战场|异种来袭|进入战区/i.test(e),u=c||i,l=Boolean(_.get(t,'主角.灵装化.启用',!1)),f=o||u;_.set(t,'主角.灵装化.启用',f);let p=a(_.get(t,'主角.灵装化.上次结算轮次',0),0);if(!l&&f&&(p=r,_.set(t,'主角.灵装化.上次结算轮次',r)),f){const e=Math.max(0,r-p);if(e>0){const n=a(_.get(t,'主角.灵装化.每回合耗魔',0),0)*e,s=a(_.get(t,'主角.灵装化.每回合耗槽',0),0)*e,o=a(_.get(t,'主角.资源.当前魔力',0),0),c=a(_.get(t,'主角.资源.灵装槽当前',0),0),i=Math.max(0,o-n),u=Math.max(0,c-s);_.set(t,'主角.资源.当前魔力',i),_.set(t,'主角.资源.灵装槽当前',u),_.set(t,'主角.灵装化.上次结算轮次',r),(i<=0||u<=0)&&(_.set(t,'主角.灵装化.启用',!1),_.set(t,'主角.灵装化.手动切换',!1))}}else p>r&&_.set(t,'主角.灵装化.上次结算轮次',r)}function lt(t,e){if(!t||'object'!=typeof t)return;i(t);const r=/地面战|巷战|室内战|近身战|步战|地表交战/i.test(e)?'地面战':/空战|制空|空域|空中交战|空袭/i.test(e)?'空战':'非战斗',n=a(_.get(t,'主角.战术.当前轮次',1),1),s=String(_.get(t,'世界.战区威胁等级','')),o=String(_.get(t,'主角.战术.当前阵线','中线')),c=n>1||'前线'===o||'交锋区'===o||'高'===s||'极危'===s,u=m(e),l=c||u,f=l?'非战斗'===r?'空战':r:'非战斗';if(_.set(t,'主角.战术.战斗模式',f),_.set(t,'主角.战术.是否战斗中',l),!l)return _.set(t,'主角.资源.行动点',1),_.set(t,'主角.资源.移动点',1),void _.set(t,'主角.战术.火力惩罚','无');const p=_.get(t,'界面.建卡.职业',''),g=function(t){return String(_.get(t,'界面.建卡.战姬类型','').trim()||_.get(t,'主角.档案.身份路径','').replace('战姬-','').trim())}(t),d='指挥官'===p,b='权柄使役者'===p;let h=1,S=1,y='无';if('地面战'===f){const e=a(_.get(t,'主角.人类属性.敏捷',1),1);h=Math.max(1,Math.floor(e/3)),S='要塞型'===g?0:1}else if(d)h=1,S=1,'后卫'!==o&&_.set(t,'主角.战术.当前阵线','后卫');else if(b)h=1,S=1;else if('侦察型'===g)h=1,S=2;else if('轻型'===g)h=2,S=1;else if('中型'===g)h=1,S=1;else if('重型'===g){h=1;const e=a(_.get(t,'主角.战术.重型移动计数',0),0)+1;_.set(t,'主角.战术.重型移动计数',e%2),S=e%2==0?1:0,'前线'===o&&(y='重型前线火力惩罚：伤害骰-1/3'),'交锋区'===o&&(y='重型交锋区火力惩罚：伤害骰-1/2')}else'要塞型'===g?(h=1,S=0,'中线'===o&&(y='要塞中线火力惩罚：伤害骰-1/2'),'前线'!==o&&'交锋区'!==o||(y='要塞前线/交锋区仅可使用自卫灵装')):'地面支援姬'===g&&(h=1,S=1);if(_.set(t,'主角.资源.行动点',h),_.set(t,'主角.资源.移动点',S),'空战'===f){const e=a(_.get(t,'主角.战术.空战.天气命中修正',0),0),r=a(_.get(t,'主角.战术.空战.制空修正',0),0),n=`空战命中修正: 天气${e>=0?'+':''}${e} / 制空${r>=0?'+':''}${r} | 重武器条件:${String(_.get(t,'主角.战术.空战.重武器命中条件','无'))}`;y='无'===y?n:`${y}；${n}`,Boolean(_.get(t,'主角.灵装化.启用',!1))||d||b||(y=`${y}；警告: 非灵装化空战，伤亡风险极高`)}_.set(t,'主角.战术.火力惩罚',y)}function ft(t,e){if(!t||'object'!=typeof t)return;const r={力量:/力量|负重|搬运|举起|挥击|拳击|体能|肌力/i,敏捷:/敏捷|闪避|躲避|疾跑|冲刺|翻滚|机动/i,体质:/体质|耐力|抗打|恢复|硬抗|承伤|受伤后坚持/i,感知:/感知|观察|侦察|洞察|听觉|视野|发现|感应/i,意志:/意志|精神|专注|抗压|毅力|抗干扰|冷静/i,魅力:/魅力|交涉|说服|领导|社交|鼓舞|谈判/i,学识:/学识|知识|研究|分析|学习|推理|理论|解读/i};['力量','敏捷','体质','感知','意志','魅力','学识'].forEach(n=>{if(!r[n].test(e))return;const s=a(_.get(t,`主角.人类属性.${n}`,1),1);if(s>=5)return void _.set(t,`主角.锻炼.${n}`,100);const o=a(_.get(t,`主角.锻炼.${n}`,0),0),c=Math.min(100,o+1);c>=100?(_.set(t,`主角.人类属性.${n}`,Math.min(5,s+1)),_.set(t,`主角.锻炼.${n}`,0)):_.set(t,`主角.锻炼.${n}`,c)})}function pt(){return Math.floor(10*Math.random())+1}const gt=/推轮椅|推着轮椅|扶着|搀扶|递给|递上|打招呼|点头|挥手|走过去|跟上|简单搬动|轻轻推动|慢慢推行/i,mt=/破门|破墙|砸墙|高处|跳楼|爆破|高压|战斗|交战|接敌|异种|敌人|枪|炮|开火|潜入|偷窃|胁迫|威胁|生死|危险|致命|极端/i,dt=/说服|交涉|谈判|恐吓|魅惑|审问|潜入|侦察|搜索|追踪|分析|研究|解读|解题|证明|翻译|手术|驾驶|拆弹/i,bt=/检定|判定|骰点|D10|掷骰/i,zt=/小心|谨慎|稳妥|避免|规避|不被发现|确保|尽量不|安全地|悄悄地|不惊动|不受伤|低风险|保护好/i;function $t(t,e,r){const n=function(t){const e=[{attr:'力量',pattern:/力量|搬运|举起|破门|推开|推动|推车|推行|拖拽|扛起|扛着|挥击|拳击|擒抱|攀爬|投掷|撬开|砸|砸开|砸墙|破墙|撞墙|破拆/i},{attr:'敏捷',pattern:/敏捷|闪避|躲避|冲刺|翻滚|疾跑|潜入|潜行|跳跃|翻越|驾驶|快速反应/i},{attr:'体质',pattern:/体质|耐力|硬抗|抗伤|扛住|恢复|憋气|抗毒|忍痛|耐寒|耐热|极端环境/i},{attr:'感知',pattern:/感知|侦察|观察|洞察|听声|追踪|搜索|聆听|察觉|察言观色|危险感知|找线索/i},{attr:'意志',pattern:/意志|精神|专注|抗压|抗恐惧|抵抗干扰|san|理智|催眠抵抗|精神对抗|心智/i},{attr:'魅力',pattern:/魅力|交涉|说服|谈判|鼓舞|社交|话术|魅惑|恐吓|礼仪|周旋/i},{attr:'学识',pattern:/学识|分析|研究|解读|知识|推理|图书馆|神秘学|历史|医学|数学|语文|英语|科学|计算|解题/i}].find(e=>e.pattern.test(t));return e?.attr??'无'}(e),s=function(t,e){const r=String(t??'').trim();if(!r)return!1;if(bt.test(r))return!0;const a=zt.test(r);return!(gt.test(r)&&!mt.test(r)||!m(r)&&(!mt.test(r)&&!dt.test(r)||!a)&&('学识'!==e||!/(考试|测验|证明|推导|解题|翻译|计算|公式|微积分|语法)/i.test(r)||!a))}(e,n)&&'无'!==n;if(!s)return;const o=n,c=function(t){return[{tag:'破拆',pattern:/砸|砸开|砸墙|破墙|破拆|撞墙|拆墙|破门/i},{tag:'推车',pattern:/推车|推动|推行|拖拽/i},{tag:'搬运',pattern:/搬运|举起|扛起|抬起|负重/i},{tag:'冲刺',pattern:/冲刺|疾跑|快速推进/i},{tag:'闪避',pattern:/闪避|躲避|翻滚/i},{tag:'侦察',pattern:/侦察|搜索|观察|洞察|追踪/i},{tag:'交涉',pattern:/交涉|说服|谈判|协商/i},{tag:'分析',pattern:/分析|研究|解读|推理/i},{tag:'抵抗',pattern:/抵抗|抗压|抗恐惧|硬抗/i}].find(e=>e.pattern.test(t))?.tag??'通用动作'}(e),i=a(_.get(t,'主角.战术.当前轮次',1),1),u=String(_.get(t,'主角.技能检定.封锁行为','')),l=a(_.get(t,'主角.技能检定.封锁至轮次',0),0);if(u&&u===c&&i<=l)return{attr:o,action_tag:c,current_round:i,raw:1,bonus:0,difficulty_penalty:0,difficulty_label:'封锁中',total:0,result:'失败',desc:`你在前次失败中受挫，${c} 被封锁至第 ${l} 轮，当前无法重复。`,lock_to_round:l,hp_loss:0,mp_loss:0};const f=a(_.get(t,`主角.人类属性.${o}`,0),0),p=function(t,e){let r=0;const a=/高等|高阶|复杂|精密|微积分|偏微分|拓扑|密码破译|三语同传|古文献|极限|高压|极端|战场极端环境/i.test(t);return a&&(r+=2),/专家级|大师级|传奇级|远超常人|超人|不可能|不现实|几乎无法完成/i.test(t)&&(r+=2),'学识'===e&&/数学|语文|英语|解题|推导|证明|翻译/i.test(t)&&a&&(r+=1),r<=0?{penalty:0,label:'常规难度'}:r<=2?{penalty:r,label:'困难难度'}:r<=4?{penalty:r,label:'极难难度'}:{penalty:Math.min(6,r),label:'超常难度'}}(e,o),g=_.clamp(r??pt(),1,10),d=Math.max(0,g+f-p.penalty);let b='失败',h='';10===g?(b='大成功',h='原始骰点=10，触发大成功。'):1===g?(b='大失败',h='原始骰点=1，触发大失败。'):d>5?(b='成功',h=`通过检定（高于目标值 ${d-5}），成功幅度越大效果越好。`):(b='失败',h=`未通过检定（低于目标值 ${5-d}），差距越大负面结果越重。`);let S=0,y=0,M=0;if('失败'===b||'大失败'===b){const t=function(t){const e=String(t??'');return/致命|生死|爆炸|坠落|极端|异种|敌袭|战斗|交火|枪|炮|高危|高空/i.test(e)?2:/潜入|追踪|谈判|说服|威胁|手术|驾驶|拆弹|高难|复杂/i.test(e)?1:0}(e);S=i+(2===t?'大失败'===b?4:2:1===t?'大失败'===b?3:1:'大失败'===b?2:1),y=2===t?'大失败'===b?12:4:1===t?'大失败'===b?8:2:'大失败'===b?4:0,M=2===t?'大失败'===b?15:6:1===t?'大失败'===b?10:3:'大失败'===b?5:1,h+=` 你受到惩罚：生命-${y}，魔力-${M}，并在第 ${S} 轮前无法重复该动作。`}return{attr:o,action_tag:c,current_round:i,raw:g,bonus:f,difficulty_penalty:p.penalty,difficulty_label:p.label,total:d,result:b,desc:h,lock_to_round:S,hp_loss:y,mp_loss:M}}function ht(t,e,r){if('失败'===r.result||'大失败'===r.result){const e='大失败'===r.result?4:2;_.set(t,'主角.技能检定.封锁行为',r.action_tag),_.set(t,'主角.技能检定.封锁至轮次',r.lock_to_round),_.set(t,`主角.异常状态.${r.action_tag}受挫`,{等级:'大失败'===r.result?'致命':'严重',效果:'大失败'===r.result?'重创与心理压迫，短期内无法重复该动作。':'动作受挫，短期内无法重复该动作。',剩余轮次:e}),_.set(t,'主角.资源.当前生命',Math.max(0,a(_.get(t,'主角.资源.当前生命',0),0)-r.hp_loss)),_.set(t,'主角.资源.当前魔力',Math.max(0,a(_.get(t,'主角.资源.当前魔力',0),0)-r.mp_loss))}else _.set(t,'主角.技能检定.封锁行为',''),_.set(t,'主角.技能检定.封锁至轮次',0);_.set(t,'主角.技能检定',{最近动作:e.slice(0,80),关联属性:r.attr,原始骰点:r.raw,属性加值:r.bonus,难度减值:r.difficulty_penalty,难度说明:r.difficulty_label,总值:r.total,结果:r.result,结果描述:r.desc,封锁行为:'失败'===r.result||'大失败'===r.result?r.action_tag:'',封锁至轮次:r.lock_to_round,更新时间:Date.now()}),_.set(t,`战场日志.技能检定-${Date.now()}`,`${r.action_tag} | ${r.attr} | 骰点${r.raw}+${r.bonus}-${r.difficulty_penalty}=${r.total} | ${r.difficulty_label} | ${r.result} | ${r.desc}`),c(t,3),_.set(t,'世界.近期事务.最近技能检定',`${r.action_tag}(${r.attr})=${r.result}，总值${r.total}，原始骰点${r.raw}，难度减值${r.difficulty_penalty}`)}function St(t,e){if(function(t){const e=String(t??'').trim();return!!e&&(!bt.test(e)&&(!m(e)&&!(!mt.test(e)&&!dt.test(e)||zt.test(e))))}(e)){const e='该行动存在风险/代价或需要额外步骤。请先声明“如何规避风险”，再进行检定。';return _.set(t,'世界.近期事务.风险提示',e),_.set(t,`战场日志.风险提示-${Date.now()}`,e),void c(t,3)}const r=$t(t,e);if(r)return ht(t,e,r),r}function yt(t,e){return!(a(_.get(t,'主角.资源.当前生命',0),0)>0)&&(_.set(t,'主角.资源.当前生命',0),_.set(t,'主角.灵装化.启用',!1),_.set(t,'主角.灵装化.手动切换',!1),_.set(t,'主角.战术.是否战斗中',!1),_.set(t,'主角.战术.战斗模式','非战斗'),_.set(t,'界面.游戏结束.已结束',!0),_.set(t,'界面.游戏结束.原因',e),_.set(t,'界面.游戏结束.时间戳',Date.now()),_.set(t,`战场日志.终局-${Date.now()}`,e),c(t,3),_.set(t,'世界.近期事务.本局状态','终止：生命值归零'),!0)}function Mt(t){a(_.get(t,'主角.资源.当前生命',0),0)<=0||Boolean(_.get(t,'界面.游戏结束.已结束',!1))&&(_.set(t,'界面.游戏结束.已结束',!1),_.set(t,'界面.游戏结束.原因',''),_.set(t,'界面.游戏结束.时间戳',0))}const jt=/空战|地面战|交战|战斗|接敌|敌袭|开火|突击|异种进攻|超视距空战|偷袭/i,vt=/说|问|回答|交流|对话|聊天|询问|讨论|讲述|回复/i,wt=/(?:跳过时间到|时间跳到|快进到|直接到)\s*([^\n，。,；;]+)/i;function Dt(t){return`联合纪年${Math.max(1,t.getFullYear()-2e3)}年${t.getMonth()+1}月${t.getDate()}日 ${`${t.getHours()}`.padStart(2,'0')}:${`${t.getMinutes()}`.padStart(2,'0')}`}function Ot(t,e){if(!t||'object'!=typeof t)return;const r=String(_.get(t,'世界.当前时间','')).trim(),n=function(t){const e=String(t??'').trim();if(!e)return new Date(2177,7,28,8,0,0,0);const r=e.match(/联合纪年\s*(\d+)\s*年\s*(\d{1,2})\s*月\s*(\d{1,2})\s*日(?:\s*(\d{1,2})[:：](\d{1,2}))?/);if(r){const t=2e3+a(r[1],177),e=a(r[2],8),n=a(r[3],28),s=a(r[4],8),o=a(r[5],0);return new Date(t,e-1,n,s,o,0,0)}const n=e.match(/(\d{4})[-/](\d{1,2})[-/](\d{1,2})(?:\s+(\d{1,2})[:：](\d{1,2}))?/);if(n){const t=a(n[1],2026),e=a(n[2],1),r=a(n[3],1),s=a(n[4],8),o=a(n[5],0);return new Date(t,e-1,r,s,o,0,0)}return new Date(2177,7,28,8,0,0,0)}(r),s=e.match(wt);if(s?.[1]){const e=function(t,e){const r=String(t??'').trim();if(!r)return;const n=r.match(/(?:(?:联合纪年)?\s*(\d+)\s*年)?\s*(\d{1,2})\s*月\s*(\d{1,2})\s*日(?:\s*(\d{1,2})[:：点时](\d{1,2})?)?/);if(n){const t=n[1]?2e3+a(n[1],e.getFullYear()-2e3):e.getFullYear(),r=a(n[2],e.getMonth()+1),s=a(n[3],e.getDate()),o=n[4]?a(n[4],8):e.getHours(),c=n[5]?a(n[5],0):e.getMinutes();return new Date(t,r-1,s,o,c,0,0)}const s=r.match(/(\d{1,2})\s*月\s*(\d{1,2})\s*日/);if(s){const t=a(s[1],e.getMonth()+1),n=a(s[2],e.getDate()),o=r.match(/(\d{1,2})[:：](\d{1,2})/),c=o?a(o[1],8):e.getHours(),i=o?a(o[2],0):e.getMinutes();return new Date(e.getFullYear(),t-1,n,c,i,0,0)}const o=r.match(/(\d{1,2})[:：](\d{1,2})/);if(o){const t=a(o[1],e.getHours()),r=a(o[2],e.getMinutes());return new Date(e.getFullYear(),e.getMonth(),e.getDate(),t,r,0,0)}}(s[1],n);if(e){const a=Dt(e);return _.set(t,'世界.当前时间',a),void _.set(t,'世界.近期事务.时间推进',`${r||Dt(n)} -> ${a}（玩家声明跳时）`)}}const o=jt.test(e)?_.random(240,360):vt.test(e)?5:20,c=Dt(new Date(n.getTime()+60*o*1e3)),i=jt.test(e)?`战斗推进${o}分钟`:vt.test(e)?'对话推进5分钟':'一般行为推进20分钟';_.set(t,'世界.当前时间',c),_.set(t,'世界.近期事务.时间推进',`${r||Dt(n)} -> ${c}（${i}）`)}const kt=/(我的背景|角色背景|人物背景|身世|来历|经历|过去|设定如下|背景如下)/,Ct=/武器|装备|能力|技能|灵装|道具|神器|无敌|神格|权柄之主/,Nt=/军人|军队|部队|训练|受训|战术|服役|教官|军校|实战/;function Pt(t,e){const r=String(e??'').trim();if(!r)return!1;if(!kt.test(r))return!1;if(r.length<24)return!1;const a=r.replace(/^.*?(我的背景|角色背景|人物背景|身世|来历|经历|过去|设定如下|背景如下)[:：]?\s*/i,'').trim()||r,n=function(t){const e=String(t??'').replace(/\r/g,'').replace(/[ \t]+/g,' ').trim();if(!e)return'';const r=e.split('\n').map(t=>t.trim()).filter(Boolean).filter(t=>!Ct.test(t)).join(' ');return r?r.length>180?`${r.slice(0,180)}...`:r:''}(a);return!!n&&(_.set(t,'主角.背景.原文',a),_.set(t,'主角.背景.摘要',n),_.set(t,'世界.近期事务.背景更新',`玩家补充背景：${n}`),!0)}function At(t){_.isObjectLike(_.get(t,'世界'))||_.set(t,'世界',{}),_.isObjectLike(_.get(t,'世界.近期事务'))||_.set(t,'世界.近期事务',{}),_.isObjectLike(_.get(t,'世界.新手引导'))?_.defaultsDeep(_.get(t,'世界.新手引导'),{剧情模式:!1,训练判定:'未受训',阶段:'入学手续',入学手续进度:0,课程周进度:0,已完成入学手续:!1,已完成课程周:!1,已接希尔顿任务:!1,最后推进说明:''}):_.set(t,'世界.新手引导',{剧情模式:!1,训练判定:'未受训',阶段:'入学手续',入学手续进度:0,课程周进度:0,已完成入学手续:!1,已完成课程周:!1,已接希尔顿任务:!1,最后推进说明:''});const e=Boolean(_.get(t,'界面.建卡.剧情模式',!1));_.set(t,'世界.新手引导.剧情模式',e||Boolean(_.get(t,'世界.新手引导.剧情模式',!1))),_.set(t,'世界.新手引导.训练判定',function(t){const e=String(_.get(t,'主角.背景.原文','')),r=String(_.get(t,'主角.背景.摘要',''));return Nt.test(`${e}\n${r}`)?'已受训':'未受训'}(t))}const xt=/报到|登记|核验|适配|测试|纪律简报|入学手续|宿舍/,Lt=/课程|训练|课堂|演练|体能|战术课|模拟战|读书|学习/,Et=/希尔顿|试验室|实验室|探索|侦查任务|副本|出发/;function Bt(t,e='-'){return String(t??'').trim()||e}function Ht(t,e=0){return Math.trunc(a(t,e))}function It(...t){for(const e of t){const t=String(e??'').trim();if(t)return t}return''}function qt(t){const e=String(t??'').trim();return!e||['待命战姬','写卡助手','玩家','主角'].includes(e)}function Rt(t,e){for(const r of t){const t=String(r??'').trim();if(t&&!e(r))return t}return''}function Tt(t,...e){if(!_.isObjectLike(t))return;_.isObjectLike(_.get(t,'界面'))||_.set(t,'界面',{}),_.isObjectLike(_.get(t,'界面.建卡'))||_.set(t,'界面.建卡',{}),_.isObjectLike(_.get(t,'主角'))||_.set(t,'主角',{}),_.isObjectLike(_.get(t,'主角.档案'))||_.set(t,'主角.档案',{});const r=e.filter(t=>_.isObjectLike(t)),n=Boolean(_.get(t,'界面.建卡.已开始',!1))||r.some(t=>Boolean(_.get(t,'界面.建卡.已开始',!1)));if(_.set(t,'界面.建卡.已开始',n),!n)return qt(_.get(t,'主角.档案.代号'))&&_.set(t,'主角.档案.代号',''),String(_.get(t,'主角.档案.性别','')).trim()||_.set(t,'主角.档案.性别',''),void(String(_.get(t,'主角.档案.身份路径','')).trim()||_.set(t,'主角.档案.身份路径',''));const s=function(t,e){const r=String(t??'').trim();if('指挥官'===r||'战姬'===r||'权柄使役者'===r)return r;const a=String(e??'').trim();return a.includes('战姬')?'战姬':a.includes('权柄')?'权柄使役者':'指挥官'}(It(_.get(t,'界面.建卡.职业'),...r.map(t=>_.get(t,'界面.建卡.职业'))),It(_.get(t,'主角.档案.身份路径'),...r.map(t=>_.get(t,'主角.档案.身份路径')))),o=It(_.get(t,'界面.建卡.战姬类型'),...r.map(t=>_.get(t,'界面.建卡.战姬类型')),String(_.get(t,'主角.档案.身份路径','')).replace(/^战姬-/,''),...r.map(t=>String(_.get(t,'主角.档案.身份路径','')).replace(/^战姬-/,'')),'轻型'),c=Rt([_.get(t,'界面.建卡.角色姓名'),_.get(t,'主角.档案.代号'),...r.map(t=>_.get(t,'界面.建卡.角色姓名')),...r.map(t=>_.get(t,'主角.档案.代号'))],qt)||'未命名',i='战姬'===s?'女性':Rt([_.get(t,'界面.建卡.性别'),_.get(t,'主角.档案.性别'),...r.map(t=>_.get(t,'界面.建卡.性别')),...r.map(t=>_.get(t,'主角.档案.性别'))],t=>!['男性','女性'].includes(String(t??'').trim()))||'男性',u=a(It(_.get(t,'界面.建卡.年龄'),...r.map(t=>_.get(t,'界面.建卡.年龄')),21),21),l=_.clamp(u,12,80);_.set(t,'界面.建卡.职业',s),_.set(t,'界面.建卡.战姬类型',o),_.set(t,'界面.建卡.角色姓名',c),_.set(t,'界面.建卡.性别',i),_.set(t,'界面.建卡.年龄',l),_.set(t,'主角.档案.代号',c),_.set(t,'主角.档案.性别',i),_.set(t,'主角.档案.身份路径','战姬'===s?`战姬-${o}`:s)}function Ft(t,e=2){return _.isObjectLike(t)?Object.entries(t).slice(-e).map(([t,e])=>[t,Bt(e)]):[]}$(()=>{errorCatched(async()=>{const e='__apocalypse_dawn_variable_bridge_installed__';if(window[e])return;window[e]=!0,function(){const t=window.parent?.document??document,e='apocalypse-dawn-hide-original-reply-style';if(t.getElementById(e))return;const r=t.createElement('style');r.id=e,r.textContent='\n    .mes:has(.TH-render) .mes_text > :not(.TH-render) {\n      display: none !important;\n    }\n  ',t.head.appendChild(r)}(),t(r),await waitGlobalInitialized('Mvu');const n=new Set,s=new Map,u=new Map,l=new Set;async function f(t){if(l.has(t))return;const e=getChatMessages(t,{include_swipes:!1})[0];if(!e||'user'!==e.role||e.is_hidden)return;const r=String(e.message??'').trim();if(!r)return;const n=getChatMessages(`0-${Math.max(0,t-1)}`,{role:'assistant',include_swipes:!1}),s=n.length>0?n[n.length-1]:void 0,f=s?Mvu.getMvuData({type:'message',message_id:s.message_id}):Mvu.getMvuData({type:'chat'}),p=Mvu.getMvuData({type:'chat'}),g=_.cloneDeep(f??{});g.stat_data=_.isObjectLike(g?.stat_data)?_.cloneDeep(g.stat_data):{},i(g.stat_data),k(g.stat_data),At(g.stat_data),C(g.stat_data),Tt(g.stat_data,_.get(p,'stat_data')),Mt(g.stat_data);if(!Boolean(_.get(g.stat_data,'界面.建卡.已开始',!1)))return void l.add(t);Pt(g.stat_data,r),At(g.stat_data),Tt(g.stat_data,_.get(p,'stat_data')),function(t,e){At(t);const r=_.get(t,'世界.新手引导');if(!r||!r.剧情模式)return;const n=String(e??'');if(!n.trim())return;const s=String(r.阶段||'入学手续');if('入学手续'===s){if(!xt.test(n))return;return r.入学手续进度=_.clamp(a(r.入学手续进度,0)+1,0,4),r.最后推进说明=`入学手续推进 ${r.入学手续进度}/4`,_.set(t,'世界.近期事务.引导链',`阶段1/3 入学手续（${r.入学手续进度}/4）`),void(r.入学手续进度>=4&&(r.已完成入学手续=!0,r.阶段='课程周',r.最后推进说明='入学手续已完成，进入一周课程。',_.set(t,'世界.近期事务.引导链','阶段2/3 课程周（0/7）'),_.set(t,'世界.近期事务.课程安排','进行一周基础课程：体能、战术理论、模拟侦察与安全条例。')))}if('课程周'===s){if(!Lt.test(n))return;return r.课程周进度=_.clamp(a(r.课程周进度,0)+1,0,7),r.最后推进说明=`课程周推进 ${r.课程周进度}/7`,_.set(t,'世界.近期事务.引导链',`阶段2/3 课程周（${r.课程周进度}/7）`),void(r.课程周进度>=7&&(r.已完成课程周=!0,r.阶段='希尔顿试验室任务',r.最后推进说明='课程周已完成，可接取最低难度希尔顿试验室探索任务。',_.set(t,'世界.近期事务.引导链','阶段3/3 希尔顿试验室任务（待接取）'),_.set(t,'世界.近期事务.实验室任务','前往最低难度希尔顿试验室，完成首次探索与撤离。')))}if('希尔顿试验室任务'===s){if(!Et.test(n))return;r.已接希尔顿任务=!0,r.阶段='自由推进',r.最后推进说明='已接取并开始最低难度希尔顿试验室探索任务。',_.set(t,'世界.近期事务.引导链','引导链完成：已进入自由推进阶段。')}}(g.stat_data,r),Ot(g.stat_data,r);const m=function(t,e){if(!B.test(e))return!1;const r=_.get(t,'界面.在场角色',[]).map(t=>t.姓名),n=[...A(e,r)],s=n.length>0?n:1===r.length?[r[0]]:[];if(0===s.length)return!1;for(const e of s){const r=x(t,e);r.玩家随行请求命中次数=a(r.玩家随行请求命中次数,0)+1,r.最近玩家请求时间=Date.now(),E(t,e,'任务搭档')}return!0}(g.stat_data,r);lt(g.stat_data,r),_t(g.stat_data,r),it(g.stat_data,r),ut(g.stat_data,r),R(g.stat_data),F(g.stat_data),ft(g.stat_data,r),o(g.stat_data),Tt(g.stat_data,_.get(p,'stat_data')),Mt(g.stat_data);const h=!_.isEqual(_.get(g,'stat_data'),_.get(f,'stat_data',{})),S=d(g.stat_data,r),y=b(g.stat_data,r),M=Boolean(_.get(g.stat_data,'主角.战术.是否战斗中',!1))&&'空战'===_.get(g.stat_data,'主角.战术.战斗模式','非战斗');if(S||y||M)return l.add(t),c(g.stat_data,3),await Mvu.replaceMvuData(g,{type:'chat'}),s&&await Mvu.replaceMvuData(g,{type:'message',message_id:s.message_id}),void console.info(`[天启黎明][空战] 已结算玩家动作楼层 ${t}`);const j=St(g.stat_data,r);if(!j)return l.add(t),void((m||h)&&(c(g.stat_data,3),await Mvu.replaceMvuData(g,{type:'chat'}),s&&await Mvu.replaceMvuData(g,{type:'message',message_id:s.message_id})));l.add(t);const v=yt(g.stat_data,`检定失败导致生命归零：${j.action_tag} / ${j.result}`),w=function(t,e){const r=['[系统检定反馈-必须执行]',`动作: ${t.action_tag}`,`属性: ${t.attr}`,`公式: D10(${t.raw}) + 属性(${t.bonus}) - 难度(${t.difficulty_penalty}) = ${t.total}`,`难度: ${t.difficulty_label}`,`结果: ${t.result}`,`后果: ${t.desc}`,'写作要求: 必须把该检定结果与后果直接写进本轮叙事，不可忽略，不可弱化。'];return e&&r.push('终局要求: 主角生命值归零，本局立即结束。你只能输出终局/善后叙事，不得继续推进可行动剧情。'),r.join('\n')}(j,v);injectPrompts([{id:`apocalypse-dawn-skill-feedback-pre-${t}-${Date.now()}`,position:'in_chat',depth:0,role:'system',content:w,should_scan:!0}],{once:!0}),u.set(t,{user_message_id:t,source_content:r,outcome:j,feedback_prompt:w,injected:!0,game_over:v}),c(g.stat_data,3),await Mvu.replaceMvuData(g,{type:'chat'}),s&&await Mvu.replaceMvuData(g,{type:'message',message_id:s.message_id}),console.info(`[天启黎明][检定前置] 已处理玩家动作楼层 ${t}`)}function p(t){const e=function(t){const e=_.isObjectLike(t?.stat_data)?t.stat_data:{},r=Boolean(_.get(e,'界面.建卡.已开始',!1)),a=Bt(_.get(e,'世界.当前时间',_.get(e,'世界.日期'))),n=Bt(_.get(e,'世界.当前地点',_.get(e,'世界.地点'))),s=Bt(_.get(e,'世界.天气')),o=Bt(_.get(e,'世界.战区威胁等级','中')),c=r?Bt(_.get(e,'主角.档案.代号',_.get(e,'界面.建卡.角色姓名'))):'未建卡',i=r?Bt(_.get(e,'界面.建卡.职业')):'未建卡',u=r?Bt(_.get(e,'主角.档案.身份路径')):'未建卡',l=r?Bt(_.get(e,'界面.建卡.性别',_.get(e,'主角.档案.性别','未知'))):'未设定',f=r?Ht(_.get(e,'界面.建卡.年龄',0),0):0,p=Ht(_.get(e,'主角.资源.当前生命',0),0),g=Ht(_.get(e,'主角.资源.最大生命',_.get(e,'主角.资源.生命上限',p)),p),m=Ht(_.get(e,'主角.资源.当前魔力',0),0),d=Ht(_.get(e,'主角.资源.最大魔力',_.get(e,'主角.资源.魔力上限',m)),m),b=Ht(_.get(e,'主角.资源.行动点',1),1),h=Ht(_.get(e,'主角.资源.移动点',1),1),S=Ht(_.get(e,'主角.资源.灵装槽当前',0),0),y=Ht(_.get(e,'主角.资源.灵装槽上限',S),S),M=Ht(_.get(e,'主角.资源.污染值',0),0),j=Boolean(_.get(e,'主角.战术.是否战斗中',!1)),v=Bt(_.get(e,'主角.战术.战斗模式','非战斗')),w=Bt(_.get(e,'主角.战术.当前阵线','中线')),D=Ht(_.get(e,'主角.战术.当前轮次',1),1),O=Bt(_.get(e,'主角.战术.制空权','争夺中')),k=Bt(_.get(e,'主角.战术.火力惩罚','无')),C=Ht(_.get(e,'主角.成长.战姬老练等级',0),0),N=Ht(_.get(e,'主角.成长.权柄使役者等级',0),0),P=Ht(_.get(e,'主角.成长.魔力碎片',0),0),A=Ht(_.get(e,'主角.成长.下一级所需魔力碎片',0),0),x=Ht(_.get(e,'主角.成长.权柄碎片',0),0),L=Boolean(_.get(e,'主角.成长.权柄本源',!1)),E=Bt(_.get(e,'主角.技能检定.结果描述','暂无检定')),B=!(Ht(_.get(e,'主角.技能检定.更新时间',0),0)>0)||/暂无检定|尚未检定|未进行检定/.test(E),H=B?'无':Bt(_.get(e,'主角.技能检定.结果','无')),I=B?'无':Bt(_.get(e,'主角.技能检定.关联属性','无')),q=B?0:Ht(_.get(e,'主角.技能检定.总值',0),0),R=Bt(_.get(e,'主角.背景.摘要',''),''),T=Boolean(_.get(e,'世界.新手引导.剧情模式',_.get(e,'界面.建卡.剧情模式',!1))),F=Bt(_.get(e,'世界.新手引导.训练判定','未受训')),G=Bt(_.get(e,'世界.新手引导.阶段','入学手续')),J=Ht(_.get(e,'世界.新手引导.入学手续进度',0),0),Y=Ht(_.get(e,'世界.新手引导.课程周进度',0),0),U=Bt(_.get(e,'世界.新手引导.最后推进说明',''),''),V=Ft(_.get(e,'世界.近期事务',{}),2),K=Ft(_.get(e,'战场日志',{}),2),Q=['[MVU状态摘要-每轮必读]',`世界: 日期=${a} | 地点=${n} | 天气=${s} | 威胁=${o}`,`主角: 姓名=${c} | 性别=${l} | 年龄=${f} | 职业=${i} | 身份=${u}`,`资源: HP=${p}/${g} | MP=${m}/${d} | AP=${b} | Move=${h} | 灵装槽=${S}/${y} | 污染=${M}`,`战术: 战斗中=${j?'是':'否'} | 模式=${v} | 阵线=${w} | 轮次=${D} | 制空=${O} | 火力惩罚=${k}`,`成长: 战姬老练=${C} | 权柄等级=${N} | 魔力碎片=${P}(下级需${A}) | 权柄碎片=${x} | 权柄本源=${L?'有':'无'}`,`检定: 最近=${H} | 属性=${I} | 总值=${q}`];return R&&Q.push(`主角背景摘要: ${R}`),T?(Q.push(`剧情模式: 开启 | 训练判定=${F} | 当前阶段=${G}`),Q.push(`引导进度: 入学手续=${J}/4 | 课程周=${Y}/7`),U&&Q.push(`引导备注: ${U}`),Q.push('剧情模式硬约束: 必须严格按阶段推进，不得越级。'),'入学手续'===G?Q.push('当前只允许输出入学手续相关内容：身份核验、报到登记、链路适配测试、纪律简报。禁止提前进入课程周或希尔顿试验室任务。'):'课程周'===G?Q.push('当前只允许输出课程周内容：体能/战术理论/模拟侦察等日程训练。禁止提前进入希尔顿试验室探索。'):'希尔顿试验室任务'===G&&Q.push('当前必须引导至“最低难度希尔顿试验室探索任务”，并围绕接任务、整备、出发推进。')):Q.push('剧情模式: 关闭（可自由推进）。'),V.length>0&&Q.push(`近期事务: ${V.map(([t,e])=>`${t}:${e}`).join('；')}`),K.length>0&&Q.push(`战场日志: ${K.map(([t,e])=>`${t}:${e}`).join('；')}`),Q.push('要求: 优先遵循以上状态叙事，不得与状态冲突。'),r?Q.push('身份硬约束: 你必须严格按“主角”行中的姓名/性别/职业进行叙事与称呼，不得回退为默认男性指挥官。'):Q.push('当前未完成建卡: 只允许推进建卡与入学手续，不得假定主角性别/职业。'),Q.push('判定原则: 玩家先描述行动；若行动不可能/有代价/有风险，先明确告知。仅当玩家明确“要规避风险”时再掷骰。'),Q.push('叙事风格: 使用自然、人性化表达；非战斗场景避免持续高压训斥和绝望基调，允许正常互动与缓冲节奏。'),Q.push('角色触发规范: 优先按自然叙事输出即可（系统会从中文正文自动识别在场角色）；若你愿意，也可在末尾附加 <OnStageCharacters>JSON数组提高稳定性。'),Q.push('内心想法规范: 本轮若出现在场角色，必须给出其“本回合内心想法/心理动机”，并随回合刷新，不得长期复用旧句。'),Q.push('地点硬限制: 角色“薇薇安娜·威曼普”仅允许在“威曼普城西侧·大图书馆”及其内部场景出现；若地点不在大图书馆，禁止让其出场或发言。'),Q.push('人物弧光规范: 薇薇安娜的态度需随好感阶段自然变化；若阶段=伴侣，必须表现为“成熟克制的并肩关系”，禁止依恋化、幼态化或占有欲表达。'),Q.push('文风要求: 使用自然叙事，不要机械复述变量清单，不要把系统规则原样复读进正文。'),Q.push('JSON字段: 姓名(string), 好感度(-200~1000), 态度(string), 内心想法(string), 基础属性(object<number>)。'),Q.push('可选附加: <NpcRelationHints>JSON数组</NpcRelationHints>，字段: 姓名(string), 标签(string[])。'),Q.join('\n')}(Mvu.getMvuData({type:'chat'}));injectPrompts([{id:`apocalypse-dawn-mvu-summary-${t}-${Date.now()}`,position:'in_chat',depth:0,role:'system',content:e,should_scan:!0}],{once:!0})}async function g(t){if(n.has(t))return;const e=getChatMessages(t,{include_swipes:!1})[0];if(!e||'assistant'!==e.role||e.is_hidden)return;const r=e.message?.trim()??'';if(r&&s.get(t)!==r){n.add(t);try{const e=Mvu.getMvuData({type:'message',message_id:t}),n=await Mvu.parseMessage(r,e);n.stat_data&&'object'==typeof n.stat_data||(n.stat_data={}),function(t){return/<update(?:variable)?>[\s\S]*?<\/update(?:variable)?>|<update(?:variable)?>[\s\S]*$/im.test(t)}(r)||function(t,e){if(!_.isObjectLike(t))return;if(!_.isObjectLike(e))return;const r=['界面.建卡','主角.档案','主角.人类属性','主角.属性','主角.资源','主角.成长','主角.战术','主角.技能检定','主角.装备','主角.异常状态','战利品.仓库'];for(const a of r){const r=_.get(e,a);void 0!==r&&_.set(t,a,_.cloneDeep(r))}}(n.stat_data,e?.stat_data),i(n.stat_data),k(n.stat_data),At(n.stat_data),C(n.stat_data);const l=Mvu.getMvuData({type:'chat'});Tt(n.stat_data,_.get(l,'stat_data'),_.get(e,'stat_data')),Mt(n.stat_data),n.stat_data.界面&&'object'==typeof n.stat_data.界面||(n.stat_data.界面={});const f=function(t){const e=t.match(/<OnStageCharacters>([\s\S]*?)<\/OnStageCharacters>/im);if(e?.[1])try{const t=JSON.parse(e[1]);if(!Array.isArray(t))return;return t.filter(t=>_.isObjectLike(t)).map(t=>{const e=_.isObjectLike(t.基础属性)?t.基础属性:{},r=Object.fromEntries(Object.entries(e).map(([t,e])=>[t,a(e,0)]));return{姓名:String(t.姓名??'未命名'),好感度:_.clamp(a(t.好感度,0),-200,1e3),等级:String(t.等级??'新手'),态度:String(t.态度??'中立'),内心想法:String(t.内心想法??''),基础属性:r,更新时间:Date.now()}})}catch{return}}(r),p=Array.isArray(_.get(n.stat_data,'界面.在场角色'))?_.get(n.stat_data,'界面.在场角色'):[],g=O(r,{exclude_names:[String(_.get(n.stat_data,'主角.档案.代号','')),String(_.get(n.stat_data,'界面.建卡.角色姓名',''))].filter(Boolean),old_onstage:p}),m=function(t){const e=t.match(/<NpcRelationHints>([\s\S]*?)<\/NpcRelationHints>/im);if(e?.[1])try{const t=JSON.parse(e[1]);if(!Array.isArray(t))return;return t.filter(t=>_.isObjectLike(t)).map(t=>({姓名:String(t.姓名??''),标签:Array.isArray(t.标签)?t.标签.map(t=>String(t)):[]})).filter(t=>t.姓名)}catch{return}}(r),b=[...f??[],...g],S=new Set([String(_.get(n.stat_data,'主角.档案.代号','')),String(_.get(n.stat_data,'界面.建卡.角色姓名',''))].filter(Boolean));if(b.length>0){const t=function(t,e){const r=new Map;for(const e of t)r.set(e.姓名,{姓名:String(e.姓名||'未命名'),好感度:N(e.好感度,0),等级:String(e.等级||'新手'),态度:String(e.态度||'中立'),内心想法:String(e.内心想法||''),基础属性:_.isObjectLike(e.基础属性)?_.cloneDeep(e.基础属性):{},更新时间:a(e.更新时间,0)});for(const t of e){const e=String(t.姓名||'未命名'),a=r.get(e);if(!a){r.set(e,{姓名:e,好感度:N(t.好感度,0),等级:String(t.等级||'新手'),态度:String(t.态度||'中立'),内心想法:String(t.内心想法||''),基础属性:_.isObjectLike(t.基础属性)?_.cloneDeep(t.基础属性):{},更新时间:Date.now()});continue}const n=N(t.好感度,a.好感度),s=n>a.好感度?Math.min(a.好感度+5,n):n;r.set(e,{姓名:e,好感度:N(s,a.好感度),等级:String(t.等级||a.等级||'新手'),态度:String(t.态度||a.态度||'中立'),内心想法:String(t.内心想法||a.内心想法||''),基础属性:{...a.基础属性??{},..._.isObjectLike(t.基础属性)?t.基础属性:{}},更新时间:Date.now()})}return[...r.values()]}(p,b);n.stat_data.界面.在场角色=v(t,S),_.set(n.stat_data,'世界.近期事务.在场角色更新',`AI更新在场角色：${_.uniq(b.map(t=>t.姓名)).join('、')}`)}else{const t=Array.isArray(_.get(n.stat_data,'界面.在场角色'))?_.get(n.stat_data,'界面.在场角色'):[];n.stat_data.界面.在场角色=v(t,S)}!function(t,e){const r=Array.isArray(_.get(t,'界面.在场角色'))?_.get(t,'界面.在场角色'):[];if(0===r.length)return;const a=h(String(e??''));if(!a)return;const n=r.map(t=>{const e=String(t?.姓名??'');if(!e||!a.includes(e))return t;const r=w(a,e);return{...t,态度:D(r)||String(t.态度??'中立'),内心想法:r?`本回合：${r}`:`本回合：${e}未显著外露想法。`,更新时间:Date.now()}});_.set(t,'界面.在场角色',n)}(n.stat_data,r);const y=getChatMessages(t-1,{include_swipes:!1})[0],M=y&&'user'===y.role?String(y.message??''):'',j=`${M}\n${r}`,P=y&&'user'===y.role?u.get(y.message_id):void 0;lt(n.stat_data,j),_t(n.stat_data,j),it(n.stat_data,r),ut(n.stat_data,M),ft(n.stat_data,j),o(n.stat_data),d(n.stat_data,j),P&&(ht(n.stat_data,P.source_content,P.outcome),P.game_over&&yt(n.stat_data,`检定失败导致生命归零：${P.outcome.action_tag} / ${P.outcome.result}`),u.delete(y.message_id)),yt(n.stat_data,'生命值归零，本局立即结束。'),Mt(n.stat_data),function(t,e,r,n,s){k(t);const o=_.get(t,'界面.在场角色',[]),c=_.get(t,'世界.长期NPC列表',{}),i=_.uniq([...o.map(t=>t.姓名),...Object.keys(c),...n?.map(t=>t.姓名)??[]]),u=new Set((n??[]).map(t=>t.姓名)),l=A(e,i),f=new Set([...u,...l]),p=a(_.get(t,'主角.战术.当前轮次',1),1);for(const e of i){const r=x(t,e);f.has(e)?(r.连续出现计数=a(r.连续出现计数,0)+1,r.最近出现轮次=p):r.连续出现计数=Math.max(0,a(r.连续出现计数,0)-1),r.连续出现计数>=5&&!r.是否已转长期&&E(t,e,'连续出现')}for(const e of o)_.has(t,`世界.长期NPC列表.${e.姓名}`)&&L(t,e.姓名,e);for(const e of s??[]){if(!_.has(c,e.姓名))continue;const r=_.get(t,`世界.长期NPC列表.${e.姓名}.关系标签`,[]);_.set(t,`世界.长期NPC列表.${e.姓名}.关系标签`,_.uniq([...r??[],...e.标签]))}const g=H.test(e),m=I.test(r);if(g&&m)for(const r of A(e,Object.keys(_.get(t,'世界.长期NPC列表',{})))){if(N(_.get(t,`世界.长期NPC列表.${r}.好感度`,0),0)<601)continue;const e=_.get(t,`世界.长期NPC列表.${r}.关系标签`,[]),a=_.uniq([...Array.isArray(e)?e:[],'伴侣']);_.set(t,`世界.长期NPC列表.${r}.关系标签`,a),_.set(t,`世界.长期NPC列表.${r}.好感阶段`,'伴侣'),_.set(t,`世界.长期NPC列表.${r}.最后更新时间`,Date.now())}if(q.test(e))for(const r of A(e,Object.keys(_.get(t,'世界.长期NPC列表',{})))){const e=a(_.get(t,`世界.长期NPC列表.${r}.性行为次数`,0),0)+1;_.set(t,`世界.长期NPC列表.${r}.性行为次数`,e),_.set(t,`世界.长期NPC列表.${r}.贞洁状态`,'非处女'),_.set(t,`世界.长期NPC列表.${r}.最后更新时间`,Date.now())}}(n.stat_data,r,M,b,m),R(n.stat_data),F(n.stat_data),n.stat_data.界面.楼层文本={正文:h(r),原文:r,更新时间:Date.now()},Tt(n.stat_data,_.get(l,'stat_data'),_.get(e,'stat_data')),Mt(n.stat_data),c(n.stat_data,3),await Mvu.replaceMvuData(n,{type:'chat'}),await Mvu.replaceMvuData(n,{type:'message',message_id:t}),s.set(t,r),console.info(`[天启黎明][MVU桥接] 已同步楼层 ${t}`)}catch(e){console.warn(`[天启黎明][MVU桥接] 同步楼层 ${t} 失败`,e)}finally{n.delete(t)}}}window.addEventListener('message',t=>{const e=t.data;if(!_.isObjectLike(e))return;if('apocalypse-dawn:send_action'!==e.type)return;if('apocalypse_dawn_mvu'!==e.source)return;const r=String(e.action??'').trim();if(!r)return;const a=function(t){const e=String(t??'').trim();if(!e)return!1;const r=['#send_textarea','textarea#send_textarea','textarea[id*="send"]','textarea'],a=['#send_but','button#send_but','#send-button','button[type="submit"]'];let n=null;for(const t of r){const e=document.querySelector(t);if(e instanceof HTMLTextAreaElement){n=e;break}}if(!n)return!1;n.value=e,n.dispatchEvent(new Event('input',{bubbles:!0})),n.dispatchEvent(new Event('change',{bubbles:!0}));for(const t of a){const e=document.querySelector(t);if(e instanceof HTMLElement)return e.click(),!0}return!1}(r);a||console.warn('[天启黎明][动作发送] 未找到输入框或发送按钮，无法代发。')}),eventOn(tavern_events.MESSAGE_RECEIVED,t=>{g(t)}),eventOn(tavern_events.MESSAGE_UPDATED,t=>{g(t)}),eventOn(tavern_events.MESSAGE_SENT,t=>{f(t),p(t)}),eventOn(tavern_events.GENERATION_AFTER_COMMANDS,()=>{const t=getChatMessages(-1,{role:'user',include_swipes:!1})[0];if(!t||'user'!==t.role)return;p(t.message_id);const e=Mvu.getMvuData({type:'chat'}),r=u.get(t.message_id);if(r&&!r.injected)return injectPrompts([{id:`apocalypse-dawn-skill-feedback-${t.message_id}-${Date.now()}`,position:'in_chat',depth:0,role:'system',content:r.feedback_prompt,should_scan:!0}],{once:!0}),void(r.injected=!0);const n=Boolean(_.get(e,'stat_data.界面.空战反馈.待反馈',!1)),s=String(_.get(e,'stat_data.界面.空战反馈.摘要','')).trim();if(n&&s){injectPrompts([{id:`apocalypse-dawn-airbattle-${Date.now()}`,position:'in_chat',depth:0,role:'system',content:`[空战结算-强制叙事钩子]\n${s}\n要求：你必须严格按该结算继续叙事，并同步后果；不得与结算冲突。`,should_scan:!0}],{once:!0});const t=_.cloneDeep(e??{});_.isObjectLike(t.stat_data)||(t.stat_data={}),_.isObjectLike(t.stat_data.界面)||(t.stat_data.界面={}),t.stat_data.界面.空战反馈={待反馈:!1,摘要:s,时间戳:Date.now()},Mvu.replaceMvuData(t,{type:'chat'})}const o=Boolean(_.get(e,'stat_data.界面.游戏结束.已结束',!1)),c=a(_.get(e,'stat_data.主角.资源.当前生命',1),1);o&&c<=0&&injectPrompts([{id:`apocalypse-dawn-gameover-${Date.now()}`,position:'in_chat',depth:0,role:'system',content:'系统裁定：主角生命值归零，本局已结束。你只能输出终局/善后叙事，不得继续正常推进剧情。',should_scan:!0}],{once:!0})}),eventOn(tavern_events.CHAT_CHANGED,()=>{n.clear(),s.clear(),u.clear();const t=getChatMessages(-1,{include_swipes:!1})[0];t&&'assistant'===t.role&&g(t.message_id)});const m=getChatMessages(-1,{include_swipes:!1})[0];m&&'assistant'===m.role&&g(m.message_id);const S=window.setInterval(()=>{const t=getChatMessages(-1,{include_swipes:!1})[0];t&&'assistant'===t.role&&!t.is_hidden&&g(t.message_id)},1500),y=window.setInterval(()=>{const t=getChatMessages(-1,{role:'user',include_swipes:!1})[0];t&&'user'===t.role&&!t.is_hidden&&(l.has(t.message_id)||(f(t.message_id),p(t.message_id)))},1200);window.addEventListener('beforeunload',()=>{window.clearInterval(S),window.clearInterval(y)},{once:!0})})()});
//# sourceMappingURL=index.js.map