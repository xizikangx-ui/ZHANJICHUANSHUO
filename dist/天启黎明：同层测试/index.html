<head><script type="module">import'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/json5/+esm';import'https://testingcf.jsdelivr.net/npm/jsonrepair/+esm';import'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';var e={391(e,t,n){n.d(t,{mountStreamingMessages:()=>o});function a(e='head'){const t=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo(e);return{destroy:()=>t.remove()}}function l(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(e){const t=16*Math.random()|0;return('x'===e?t:3&t|8).toString(16)})}var r=n(61);function o(e,t={}){const{host:n='iframe',filter:o,prefix:s=l()}=t,i=new Map;let c=!1;const u=e=>{const t=Number($('#chat > .mes').first().attr('mesid'));return!_.inRange(e,t,SillyTavern.chat.length)&&(i.get(e)?.destroy(),!0)},m=()=>{i.keys().forEach(e=>u(e))},d=async(t,l)=>{if(c)return;if(u(t))return;const m=l??getChatMessages(t)[0].message??'';if(o&&!o(t,m))return void i.get(t)?.destroy();const d=$(`.mes[mesid='${t}']`),p=d.find('.mes_text').addClass('hidden!');d.find('.TH-streaming').addClass('hidden!');let v=d.find(`#${s}-${t}`);if(v.length>0){const e=i.get(t);if(e)return e.data.message=m,void(e.data.during_streaming=Boolean(l))}i.get(t)?.destroy(),v.remove();let y=d.find('.mes_streaming');0===y.length&&(y=$('<div class="mes_streaming">').css({'font-weight':'500','line-height':'calc(var(--mainFontSize) + .5rem)','max-width':'100%','overflow-wrap':'anywhere',padding:'calc(var(--mainFontSize) * 0.8) 0 0 0'}).insertAfter(p)),v=('iframe'===n?$('<iframe>').attr({script_id:getScriptId(),frameborder:0,srcdoc:'<!DOCTYPE html> <html> <head> <link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"> <script src="https://testingcf.jsdelivr.net/gh/n0vi028/JS-Slash-Runner/lib/tailwindcss.min.js"><\/script> <script src="https://testingcf.jsdelivr.net/npm/jquery"><\/script> <script src="https://testingcf.jsdelivr.net/npm/jquery-ui/dist/jquery-ui.min.js"><\/script> <link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/jquery-ui/themes/base/theme.min.css"/> <script src="https://testingcf.jsdelivr.net/npm/jquery-ui-touch-punch"><\/script> <script src="https://testingcf.jsdelivr.net/npm/lodash"><\/script> <script src="https://testingcf.jsdelivr.net/gh/n0vi028/JS-Slash-Runner/src/iframe/adjust_iframe_height.js"><\/script> <style>*,::after,::before{box-sizing:border-box}body,html{margin:0!important;padding:0;overflow:hidden!important;max-width:100%!important}</style> <style>@import url(https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Noto+Serif+SC:wght@400;500;700&display=swap);
/*! tailwindcss v4.2.1 | MIT License | https://tailwindcss.com */.shell[data-v-26213a16]{--ink:#e8ddc6;--ink-muted:#b7a586;--line:#6f5632;--line-soft:#4f3b23;--panel:rgba(16,12,9,0.9);--panel-2:rgba(34,24,16,0.9);--gold:#b49a63;width:min(96vw,1920px);max-width:none;min-height:96vh;margin:0 auto;padding:14px;display:flex;flex-direction:column;gap:10px;color:var(--ink);background:radial-gradient(circle at 14% -10%,rgba(188,146,71,0.2),transparent 34%),radial-gradient(circle at 90% 0,rgba(130,40,40,0.18),transparent 28%),linear-gradient(150deg,#080705,#120d09 48%,#090705);border:1px solid var(--line);border-radius:14px;font-family:"Noto Serif SC","Source Han Serif SC",serif;position:relative;overflow:hidden;box-shadow:0 24px 70px rgba(0,0,0,.5),inset 0 0 0 1px rgba(255,223,160,.06);text-align:center}.shell[data-v-26213a16]::before,.shell[data-v-26213a16]::after{content:"";position:absolute;inset:0;pointer-events:none}.shell[data-v-26213a16]::before{background:linear-gradient(transparent 97%,rgba(232,193,110,0.05)),linear-gradient(90deg,transparent 97%,rgba(166,45,45,0.03));background-size:100% 4px,4px 100%;mix-blend-mode:soft-light}.shell[data-v-26213a16]::after{border:1px solid rgba(188,156,98,.24);border-radius:11px;margin:6px}.start-screen[data-v-26213a16]{min-height:calc(100vh - 110px);display:grid;place-items:center;border:1px solid var(--line);border-radius:12px;position:relative;overflow:hidden;background:radial-gradient(circle at 20% 25%,rgba(118,34,34,0.3),transparent 42%),radial-gradient(circle at 75% 15%,rgba(168,134,69,0.25),transparent 34%),linear-gradient(140deg,rgba(12,9,7,0.94),rgba(19,13,9,0.95))}.start-screen__veil[data-v-26213a16]{position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent 0,transparent 5px,rgba(232,193,110,0.05) 5px,rgba(232,193,110,0.05) 6px);animation:pageDrift-26213a16 16s linear infinite}.start-card[data-v-26213a16]{position:relative;width:min(1600px,100% - 28px);border:1px solid #8f7044;border-radius:10px;background:linear-gradient(180deg,rgba(20,14,10,0.95),rgba(13,10,8,0.96));padding:28px 26px;box-shadow:0 18px 44px rgba(0,0,0,.44),inset 0 0 0 1px rgba(217,181,113,.1);animation:cardLift-26213a16 520ms ease-out}.start-card__kicker[data-v-26213a16]{margin:0;font:600 11px/1.2 "Cinzel","Noto Serif SC",serif;letter-spacing:.18em;color:#c9b086}.start-card h2[data-v-26213a16]{margin:10px 0 8px;font:700 clamp(72px,12vw,168px)/1.04 "Cinzel","Noto Serif SC",serif;letter-spacing:.12em;color:rgba(0,0,0,0);background:linear-gradient(180deg,#fff6dc 0%,#f8de9f 24%,#d3aa57 52%,#f1d188 74%,#8d6428 100%);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:rgba(0,0,0,0);text-shadow:0 0 6px rgba(181,141,64,.26),0 0 14px rgba(116,82,30,.22),0 0 26px rgba(64,44,16,.16)}.start-card__desc[data-v-26213a16]{margin:0;color:var(--ink-muted);line-height:1.65}.start-card__author[data-v-26213a16]{margin:0 0 10px;color:#ceb893;letter-spacing:.05em}.start-card__quote[data-v-26213a16]{margin:14px 0 0;padding-left:0;border-left:0;color:#d7c7a7;opacity:.92}.start-card__mode[data-v-26213a16]{margin:8px 0 0;color:#ceb893;font-size:13px}.start-card__actions[data-v-26213a16]{margin-top:18px;display:grid;grid-template-columns:1fr;gap:10px;width:min(420px,92%);margin-inline:auto;justify-items:center;align-items:center}.start-card__actions button[data-v-26213a16]{width:min(320px,100%);display:block;text-align:center;margin-inline:auto}.start-card__actions .xeno[data-v-26213a16]{border-color:#8b4a4a;background:linear-gradient(180deg,#5e2a2a,#3e1b1b)}.create-card[data-v-26213a16]{display:grid;gap:14px}.create-card h2[data-v-26213a16]{margin:0;font:700 30px/1.2 "Cinzel","Noto Serif SC",serif;text-align:center;color:#f3e4c4;text-shadow:0 0 10px rgba(160,120,58,.22)}.create-card label[data-v-26213a16]{display:grid;gap:8px;padding:12px;border:1px solid rgba(190,152,85,.5);border-radius:10px;background:linear-gradient(180deg,rgba(227,183,107,0.05),rgba(227,183,107,0)),rgba(25,18,12,.86);box-shadow:inset 0 0 0 1px rgba(255,223,163,.06)}.create-card label>span[data-v-26213a16]{font-size:18px;font-weight:700;letter-spacing:.03em;color:#f0ddb7}.create-card input[data-v-26213a16],.create-card select[data-v-26213a16],.create-card textarea[data-v-26213a16]{font-size:18px;color:#f5e8cc;background:rgba(31,22,14,.95);border-color:#b4915e}.desc-field textarea[data-v-26213a16]{min-height:180px;font-size:14px;line-height:1.5;white-space:pre-wrap}.xeno-box[data-v-26213a16]{border:1px solid rgba(156,79,79,.55);border-radius:10px;padding:10px;background:linear-gradient(180deg,rgba(120,42,42,0.16),rgba(40,16,16,0.2));display:grid;gap:8px}.xeno-box>p[data-v-26213a16]{margin:0}.attr-list[data-v-26213a16]{display:grid;gap:8px}.attr-item[data-v-26213a16]{border:1px solid rgba(190,152,85,.38);border-radius:8px;background:rgba(26,18,12,.72);padding:10px;display:grid;gap:8px}.attr-item header[data-v-26213a16]{display:grid;gap:3px}.attr-item header strong[data-v-26213a16]{font-size:18px;color:#f0ddb7}.attr-item header span[data-v-26213a16]{font-size:13px;color:var(--ink-muted)}.attr-ctrl[data-v-26213a16]{display:flex;justify-content:center;align-items:center;gap:8px}.attr-ctrl b[data-v-26213a16]{min-width:28px;font-size:20px;color:#f4e7cd}.topbar[data-v-26213a16],.row[data-v-26213a16]{display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:wrap}.center-row[data-v-26213a16]{justify-content:center}.title h1[data-v-26213a16]{margin:0;font:700 24px/1.2 "Cinzel","Noto Serif SC",serif;letter-spacing:.05em}.title p[data-v-26213a16]{margin:3px 0 0;font-size:12px;color:var(--ink-muted)}.controls[data-v-26213a16]{display:flex;gap:8px;justify-content:center}.db-btn[data-v-26213a16]{border-color:#8f7044;background:linear-gradient(180deg,rgba(103,78,41,0.45),rgba(49,36,19,0.45))}.panel[data-v-26213a16]{border:1px solid var(--line-soft);border-radius:10px;background:linear-gradient(180deg,rgba(255,230,180,0.03),transparent),var(--panel);padding:10px;box-shadow:inset 0 0 0 1px rgba(255,223,160,.05)}.main-layout[data-v-26213a16]{display:grid;grid-template-columns:260px minmax(0,1fr);gap:10px;align-items:start}.main-column[data-v-26213a16]{display:grid;gap:10px}.player-sidebar[data-v-26213a16]{position:sticky;top:10px;text-align:left}.player-sidebar h3[data-v-26213a16]{margin:0 0 10px;font:700 18px/1.2 "Cinzel","Noto Serif SC",serif;letter-spacing:.04em;color:#f2dfbb}.player-sidebar dl[data-v-26213a16]{margin:0;display:grid;gap:8px}.player-sidebar dl>div[data-v-26213a16]{display:grid;gap:4px;padding:8px;border:1px solid rgba(190,152,85,.38);border-radius:8px;background:rgba(26,18,12,.72)}.player-sidebar dt[data-v-26213a16]{font-size:12px;color:var(--ink-muted)}.player-sidebar dd[data-v-26213a16]{margin:0;font-size:16px;color:#f4e7cd}.inventory-panel[data-v-26213a16]{margin-top:10px;border:1px solid rgba(190,152,85,.35);border-radius:8px;padding:8px;background:rgba(22,16,11,.72);display:grid;gap:8px}.inventory-panel h4[data-v-26213a16]{margin:0;color:#efdcb8}.inventory-form[data-v-26213a16]{display:grid;grid-template-columns:1fr;gap:6px}.inventory-item[data-v-26213a16]{border:1px solid rgba(190,152,85,.28);border-radius:8px;padding:7px;background:rgba(29,21,14,.72);text-align:left}.inventory-item header[data-v-26213a16]{display:flex;justify-content:space-between;align-items:center;gap:6px}.inventory-item p[data-v-26213a16]{margin:4px 0 0}.attr-card dd[data-v-26213a16]{display:flex;gap:6px;flex-wrap:wrap}.attr-chip[data-v-26213a16]{border:1px solid rgba(190,152,85,.35);border-radius:999px;padding:2px 7px;font-size:12px;color:#e8d8b7;background:rgba(20,14,10,.7)}.settings[data-v-26213a16]{display:grid;grid-template-columns:1fr 1fr;gap:8px}.settings label[data-v-26213a16]:last-of-type{grid-column:1/-1}.settings label.full[data-v-26213a16]{grid-column:1/-1}.toggle[data-v-26213a16]{grid-column:1/-1;display:flex;align-items:center;gap:10px;font-size:12px;color:var(--ink-muted);justify-content:center}.toggle input[type=checkbox][data-v-26213a16]{appearance:none;-webkit-appearance:none;width:44px;height:24px;border-radius:999px;border:1px solid #8e6c3d;background:linear-gradient(180deg,#2c2014,#1c150e);position:relative;cursor:pointer;transition:background .2s ease,border-color .2s ease;flex:0 0 auto}.memory-vault[data-v-26213a16]{display:grid;gap:8px}.memory-item[data-v-26213a16]{border:1px solid rgba(190,152,85,.34);border-radius:8px;background:rgba(23,16,11,.82);padding:8px;text-align:left}.memory-item header[data-v-26213a16]{display:flex;justify-content:space-between;gap:8px;align-items:baseline;margin-bottom:6px}.memory-item pre[data-v-26213a16]{margin:0;white-space:pre-wrap;line-height:1.45;color:#e6d7b8}.memory-item.mega[data-v-26213a16]{border-color:rgba(118,88,42,.6);background:rgba(30,22,13,.86)}.npc-panel[data-v-26213a16]{display:grid;gap:8px}.npc-form[data-v-26213a16]{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}.npc-columns[data-v-26213a16]{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}.npc-columns section[data-v-26213a16]{border:1px solid rgba(190,152,85,.3);border-radius:8px;padding:8px;background:rgba(23,16,11,.7);text-align:left}.npc-columns h4[data-v-26213a16]{margin:0 0 6px;color:#ead9b8}.npc-card[data-v-26213a16]{border:1px solid rgba(190,152,85,.28);border-radius:8px;padding:8px;margin-bottom:6px;background:rgba(31,22,14,.72)}.npc-card header[data-v-26213a16]{display:flex;justify-content:space-between;align-items:center;gap:6px}.npc-card p[data-v-26213a16]{margin:4px 0 0}.toggle input[type=checkbox][data-v-26213a16]::after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:linear-gradient(180deg,#d2bf96,#9a7f4f);box-shadow:0 1px 4px rgba(0,0,0,.4);transition:left .2s ease}.toggle input[type=checkbox][data-v-26213a16]:checked{background:linear-gradient(180deg,#6e2a2a,#4c1c1c);border-color:#b8835f}.toggle input[type=checkbox][data-v-26213a16]:checked::after{left:22px}input[data-v-26213a16],select[data-v-26213a16],textarea[data-v-26213a16],button[data-v-26213a16]{border:1px solid #7b6040;border-radius:7px;background:rgba(34,24,16,.9);color:var(--ink);padding:8px}input[data-v-26213a16],select[data-v-26213a16],textarea[data-v-26213a16]{width:100%}button[data-v-26213a16]{cursor:pointer;background:linear-gradient(180deg,#7c6038,#523a24);border-color:#ad8d59;transition:filter 160ms ease,transform 160ms ease}button[data-v-26213a16]:hover{filter:brightness(1.08);transform:translateY(-1px)}button[data-v-26213a16]:active{transform:translateY(0)}button.ghost[data-v-26213a16]{background:linear-gradient(180deg,#3a2b1d,#281d13);border-color:#6d5637}.quick button[data-v-26213a16]:nth-child(2){border-color:#8b5f43}.quick button[data-v-26213a16]:nth-child(3){border-color:#844444;background:linear-gradient(180deg,#6e3535,#4a2222)}button.small[data-v-26213a16]{font-size:11px;padding:4px 8px}button[data-v-26213a16]:disabled{opacity:.55;cursor:not-allowed;transform:none}.quick[data-v-26213a16]{display:flex;gap:8px}.chat[data-v-26213a16]{display:flex;flex-direction:column;gap:10px}.messages[data-v-26213a16]{max-height:52vh;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:2px;align-items:center}.messages[data-v-26213a16]::-webkit-scrollbar{width:8px}.messages[data-v-26213a16]::-webkit-scrollbar-thumb{background:rgba(155,122,72,.7);border-radius:10px}.msg[data-v-26213a16]{border:1px solid #685133;border-radius:9px;padding:10px;background:rgba(24,18,12,.8);width:min(940px,100%)}.msg--user[data-v-26213a16]{border-color:#8f5d3e;background:linear-gradient(180deg,rgba(33,22,15,0.95),rgba(25,18,13,0.9))}.msg--assistant[data-v-26213a16]{border-color:#7b6a49;background:linear-gradient(180deg,rgba(20,16,11,0.95),rgba(14,12,9,0.92))}.msg--error[data-v-26213a16]{border-color:#8f3d3d;background:rgba(128,38,38,.26)}.msg header[data-v-26213a16]{font:600 11px/1.3 "Cinzel","Noto Serif SC",serif;letter-spacing:.08em;color:var(--ink-muted);margin-bottom:5px}.msg pre[data-v-26213a16]{white-space:pre-wrap;margin:0;font:inherit;line-height:1.7;text-align:center}.composer[data-v-26213a16]{display:flex;flex-direction:column;gap:8px}.hint[data-v-26213a16]{font-size:12px;color:var(--ink-muted)}.system-float[data-v-26213a16]{position:fixed;right:14px;top:14px;z-index:200000;display:flex;flex-direction:column;gap:8px;width:min(360px,100vw - 24px)}.system-notice[data-v-26213a16]{border:1px solid #9d7a46;border-radius:8px;background:linear-gradient(180deg,rgba(24,18,12,0.97),rgba(18,14,10,0.97));box-shadow:0 10px 30px rgba(0,0,0,.4);padding:10px}.system-notice header[data-v-26213a16]{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px;color:var(--gold)}.db-notice[data-v-26213a16]{border-color:#b68a48;box-shadow:0 12px 30px rgba(0,0,0,.45)}@keyframes cardLift-26213a16{from{opacity:0;transform:translateY(10px) scale(0.99)}to{opacity:1;transform:translateY(0) scale(1)}}@keyframes pageDrift-26213a16{from{transform:translateY(0)}to{transform:translateY(6px)}}@media (max-width:700px){.main-layout[data-v-26213a16]{grid-template-columns:1fr}.player-sidebar[data-v-26213a16]{position:static;text-align:center}.settings[data-v-26213a16],.quick[data-v-26213a16]{grid-template-columns:1fr;display:grid}.npc-form[data-v-26213a16],.npc-columns[data-v-26213a16]{grid-template-columns:1fr}.title h1[data-v-26213a16]{font-size:19px}.start-card[data-v-26213a16]{padding:20px 16px}.start-card__actions[data-v-26213a16]{display:grid;grid-template-columns:1fr}}

/*# sourceMappingURL=main.css.map*/</style></head> <html> </html></html>'}).addClass('w-full'):$('<div>').attr('script_id',getScriptId())).attr('id',`${s}-${t}`).appendTo(y);const g=(0,r.reactive)({prefix:s,host_id:`${s}-${t}`,message_id:t,message:m,during_streaming:Boolean(l)}),f=e().provide('streaming_message_context',g);'iframe'===n?v.on('load',function(){a(this.contentDocument.head),f.mount(this.contentDocument.body)}):f.mount(v[0]);const h=new MutationObserver(()=>{const e=$('#chat').find('#curEditTextarea');e.parent().is(p)?(p.removeClass('hidden!'),v.addClass('hidden!')):0===e.length&&(p.addClass('hidden!'),d.find('.TH-streaming').addClass('hidden!'),v.removeClass('hidden!'))});h.observe(p[0],{childList:!0}),i.set(t,{app:f,data:g,destroy:()=>{const e=d.find('.TH-streaming');e.length>0?e.removeClass('hidden!'):p.removeClass('hidden!'),f.unmount(),v.remove(),0===y.children().length&&y.remove(),h.disconnect(),i.delete(t)}})},p=async(e={})=>{c||(e.destroy_all?i.forEach(({destroy:e})=>e()):m(),await Promise.all($('#chat').children('.mes[is_user=\'false\'][is_system=\'false\']').map(async(t,n)=>{const a=Number($(n).attr('mesid')??'NaN');isNaN(a)||(await d(a),e.trigger_event&&eventEmit(tavern_events.CHARACTER_MESSAGE_RENDERED,a,'rerender'))})))},v=[],y=(e,t,n)=>{v.push(n?eventMakeFirst(e,errorCatched(t)).stop:eventOn(e,errorCatched(t)).stop)};return y('chatLoaded',()=>{p({destroy_all:!0})}),y(tavern_events.CHARACTER_MESSAGE_RENDERED,e=>{m(),d(e)},!0),[tavern_events.MESSAGE_EDITED,tavern_events.MESSAGE_DELETED].forEach(e=>y(e,e=>{m(),i.get(e)?.destroy(),d(e)})),[tavern_events.MORE_MESSAGES_LOADED,tavern_events.MESSAGE_DELETED].forEach(e=>y(e,()=>setTimeout(errorCatched(p),1e3))),y(tavern_events.STREAM_TOKEN_RECEIVED,e=>{d(Number($('#chat').children('.mes.last_mes').attr('mesid')),e)}),'div'===n&&v.push(a().destroy),p({trigger_event:!0}),{unmount:()=>{const e=$('#chat').find('.TH-streaming');e.length>0?e.removeClass('hidden!'):$('chat').find('.mes_text').removeClass('hidden!'),i.forEach(({destroy:e})=>e()),v.forEach(e=>e()),c=!0}}}},313(e,t){t.A=(e,t)=>{const n=e.__vccOpts||e;for(const[e,a]of t)n[e]=a;return n}},61(e){e.exports=Vue}},t={};function n(a){var l=t[a];if(void 0!==l)return l.exports;var r=t[a]={exports:{}};return e[a](r,r.exports,n),r.exports}n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var a=n(61);const l={key:0,class:'start-screen'},r={class:'start-card'},o={class:'start-card__mode'},s={class:'start-card__mode'},i={class:'start-card__mode'},c={class:'start-card__actions'},u={key:1,class:'panel create-card'},m=['disabled'],d=['value'],p={key:0,class:'xeno-box'},v={class:'desc-field'},y=['value'],g=['min','max'],f=['disabled'],h=['value'],E={key:1},V=['value'],N={key:2,class:'desc-field'},k=['value'],b={class:'row center-row'},S={key:2,class:'panel create-card'},D={class:'hint'},w={class:'attr-list'},x={class:'attr-ctrl'},C=['disabled','onClick'],M=['disabled','onClick'],A={class:'row center-row'},B={key:3,class:'panel create-card'},T=['value'],P={class:'row'},U={class:'hint'},F={class:'desc-field'},I={class:'hint'},j={class:'row center-row'},L={class:'topbar'},R={class:'controls'},O={class:'main-layout'},K={class:'panel player-sidebar'},q={class:'attr-card'},J={class:'resource-card'},H={class:'attr-chip'},G={class:'attr-chip'},X={class:'attr-chip'},Y={class:'inventory-panel'},W={class:'row'},Q={key:0,class:'inventory-form'},Z={key:1,class:'hint'},ee=['onClick'],te={key:2,class:'hint'},ne={class:'main-column'},ae={class:'panel pager'},le={class:'row'},re=['disabled'],oe={class:'hint'},se=['disabled'],ie={class:'toggle'},ce={key:0,class:'panel settings'},ue={class:'row'},me={class:'hint'},de={class:'toggle'},pe={id:'th-model-options'},ve=['value'],ye={class:'row'},ge=['disabled'],fe={class:'hint'},he={class:'toggle'},Ee={class:'toggle'},Ve={class:'full'},Ne={class:'toggle'},ke={class:'full'},be={class:'toggle'},Se={class:'toggle'},De={class:'full'},we={class:'toggle'},xe={class:'full'},Ce={class:'row'},Me={key:1,class:'panel memory-vault'},Ae={class:'row'},Be={class:'hint'},$e={class:'row'},_e=['disabled'],Te=['disabled'],Pe={class:'hint'},Ue={key:0,class:'hint'},Fe={class:'row'},Ie={class:'hint'},je={class:'hint'},Le={class:'panel quick'},Re=['disabled'],Oe=['disabled'],Ke=['disabled'],ze={class:'panel chat'},qe={class:'messages'},Je=['disabled'],He={class:'row'},Ge={class:'hint'},Xe=['disabled'],Ye={class:'panel npc-panel'},We={class:'row'},Qe={class:'hint'},Ze={class:'npc-form'},et={class:'toggle'},tt={class:'npc-columns'},nt=['onClick'],at={key:0,class:'hint'},lt=['onClick'],rt={key:0,class:'hint'},ot={key:5,class:'system-float'},st={key:0,class:'system-notice db-notice'},it={key:0},ct={key:1},ut=['onClick'],mt='th-layer-test-api-settings-v3',dt='th-layer-test-memory-runtime-v1',pt=(0,a.defineComponent)({__name:'App',props:{mode:{default:'standalone'}},setup(e){const t=e,n=(0,a.computed)(()=>'embedded'===t.mode?'酒馆同层模式':'独立模式'),pt=(0,a.computed)(()=>void 0!==window.SillyTavern),vt=(0,a.ref)(null),yt=(0,a.ref)(!1),gt=(0,a.ref)(!1),ft=(0,a.ref)(!1),ht=(0,a.ref)(1),Et=(0,a.ref)(!1),Vt=(0,a.ref)(!0),Nt=(0,a.ref)(!1),kt=(0,a.ref)('再诞战姬'),bt=(0,a.ref)(!0),St=(0,a.ref)(!1),Dt=(0,a.ref)(!0),wt=(0,a.ref)(!0),xt=(0,a.ref)(!1),Ct=(0,a.ref)(!1),Mt=(0,a.ref)(''),At=(0,a.ref)(1),Bt=(0,a.ref)(0),$t=(0,a.ref)('未读取'),_t=(0,a.ref)([]),Tt=(0,a.reactive)({active:!1,completed:!1,label:'',seconds:0}),Pt=['战姬','指挥官','权柄使役者'],Ut=['侦察型','轻型','中型','重型','要塞型','地面支援型'],Ft=['男','女','伪娘','双性','沃尔玛购物袋','武装直升机'],It={战姬:{min:12,max:18},指挥官:{min:21,max:70},权柄使役者:{min:14,max:80}},jt={战姬:'【战姬】\n战姬是人类方面的终极单位，也是人类在与异种长期战争中最核心、最不可替代的高端战力。\n无论是正面战场的拦截、前线支援、空域压制、要点防守，还是对异种高危个体的猎杀行动，战姬都承担着远超常规兵力的战略价值。\n\n但战姬并不是可以规模化制造的常规兵种。\n在当前世界范围内，人类侧战姬总数永远不会超过1000。\n这个数量限制并非单纯来自训练资源，而是来自“觉醒本身”的稀缺性与不可控性。\n\n目前已知的觉醒规律是：\n战姬只会在人类12-18岁的少女中随机觉醒。',指挥官:'指挥官：\n特殊词条：指挥/调律者\n指挥官的基础六维属性骰点为\n魔力评级:X\n力量加成:X\n体质加成:1D6\n抗污染值:1D6\n飞行速度:X\n防御评级:X\n指挥官并非标准武装，而是每个队伍中必须有的协调人员，只有在拥有指挥官的情况下，才能完成各单位之间的协调，同时指挥官可以使用基础地面自卫武器用于保护自己。\n指挥官的魔力频率独特，可以用以打开每个战姬独立的魔力频率锁进行调律\n每个分队必须有一名指挥官，而且指挥官性别不限制，\t可以为男性或女性。\n指挥官每回合可以行动1次，可以移动1次，但是不具有飞行能力，最好让指挥官处于支援阵线，指挥官可以携带一种支援设备协助战斗。\n指挥官通常驾驶无人补给舰或其他舰只跟随行动，如果指挥官所有补给消耗完毕，那么所有单位在使用完当前魔力后则立即解除灵装。',权柄使役者:'权柄使役者\n权柄使役者是从异种尚未来到的时代就已经存在的超自然力量使用者，他们通过一系列复杂的仪式，特殊的圣器，与高位存在的契约等表象方式仪式性的使用权柄的碎片，实际上是依靠散落在其家族血脉中的权柄碎片来运行被称之为【仪式】的力量来进行一系列超自然的行动。\n在【公主】被弑神之剑处决后，新时代的权柄使役者相较于曾经的屈指可数变的泛滥了许多，一些从未出现过的权柄也落到了凡人手中。\n权柄各有不同，权柄使役者通常从从高到低可以分级为。\n【权柄之主】\n【编织者】\n【书写者】\n【信徒】'},Lt={侦察型:'空战行动点（严格按类型）:\n侦察型:\n  行动点: 1\n  移动点: 2',轻型:'轻型：\n特殊词条：轻装/追踪\n轻型战姬的基础六维属性骰点为\n魔力评级:4D6\n力量加成:3D6\n体质加成:3D6\n抗污染值:3D6\n飞行速度:5D6\n防御评级:2D6\n轻型战姬的武装强度最大可以为2级，可以携带轻型自卫灵装或轻型炮型灵装，允许携带近身灵装武器（例如猎杀者轻剑），可以装备轻型灵装防具，通常适合正面支援其他战姬或对敌对战姬/异种生物进行骚扰或追击，移动速度相对来说是除了侦察型战姬以外最快的，可以轻松追杀一些敌对目标，甚至某些极端情况可以欺负武装失效的大型敌人。\n轻型战姬一回合可以行动2次，可以移动1次，开火不需要任何准备行动，在任何位置都可以无损开火。',中型:'中型：\n特殊词条：武装/反制\n中型战姬的基础六维属性骰点为\n魔力评级:4D6\n力量加成:4D6\n体质加成:3D6\n抗污染值:5D6\n飞行速度:4D6\n防御评级:3D8\n中型战姬的武装强度最大可以为3级，可以携带中型自卫灵装或正规炮型灵装，可以装备中型灵装防具，通常适合对抗高强度的敌人，是最平均的战姬，从某种意义上来说什么都可以做，但是因为太全能反而没有什么比较突出的点，不过某种意义上，当你不知道选什么样的战姬灵装好的时候，中型就可以成为你的选择。\n中型战姬一回合可以行动1次，可以移动1次，开火不需要任何准备行动，在任何位置都可以无损开火。',重型:'重型：\n特殊词条：武装/重甲\n重型战姬的基础六维属性骰点为\n魔力评级:4D6\n力量加成:6D6\n体质加成:5D6\n抗污染值:6D6\n飞行速度:3D5\n防御评级:4D8\n重型战姬的武装强度最大可以为4级，可以携带重型自卫灵装或正规炮型灵装，允许装备重型联装炮型灵装，可以装备大型灵装防具，通常适合对抗极高强度的敌人，强大的武装可以轻易撕碎一些小型敌人，但是基本很难躲开敌人的攻击，不过一般情况下有其他同分队队友的帮忙的情况下，依靠厚重的装甲一般很难被解除灵装化。\n重型战姬一回合可以行动1次，每两回合可以移动1次，开火如果携带重型武器，需要架设灵装一回合，在中线和后卫可以无损开火，在前线损失三分之一的伤害骰（向上取整），在交锋区则损失二分之一伤害骰（向上取整）',要塞型:'要塞型：\n特殊词条：武装/要塞/屏障\n要塞型战姬的基础六维属性骰点为\n魔力评级:4D6\n力量加成:10D6\n体质加成:7D6\n抗污染值:10D6\n飞行速度:1D2\n防御评级:7D10\n要塞型战姬的武装强度最大可以为6级，可以携带要塞型自卫灵装或正规炮型灵装，允许装备超重型多联装炮型灵装，允许携带要塞级灵装，可以装备要塞级灵装防具，通常适合对抗任何强度的敌人，强大的武装可以轻易撕碎所有敌人，但是没有闪避攻击的可能性，通常一旦展开灵装就极度需要其他队友的掩护，否则被大量敌人追击的时候跑都跑不掉。\n要塞型战姬一回合可以行动1次，战斗中无法移动，开火时如果携带要塞级火力，必须要有侦察型或轻型提供稳定射击辅助的情况下才能无损开火，否则会损失五分之四的伤害骰（向上取整），在后卫可以无损开火，如果位于中线则损失二分之一的伤害骰（向上取整），在前线，交锋区则只能使用自卫灵装。',地面支援姬:'地面支援姬：\n特殊词条：武装/地面支援\n指挥官的基础六维属性骰点为\n魔力评级:4d6\n力量加成:5d6\n体质加成:4D6\n抗污染值:10D6\n飞行速度:1d1\n防御评级:4d12\n地面支援姬的武装最大等级为2，但是可以装配独特的投弹舱，主要针对地面目标，巢穴等其他单位进行打击，但由于异常耐打所以也可以在有些时候被丢到前线去，地面支援姬无论任何区域都可以使用任何灵装。\n地面支援姬一回合可以行动1次，可以移动1次，开火不需要任何准备行动，在任何位置都可以无损开火。'},Rt=(0,a.reactive)({name:'',profession:'战姬',warmaidType:'侦察型',age:12,gender:'女',background:''}),Ot={战姬:'我在近期完成觉醒，被地方机构登记后依照【第二协议】送往威曼普学院。\n觉醒后的身体感知、魔力流动与情绪波动都与过去不同，这份力量让我兴奋，也让我不安。\n入学后我必须尽快完成灵装适配、基础战术训练和小队磨合，学会在危险世界里正确使用力量，而不是被力量和恐惧拖垮。',指挥官:'我来自联合或大公国体系下的普通教育与基础军训环境，在进入威曼普学院前已接受过基础纪律、地图判读、队列协同或后勤常识训练，但并非前线老兵。\n依照【第二协议】，我被送入威曼普战姬学院接受战术化训练，目标是完成指挥链路适配并学会与战姬小队稳定协同。\n我清楚自己不是最强的战斗单位，因此更重视判断、秩序、补给与沟通，希望在真实任务中证明自己能在压力下做出正确决定。',权柄使役者:'我作为新入门的权柄使役者（或家族传承中的低阶使役者）被纳入学院体系，拥有初步仪式经验或象征性施术认知，但缺乏系统战术训练。\n在进入威曼普学院后，我需要学习如何在团队规则下使用权柄，控制代价、稳定施术，并在侦查与支援任务中证明自己的价值。\n我明白权柄并不意味着无敌，错误使用只会让自己和队友承担后果，因此我必须先学会约束与判断。',再诞战姬:'我在异种巢穴深层的石棺中苏醒，被高位异种个体牵引至巢穴外层。\n我的战姬能力并不稳定，认知滤镜在观察下级异种时会改变我看到的显现方式，但危险性并未降低。\n我必须在巢穴与占领区环境中完成自我定位，弄清自身位格与代价来源，再决定是否接触人类学院体系。',异种指挥官:'我在异种巢穴外围恢复意识，保留了异常指挥感知，却失去了完整记忆链。\n高位异种并未将我视为普通猎物，而是以观察者姿态放任我进入异种战场链路。\n我需要在巢穴环境中建立自己的调度规则，确认“认知滤镜”与现实风险的边界，再决定如何与人类阵线发生接触。'},Kt=[{key:'战姬',label:'战姬默认背景'},{key:'指挥官',label:'指挥官默认背景'},{key:'权柄使役者',label:'权柄使役者默认背景'},{key:'再诞战姬',label:'再诞战姬默认背景（异种）'},{key:'异种指挥官',label:'异种指挥官默认背景（异种）'}],zt=(0,a.ref)('战姬'),qt=[{key:'力量',desc:'发力、搬运、近身压制能力。'},{key:'敏捷',desc:'反应、闪避、平衡与位移。'},{key:'体质',desc:'生命、耐受与恢复。'},{key:'感知',desc:'观察、聆听、环境识别。'},{key:'意志',desc:'抗压、抗恐惧、精神稳定。'},{key:'魅力',desc:'社交表达、说服与安抚。'},{key:'学识',desc:'知识、推理与信息整理。'}],Jt=(0,a.reactive)({力量:1,敏捷:1,体质:1,感知:1,意志:1,魅力:1,学识:1}),Ht=(0,a.computed)(()=>5-Object.values(Jt).reduce((e,t)=>e+Number(t||0),0)+7),Gt=(0,a.computed)(()=>It[Rt.profession]),Xt=(0,a.computed)(()=>jt[Rt.profession]),Yt=(0,a.computed)(()=>{'侦查型'===Rt.warmaidType&&(Rt.warmaidType='侦察型');const e='侦查型'===Rt.warmaidType?'侦察型':'地面支援型'===Rt.warmaidType?'地面支援姬':Rt.warmaidType;return Lt[e]??'世界书暂无该类型的独立条目。'}),Wt=(0,a.computed)(()=>Nt.value?kt.value:Rt.profession),Qt=(0,a.computed)(()=>Kt.find(e=>e.key===zt.value)?.label||'未选择'),Zt=(0,a.computed)(()=>{const e=(Rt.background||'').replace(/\s+/g,' ').trim();return e?e.length>220?`${e.slice(0,220)}...`:e:'未填写'}),en=()=>{const e=(()=>{if(Nt.value)return'再诞战姬'===kt.value?{hpMax:130,mpMax:140,ap:1}:{hpMax:110,mpMax:130,ap:1};if('战姬'===Rt.profession)return{hpMax:120,mpMax:120,ap:{侦察型:1,轻型:2,中型:1,重型:1,要塞型:1,地面支援型:1}[Rt.warmaidType]??1};return'指挥官'===Rt.profession?{hpMax:100,mpMax:100,ap:1}:{hpMax:100,mpMax:110,ap:1}})();wn.hpMax=e.hpMax,wn.hp=e.hpMax,wn.mpMax=e.mpMax,wn.mp=e.mpMax,wn.ap=e.ap},tn={autoFlipPage:!0,useTavernPreset:!0,baseUrl:'https://api.openai.com/v1',apiKey:'',model:'gpt-4.1-mini',systemPrompt:'你是一个同层游玩叙事助手。请简洁推进剧情并给出下一步选项。',autoSummaryEnabled:!0,summaryFloorsPerRun:5,summaryUseCurrentApi:!0,autoSummaryPrompt:'你是同层游玩的记忆总结器。请将输入楼层对话压缩为结构化记忆，包含：关键事件、角色关系变化、已确定规则/设定、未完成目标、危险与伏笔。避免废话，避免改写事实。',summaryUseVarApi:!1,summaryVarApiUrl:'',summaryVarApiKey:'',summaryVarApiPayload:'{"scope":"layer_memory","need":["world_state","route_state","flags"]}',megaSummaryEnabled:!0,megaSummaryEvery:5,megaSummaryUseCurrentApi:!0,megaSummaryPrompt:'你是超大总结器。请把输入的大总结内容再次融合，输出稳定世界状态、核心矛盾、长期目标、角色关系总图与下一阶段策略。',megaSummaryUseVarApi:!1,megaSummaryVarApiUrl:'',megaSummaryVarApiKey:'',megaSummaryVarApiPayload:'{"scope":"mega_memory","need":["global_flags","chapter_progress"]}'},nn=(0,a.reactive)({...tn}),an=(0,a.ref)([]),ln=(0,a.ref)(!1),rn=(0,a.ref)([]),on=(0,a.ref)([]),sn=(0,a.ref)([]),cn=(0,a.ref)([]),un=(0,a.ref)([]),mn=(0,a.reactive)({name:'',role:'',relation:'',status:'',tags:'',toLongterm:!1}),dn=(0,a.reactive)({name:'',count:1,note:''}),pn=(0,a.ref)(!1),vn=(0,a.ref)(0),yn=(0,a.ref)(0),gn=(0,a.ref)(0),fn=(0,a.computed)(()=>Ct.value||pn.value?'数据库后台处理中，请稍候...':xt.value?'AI 回复中...':n.value),hn=(0,a.computed)(()=>xt.value||pn.value||Ct.value),En=(0,a.inject)('streaming_message_context',null),Vn=(0,a.computed)(()=>En?`\n\n[上下文] 当前楼层ID: ${En.message_id}\n[楼层文本]\n${En.message??''}`:''),Nn=(0,a.computed)(()=>{const e=qt.map(e=>`${e.key}:${Jt[e.key]}`).join(' / '),t=Nt.value?`异种开局(${kt.value})`:'常规开局',n=Et.value?'作弊模式':'标准模式';return[`[建卡状态] 姓名=${Rt.name||'未命名'} | 性别=${Rt.gender} | 职业=${Rt.profession} | 年龄=${Rt.age}`,`[建卡状态] 路线=${t} | 模式=${n}`,`[建卡状态] 剧情模式=${Vt.value?'开启':'关闭'} | 锚点=${Vt.value?'__PLOT_ON__':'__PLOT_OFF__'}`,`[建卡状态] 人类属性=${e}`,`[建卡状态] 资源=生命${wn.hp}/${wn.hpMax} 魔力${wn.mp}/${wn.mpMax} 行动点${wn.ap}`,`[建卡状态] 背景原文=${Rt.background||'未填写'}`,`[建卡状态] 背景摘要=${Zt.value}`,Vt.value?'[剧情模式约束] 必须按入学引导与章节推进链叙事。':'[自由模式约束] 禁止触发开局事件引导链与主线章节事件书。',Nt.value?'[异种线约束] 可出现认知滤镜叙事，但不得免除作战代价、污染风险与失败后果。':'[常规线约束] 按学院新生与前线支援逻辑推进。'].join('\n')}),kn=(0,a.computed)(()=>{if(!rn.value.length)return'';return`[记忆库]\n${rn.value.map(e=>`- 楼层${e.floorStart}-${e.floorEnd}: ${e.summary}`).join('\n')}`}),bn=(0,a.computed)(()=>[...rn.value].reverse()),Sn=(0,a.computed)(()=>[...on.value].reverse()),Dn=(0,a.ref)([{id:At.value++,role:'assistant',content:'已就绪。你可以直接输入行动。'}]),wn=(0,a.reactive)({hp:100,hpMax:100,mp:100,mpMax:100,ap:1}),xn=(e,t)=>Dn.value.push({id:At.value++,role:e,content:t}),Cn=e=>{const t=String(e??''),n=t.trim(),a=t.replace(/&lt;\/?think\b[^&]*&gt;/gim,e=>e.replace('&lt;','<').replace('&gt;','>')).replace(/&lt;\/?thinking\b[^&]*&gt;/gim,e=>e.replace('&lt;','<').replace('&gt;','>')).replace(/&lt;\/?reasoning\b[^&]*&gt;/gim,e=>e.replace('&lt;','<').replace('&gt;','>')).replace(/&lt;\/?content&gt;/gim,e=>e.replace('&lt;','<').replace('&gt;','>')),l=a.includes('</think>')?a.split('</think>').pop()??a:a,r=l.match(/<content>([\s\S]*?)<\/content>/im),o=(r?.[1]??l).replace(/<think[\s\S]*?<\/think>/gim,'').replace(/<Thought[\s\S]*?<\/Thought>/gim,'').replace(/<thinking[\s\S]*?<\/thinking>/gim,'').replace(/<reasoning[\s\S]*?<\/reasoning>/gim,'').replace(/```(?:think|thinking|reasoning|cot)[\s\S]*?```/gim,'').replace(/<(think|Thought|thinking|reasoning)\b[^>]*>[\s\S]*$/gim,'').replace(/<\/?content>/gim,'').trim(),s=l.replace(/<\/?content>/gim,'').replace(/<(think|Thought|thinking|reasoning)\b[^>]*>/gim,'').trim();return o||(s||(/<(think|Thought|thinking|reasoning)\b|```(?:think|thinking|reasoning|cot)/i.test(t)?'':n))},Mn=e=>'assistant'===e.role?Cn(e.content):e.content,An=e=>{_t.value=_t.value.filter(t=>t.id!==e)},Bn=e=>{const t=Date.now()+Math.floor(1e4*Math.random());_t.value.unshift({id:t,content:e}),_t.value=_t.value.slice(0,4),toastr.info(e,'同层卡'),setTimeout(()=>An(t),12e3)};let $n=null;const _n=e=>{Tt.active=!0,Tt.completed=!1,Tt.label=e,Tt.seconds=0,Ct.value=!0,$n&&clearInterval($n),$n=setInterval(()=>{Tt.seconds+=1},1e3)},Tn=()=>{$n&&(clearInterval($n),$n=null),Tt.completed=!0,Ct.value=!1,setTimeout(()=>{Tt.active=!1,Tt.completed=!1,Tt.label='',Tt.seconds=0},1500)},Pn=(0,a.computed)(()=>{const e=[0];for(let t=1;t<Dn.value.length;t++)'user'===Dn.value[t]?.role&&e.push(t);return e.map((t,n)=>({start:t,end:e[n+1]??Dn.value.length}))}),Un=(0,a.computed)(()=>{const e=Pn.value[Bt.value];return(e?Dn.value.slice(e.start,e.end):Dn.value).filter(e=>'system'!==e.role)});(0,a.watch)(()=>Dn.value.length,()=>{Pn.value.length&&nn.autoFlipPage&&(Bt.value=Pn.value.length-1)}),(0,a.watch)(()=>Rt.profession,e=>{const t=It[e];Et.value||(Rt.age<t.min&&(Rt.age=t.min),Rt.age>t.max&&(Rt.age=t.max)),'战姬'===e&&(Rt.gender='女')},{immediate:!0}),(0,a.watch)(()=>kt.value,()=>{if(Nt.value){if('再诞战姬'===kt.value)return Rt.profession='战姬',Rt.gender='女',void(Et.value||(Rt.age<12&&(Rt.age=12),Rt.age>18&&(Rt.age=18)));Rt.profession='指挥官',Et.value||(Rt.age<21&&(Rt.age=21),Rt.age>70&&(Rt.age=70))}}),(0,a.watch)(()=>Wt.value,e=>{zt.value=e},{immediate:!0}),(0,a.watch)(()=>Rt.background,e=>{(e||'').length>1e3&&(Rt.background=e.slice(0,1e3))}),(0,a.watch)(nn,()=>{localStorage.setItem(mt,JSON.stringify({...nn}))},{deep:!0}),(0,a.watch)([rn,on,sn,cn,un,()=>({...wn}),vn,yn,gn],()=>{In()},{deep:!0});const Fn=()=>{localStorage.setItem(mt,JSON.stringify({...nn})),Bn('设置已保存。')},In=()=>{localStorage.setItem(dt,JSON.stringify({memoryVault:rn.value,megaMemoryVault:on.value,onstageNpcs:sn.value,longtermNpcs:cn.value,inventoryItems:un.value,playerResource:{...wn},summaryLastFloor:vn.value,hiddenFloorUntil:yn.value,megaSummaryLastCount:gn.value}))},jn=()=>{Dn.value=[{id:1,role:'assistant',content:'会话已清空。'}],At.value=2,Bt.value=0,rn.value=[],on.value=[],sn.value=[],cn.value=[],un.value=[],en(),vn.value=0,yn.value=0,gn.value=0,In()},Ln=(e,t)=>{for(const n of t){const t=e?.[n];if('string'==typeof t&&t.trim())return t.trim()}return''},Rn=()=>{if(!pt.value)return $t.value='当前非酒馆环境',void xn('error','当前不在酒馆页面，无法读取酒馆配置。');try{const e=window.SillyTavern,t='function'==typeof getLoadedPresetName?getLoadedPresetName():'',n='function'==typeof getPreset?getPreset('in_use'):null,a=e?.chatCompletionSettings??{};nn.model=('function'==typeof e?.getChatCompletionModel?e.getChatCompletionModel():'')||nn.model,nn.baseUrl=Ln(a,['api_url','apiUrl','reverse_proxy','proxy_url','custom_url'])||nn.baseUrl,nn.apiKey=Ln(a,['api_key','apiKey','reverse_proxy_password'])||nn.apiKey,nn.useTavernPreset=!0,!1===n?.settings?.should_stream&&Bn('读取到当前预设关闭流式，界面仍可显示完整回复。'),$t.value=t?`当前预设: ${t}`:'已读取酒馆配置',Bn('已读取酒馆配置。'+(t?`预设: ${t}`:'')),Fn()}catch(e){$t.value='读取失败',xn('error',`读取酒馆配置失败: ${e?.message??String(e)}`)}},On=e=>{const t=e.trim().replace(/\/+$/,'');return t.endsWith('/chat/completions')?t:`${t}/chat/completions`},Kn=async()=>{const e=(e=>{const t=e.trim().replace(/\/+$/,'');return t?/\/chat\/completions$/i.test(t)?t.replace(/\/chat\/completions$/i,'/models'):/\/models$/i.test(t)?t:`${t}/models`:''})(nn.baseUrl);if(e){ln.value=!0;try{const t={};nn.apiKey?.trim()&&(t.Authorization=`Bearer ${nn.apiKey.trim()}`);const n=await fetch(e,{method:'GET',headers:t});if(!n.ok)throw new Error(`HTTP ${n.status}`);const a=(e=>{const t=(Array.isArray(e)?e:Array.isArray(e?.data)?e.data:Array.isArray(e?.models)?e.models:[]).map(e=>'string'==typeof e?e.trim():e&&'string'==typeof e.id?e.id.trim():e&&'string'==typeof e.name?e.name.trim():'').filter(Boolean);return Array.from(new Set(t)).sort((e,t)=>e.localeCompare(t,'zh-Hans-CN'))})(await n.json());if(!a.length)throw new Error('未解析到模型列表，请确认接口返回格式。');an.value=a,nn.model&&a.includes(nn.model)||(nn.model=a[0]),Bn(`模型信息读取成功，共 ${a.length} 个。`),Fn()}catch(e){xn('error',`读取模型信息失败: ${e?.message??String(e)}`)}finally{ln.value=!1}}else Bn('请先填写 Base URL。')},zn=()=>{const e=[],t=[nn.systemPrompt,Nn.value];kn.value&&t.push(kn.value),Vn.value&&t.push(Vn.value),yn.value>0&&t.push(`[上下文裁剪] 已隐藏楼层 1-${yn.value}，仅保留记忆库摘要与近期楼层。`),e.push({role:'system',content:t.filter(Boolean).join('\n\n')});for(const[t,n]of Pn.value.entries()){if(t>0&&t<=yn.value)continue;const a=Dn.value.slice(n.start,n.end);for(const t of a)'user'!==t.role&&'assistant'!==t.role||e.push({role:t.role,content:t.content})}return e},qn=e=>Cn(e).trim()||'[无可用文本]',Jn=async e=>{if(!e.useVarApi||!e.url.trim())return'';const t={'Content-Type':'application/json'};e.key.trim()&&(t.Authorization=`Bearer ${e.key.trim()}`);const n=e.payload.trim(),a=n?'POST':'GET',l=await fetch(e.url.trim(),{method:a,headers:t,body:'POST'===a?n:void 0});if(!l.ok)throw new Error(`变量API异常: HTTP ${l.status}`);const r=await l.text();return r.length>5e3?`${r.slice(0,5e3)}\n...(已截断)`:r},Hn=async(e,t)=>{if(t&&pt.value&&nn.useTavernPreset){const t=await generate({user_input:e,should_stream:!1,should_silence:!0});if(String(t??'').trim())return String(t).trim()}return(async e=>{if(!nn.baseUrl||!nn.model)throw new Error('大总结缺少 Base URL 或 Model。');const t={'Content-Type':'application/json'};nn.apiKey&&(t.Authorization=`Bearer ${nn.apiKey}`);const n=await fetch(On(nn.baseUrl),{method:'POST',headers:t,body:JSON.stringify({model:nn.model,stream:!1,messages:[{role:'system',content:'你是高压缩记忆总结器，必须忠实、简明、结构化。'},{role:'user',content:e}]})});if(!n.ok)throw new Error(`大总结请求失败: HTTP ${n.status}`);const a=await n.json();return String(a?.choices?.[0]?.message?.content??'').trim()})(e)},Gn=async(e=!1)=>{if(!nn.megaSummaryEnabled)return;const t=Math.max(1,Math.trunc(Number(nn.megaSummaryEvery)||5)),n=rn.value.length-gn.value;if(!e&&n<t)return;if(n<=0||!rn.value.length)return;let a='';try{a=await Jn({useVarApi:nn.megaSummaryUseVarApi,url:nn.megaSummaryVarApiUrl,key:nn.megaSummaryVarApiKey,payload:nn.megaSummaryVarApiPayload})}catch(e){Bn(`超大总结变量API读取失败，已忽略：${e?.message??String(e)}`)}const l=rn.value.map(e=>`楼层${e.floorStart}-${e.floorEnd}\n${e.summary}`).join('\n\n'),r=[nn.megaSummaryPrompt,`[触发规则] 每 ${t} 次大总结触发一次超大总结。当前累计大总结: ${rn.value.length}。`,'[已累计大总结内容]',l,a?`[额外变量API返回]\n${a}`:'','[输出要求] 使用中文项目符号，输出“世界稳定态/长期矛盾/关键关系网/下一阶段主目标”。'].filter(Boolean).join('\n\n'),o=await Hn(r,Boolean(nn.megaSummaryUseCurrentApi)),s=rn.value[0],i=rn.value[rn.value.length-1];on.value.push({id:Date.now()+Math.floor(1e4*Math.random()),floorStart:s?.floorStart??1,floorEnd:i?.floorEnd??yn.value,summary:o||'（超大总结返回空文本）',createdAt:Date.now(),extraVarNote:a?'已使用额外变量API':'未使用额外变量API'}),gn.value=rn.value.length,Bn('已生成超大总结。')},Xn=async(e,t)=>{const n=((e,t)=>{const n=[];for(let a=e;a<=t;a++){const e=Pn.value[a];if(!e)continue;const t=Dn.value.slice(e.start,e.end);n.push(`### 楼层 ${a}`);for(const e of t)'user'===e.role&&n.push(`玩家: ${e.content}`),'assistant'===e.role&&n.push(`AI: ${qn(e.content)}`)}return n.join('\n')})(e,t).trim();if(!n)return;let a='';try{a=await Jn({useVarApi:nn.summaryUseVarApi,url:nn.summaryVarApiUrl,key:nn.summaryVarApiKey,payload:nn.summaryVarApiPayload})}catch(e){Bn(`变量API读取失败，已忽略：${e?.message??String(e)}`)}const l=[nn.autoSummaryPrompt,`[总结范围] 楼层 ${e}-${t}`,'[角色建卡快照]',Nn.value,a?`[额外变量API返回]\n${a}`:'','[对话原文]',n,'[输出要求] 用中文输出，采用项目符号，必须包含“当前阶段建议动作”。'].filter(Boolean).join('\n\n'),r=await Hn(l,Boolean(nn.summaryUseCurrentApi))||'（自动大总结返回空文本）';rn.value.push({id:Date.now()+Math.floor(1e4*Math.random()),floorStart:e,floorEnd:t,summary:r,createdAt:Date.now(),extraVarNote:a?'已使用额外变量API':'未使用额外变量API'}),yn.value=t,vn.value=t,Bn(`已完成楼层 ${e}-${t} 大总结，并隐藏对应原始楼层。`),await Gn(!1)},Yn=async()=>{if(!nn.baseUrl||!nn.model)return void xn('error','请先填写 Base URL 和 Model。');const e={id:At.value++,role:'assistant',content:''};Dn.value.push(e);const t={'Content-Type':'application/json'};nn.apiKey&&(t.Authorization=`Bearer ${nn.apiKey}`);const n=await fetch(On(nn.baseUrl),{method:'POST',headers:t,body:JSON.stringify({model:nn.model,messages:zn(),stream:!0})});if(!n.ok)throw new Error(`HTTP ${n.status}: ${(await n.text()).slice(0,400)}`);const a=await(async(e,t)=>{const n=e.body?.getReader();if(!n)return!1;const a=new TextDecoder;let l='';for(;;){const{value:e,done:r}=await n.read();if(r)break;l+=a.decode(e,{stream:!0});const o=l.split(/\r?\n/);l=o.pop()??'';for(const e of o){const n=e.trim();if(!n.startsWith('data:'))continue;const a=n.slice(5).trim();if('[DONE]'===a)return!0;try{const e=JSON.parse(a),n=e?.choices?.[0]?.delta?.content;'string'==typeof n&&n&&t(n)}catch{}}}return!0})(n,t=>e.content+=t);if(!a){const t=await n.json();e.content=t?.choices?.[0]?.message?.content??'[无响应文本]'}e.content=Cn(e.content),e.content.trim()||(e.content='[模型未返回可显示文本]')},Wn=async()=>{xt.value=!0;try{pt.value&&nn.useTavernPreset?await(async()=>{const e={id:At.value++,role:'assistant',content:''};Dn.value.push(e);const t=[...Dn.value].reverse().find(e=>'user'===e.role),n=await generate({user_input:t?.content??'',should_stream:!0,should_silence:!0});e.content=Cn(n||'[无响应文本]')})():await Yn(),await(async()=>{if(!nn.autoSummaryEnabled||pn.value)return;const e=Math.max(1,Math.trunc(Number(nn.summaryFloorsPerRun)||5)),t=Math.max(0,Pn.value.length-1);if(t<e)return;const n=Math.floor(t/e)*e;if(!(n<=vn.value)){pn.value=!0,_n(`自动大总结（至楼层 ${n}）`);try{for(let t=vn.value+1;t<=n;t+=e){const a=Math.min(t+e-1,n);await Xn(t,a)}}catch(e){xn('error',`自动大总结失败: ${e?.message??String(e)}`)}finally{pn.value=!1,Tn()}}})()}catch(e){xn('error',`请求失败: ${e?.message??String(e)}`)}finally{xt.value=!1}},Qn=async()=>{const e=Mt.value.trim();e&&!hn.value&&(xn('user',e),Mt.value='',await Wn())},Zn=async e=>{hn.value||(xn('user',e),await Wn())},ea=e=>new Date(e).toLocaleString(),ta=()=>{rn.value=[],on.value=[],vn.value=0,yn.value=0,gn.value=0,Bn('记忆库已清空。')},na=async()=>{if(pn.value)return;const e=Math.max(0,Pn.value.length-1);if(e<=vn.value)return void Bn('当前没有可总结的新楼层。');const t=vn.value+1,n=e;pn.value=!0,_n(`大总结（楼层 ${t}-${n}）`);try{await Xn(t,n)}catch(e){xn('error',`手动大总结失败: ${e?.message??String(e)}`)}finally{pn.value=!1,Tn()}},aa=async()=>{if(!pn.value)if(nn.megaSummaryEnabled){pn.value=!0,_n('超大总结');try{await Gn(!0)}catch(e){xn('error',`手动超大总结失败: ${e?.message??String(e)}`)}finally{pn.value=!1,Tn()}}else Bn('超大总结当前已关闭，请先在设置中开启。')},la=()=>{const e=mn.name.trim();if(!e)return void Bn('请先填写NPC姓名。');const t=mn.toLongterm?cn.value:sn.value,n=t.find(t=>t.name===e),a={id:Date.now()+Math.floor(1e4*Math.random()),name:e,role:mn.role.trim()||'未知',relation:mn.relation.trim()||'未建立',status:mn.status.trim()||'稳定',tags:mn.tags.trim()||'无'};n?Object.assign(n,a,{id:n.id}):t.push(a),mn.name='',mn.role='',mn.relation='',mn.status='',mn.tags='',Bn((mn.toLongterm?'长期NPC':'在场角色')+'已更新。')},ra=(e,t)=>{'onstage'===t?sn.value=sn.value.filter(t=>t.id!==e):cn.value=cn.value.filter(t=>t.id!==e)},oa=()=>{if(!Et.value)return void Bn('标准模式下仓库为只读，开启作弊模式后才能写入。');const e=dn.name.trim();if(!e)return void Bn('请先填写物品名称。');const t=Math.max(1,Math.trunc(Number(dn.count)||1)),n=dn.note.trim(),a=un.value.find(t=>t.name===e);a?(a.count=t,a.note=n||a.note||'无'):un.value.push({id:Date.now()+Math.floor(1e4*Math.random()),name:e,count:t,note:n||'无'}),dn.name='',dn.count=1,dn.note='',Bn('仓库物品已更新。')},sa=()=>{gt.value=!0,ft.value=!1,ht.value=1,Rt.background='',zt.value=Wt.value,Bn('进入建卡界面。')},ia=()=>{Nt.value=!1,sa()},ca=()=>{Nt.value=!0,'再诞战姬'===kt.value?(Rt.profession='战姬',Rt.gender='女'):Rt.profession='指挥官',sa()},ua=()=>{if(!Rt.name.trim())return void Bn('请先填写姓名。');const e=It[Rt.profession];Number.isFinite(Rt.age)?Et.value||!(Rt.age<e.min||Rt.age>e.max)?('战姬'===Rt.profession&&(Rt.gender='女'),ht.value=2):Bn(`${Rt.profession}年龄需在${e.min}-${e.max}。`):Bn('请先填写年龄。')},ma=()=>{Et.value||0===Ht.value?ht.value=3:Bn(`属性点尚未分配完毕（剩余 ${Ht.value} 点）。`)},da=()=>{const e=Ot[zt.value]??'';e?(Rt.background=e.slice(0,1e3),Bn('已载入默认背景模板。')):Bn('当前模板为空。')},pa=()=>{3===ht.value?Et.value||0===Ht.value?(Rt.background||'').length>1e3?Bn('背景超过1000字，请先精简。'):(ft.value=!0,Dn.value=[{id:1,role:'assistant',content:Nt.value?'【异种开局 / 联合纪年177年8月28日】\n地点：异种巢穴外围的血肉层通道。\n你在一段破碎记忆后醒来，意识像被冰水浸透。高位异种个体将你自石棺牵出，你以异常视角开始接触异种线叙事。\n当你注视异种时，部分下级单位会出现“认知滤镜”显现偏移。\n这不代表无敌。你仍会受伤、会失误、会承担错误判断的后果。':'【联合纪年177年8月28日】\n你们是新一批威曼普学院的新生。\n根据【第二协议】中的对等条款，曾经在各地上中学的你们，在即将升到高中时，作为各地与威曼普学院的某种交换成为了对抗异种的中坚力量预备军。\n而好巧不巧的是，在你们接到入学通知的时候，异种在领主【咒妄】的率领下，突破了联合北部防线，斯托尔，夏顿两座边塞城市的沦陷，直接导致重要军事要塞光明大圣堂被完全包围。\n如果光明大圣堂沦陷，整个北部防线有被以点带面凿穿的风险，威曼普城同样根据【第二协议】的条款，派出了【海洋】【魔法支点】【学士】三个结社前往支援。\n而除了这些明面上的力量，新生也不可避免的被卷入了这场漩涡，正面战场也许很难帮得上忙，但是，繁杂的侦查，辅助，探索，清理少量异种的任务，还是不可避免的向你们袭来。\n而幸运与不幸的是，你们这支新成立的学员小队，恰巧成为了最前端的侦察小队，即将承接可能带来最丰厚报偿，也可能是送命的侦查任务……\n而今天，你来到了学校......'}],At.value=2,Bt.value=0,rn.value=[],on.value=[],sn.value=[],cn.value=[],un.value=[],en(),vn.value=0,yn.value=0,gn.value=0,Bn(`建卡完成：${Rt.name} / ${Rt.profession} / ${Rt.age}岁 / ${Rt.gender} / ${Nt.value?'异种开局':'常规开局'} / ${Vt.value?'剧情模式':'自由模式'} / 背景${Rt.background.length}字`)):Bn(`属性点尚未分配完毕（剩余 ${Ht.value} 点）。`):Bn('请先完成第3页背景设定。')},va=()=>document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement,ya=async()=>{const e=vt.value??document.documentElement,t=e.requestFullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen||e.msRequestFullscreen;'function'==typeof t&&await t.call(e)},ga=()=>{yt.value=Boolean(va())},fa=async()=>{try{va()?await(async()=>{const e=document,t=e.exitFullscreen||e.webkitExitFullscreen||e.mozCancelFullScreen||e.msExitFullscreen;'function'==typeof t&&await t.call(e)})():await ya(),ga()}catch(e){Bn(`全屏切换失败: ${e?.message??String(e)}`)}};return(0,a.onMounted)(()=>{(()=>{const e=localStorage.getItem(mt);if(e)try{Object.assign(nn,tn,JSON.parse(e)??{})}catch{Object.assign(nn,tn)}})(),(()=>{const e=localStorage.getItem(dt);if(e)try{const t=JSON.parse(e)??{};rn.value=Array.isArray(t.memoryVault)?t.memoryVault:[],on.value=Array.isArray(t.megaMemoryVault)?t.megaMemoryVault:[],sn.value=Array.isArray(t.onstageNpcs)?t.onstageNpcs:[],cn.value=Array.isArray(t.longtermNpcs)?t.longtermNpcs:[],un.value=Array.isArray(t.inventoryItems)?t.inventoryItems:[],Object.assign(wn,t.playerResource??{}),wn.hpMax=Math.max(1,Number(wn.hpMax)||100),wn.mpMax=Math.max(1,Number(wn.mpMax)||100),wn.hp=Math.max(0,Math.min(wn.hpMax,Number(wn.hp)||wn.hpMax)),wn.mp=Math.max(0,Math.min(wn.mpMax,Number(wn.mp)||wn.mpMax)),wn.ap=Math.max(0,Math.min(9,Number(wn.ap)||1)),vn.value=Number(t.summaryLastFloor)||0,yn.value=Number(t.hiddenFloorUntil)||0,gn.value=Number(t.megaSummaryLastCount)||0}catch{rn.value=[],on.value=[],sn.value=[],cn.value=[],un.value=[],en(),vn.value=0,yn.value=0,gn.value=0}})(),pt.value&&Rn(),'embedded'===t.mode&&(bt.value=!1),['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','MSFullscreenChange'].forEach(e=>{document.addEventListener(e,ga)})}),(0,a.onUnmounted)(()=>{$n&&(clearInterval($n),$n=null)}),(e,t)=>((0,a.openBlock)(),(0,a.createElementBlock)('main',{ref_key:'rootRef',ref:vt,class:'shell',onClick:t[55]||(t[55]=(0,a.withModifiers)(()=>{},['stop']))},[(0,a.unref)(gt)?(0,a.unref)(ft)||1!==(0,a.unref)(ht)?(0,a.unref)(ft)||2!==(0,a.unref)(ht)?(0,a.unref)(ft)||3!==(0,a.unref)(ht)?((0,a.openBlock)(),(0,a.createElementBlock)(a.Fragment,{key:4},[(0,a.createElementVNode)('header',L,[t[79]||(t[79]=(0,a.createElementVNode)('div',{class:'title'},[(0,a.createElementVNode)('h1',null,'天启黎明同层卡'),(0,a.createElementVNode)('p',null,'Ruina Style / Auto Paging / Tavern API Bridge')],-1)),(0,a.createElementVNode)('div',R,[(0,a.createElementVNode)('button',{type:'button',class:'ghost db-btn',onClick:t[13]||(t[13]=e=>St.value=!(0,a.unref)(St))},(0,a.toDisplayString)((0,a.unref)(St)?'独立数据库：已开':'独立数据库'),1),(0,a.createElementVNode)('button',{type:'button',class:'ghost',onClick:fa},(0,a.toDisplayString)((0,a.unref)(yt)?'退出全屏':'全屏'),1),(0,a.createElementVNode)('button',{type:'button',class:'ghost',onClick:t[14]||(t[14]=e=>bt.value=!(0,a.unref)(bt))},(0,a.toDisplayString)((0,a.unref)(bt)?'隐藏设置':'打开设置'),1)])]),(0,a.createElementVNode)('section',O,[(0,a.createElementVNode)('aside',K,[t[90]||(t[90]=(0,a.createElementVNode)('h3',null,'玩家档案',-1)),(0,a.createElementVNode)('dl',null,[(0,a.createElementVNode)('div',null,[t[80]||(t[80]=(0,a.createElementVNode)('dt',null,'名字',-1)),(0,a.createElementVNode)('dd',null,(0,a.toDisplayString)((0,a.unref)(Rt).name||'未命名'),1)]),(0,a.createElementVNode)('div',null,[t[81]||(t[81]=(0,a.createElementVNode)('dt',null,'性别',-1)),(0,a.createElementVNode)('dd',null,(0,a.toDisplayString)((0,a.unref)(Rt).gender),1)]),(0,a.createElementVNode)('div',null,[t[82]||(t[82]=(0,a.createElementVNode)('dt',null,'职业',-1)),(0,a.createElementVNode)('dd',null,(0,a.toDisplayString)((0,a.unref)(Rt).profession),1)]),(0,a.createElementVNode)('div',null,[t[83]||(t[83]=(0,a.createElementVNode)('dt',null,'路线',-1)),(0,a.createElementVNode)('dd',null,(0,a.toDisplayString)((0,a.unref)(Nt)?`异种开局/${(0,a.unref)(kt)}`:'常规开局'),1)]),(0,a.createElementVNode)('div',null,[t[84]||(t[84]=(0,a.createElementVNode)('dt',null,'模式',-1)),(0,a.createElementVNode)('dd',null,(0,a.toDisplayString)((0,a.unref)(Et)?'作弊模式':'标准模式'),1)]),(0,a.createElementVNode)('div',null,[t[85]||(t[85]=(0,a.createElementVNode)('dt',null,'叙事',-1)),(0,a.createElementVNode)('dd',null,(0,a.toDisplayString)((0,a.unref)(Vt)?'剧情模式':'自由模式'),1)]),(0,a.createElementVNode)('div',q,[t[86]||(t[86]=(0,a.createElementVNode)('dt',null,'人类属性',-1)),(0,a.createElementVNode)('dd',null,[((0,a.openBlock)(),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)(qt,e=>(0,a.createElementVNode)('span',{key:e.key,class:'attr-chip'},(0,a.toDisplayString)(e.key)+' '+(0,a.toDisplayString)((0,a.unref)(Jt)[e.key]),1)),64))])]),(0,a.createElementVNode)('div',J,[t[87]||(t[87]=(0,a.createElementVNode)('dt',null,'状态资源',-1)),(0,a.createElementVNode)('dd',null,[(0,a.createElementVNode)('span',H,'生命 '+(0,a.toDisplayString)((0,a.unref)(wn).hp)+'/'+(0,a.toDisplayString)((0,a.unref)(wn).hpMax),1),(0,a.createElementVNode)('span',G,'魔力 '+(0,a.toDisplayString)((0,a.unref)(wn).mp)+'/'+(0,a.toDisplayString)((0,a.unref)(wn).mpMax),1),(0,a.createElementVNode)('span',X,'行动点 '+(0,a.toDisplayString)((0,a.unref)(wn).ap),1)])]),(0,a.createElementVNode)('div',null,[t[88]||(t[88]=(0,a.createElementVNode)('dt',null,'背景摘要',-1)),(0,a.createElementVNode)('dd',null,(0,a.toDisplayString)((0,a.unref)(Zt)),1)])]),(0,a.createElementVNode)('section',Y,[(0,a.createElementVNode)('div',W,[t[89]||(t[89]=(0,a.createElementVNode)('h4',null,'仓库',-1)),(0,a.createElementVNode)('button',{type:'button',class:'ghost small',onClick:t[15]||(t[15]=e=>Dt.value=!(0,a.unref)(Dt))},(0,a.toDisplayString)((0,a.unref)(Dt)?'收起仓库':'展开仓库'),1)]),(0,a.unref)(Dt)?((0,a.openBlock)(),(0,a.createElementBlock)(a.Fragment,{key:0},[(0,a.unref)(Et)?((0,a.openBlock)(),(0,a.createElementBlock)('div',Q,[(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[16]||(t[16]=e=>(0,a.unref)(dn).name=e),placeholder:'物品名称'},null,512),[[a.vModelText,(0,a.unref)(dn).name,void 0,{trim:!0}]]),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[17]||(t[17]=e=>(0,a.unref)(dn).count=e),type:'number',min:'1',placeholder:'数量'},null,512),[[a.vModelText,(0,a.unref)(dn).count,void 0,{number:!0}]]),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[18]||(t[18]=e=>(0,a.unref)(dn).note=e),placeholder:'备注（可选）'},null,512),[[a.vModelText,(0,a.unref)(dn).note,void 0,{trim:!0}]]),(0,a.createElementVNode)('button',{type:'button',class:'ghost small',onClick:oa},'写入仓库')])):((0,a.openBlock)(),(0,a.createElementBlock)('p',Z,'当前为标准模式，仓库只读。开启作弊模式后可编辑仓库。')),((0,a.openBlock)(!0),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)((0,a.unref)(un),e=>((0,a.openBlock)(),(0,a.createElementBlock)('article',{key:e.id,class:'inventory-item'},[(0,a.createElementVNode)('header',null,[(0,a.createElementVNode)('strong',null,(0,a.toDisplayString)(e.name)+' ×'+(0,a.toDisplayString)(e.count),1),(0,a.unref)(Et)?((0,a.openBlock)(),(0,a.createElementBlock)('button',{key:0,type:'button',class:'ghost small',onClick:t=>{return n=e.id,void(Et.value?un.value=un.value.filter(e=>e.id!==n):Bn('标准模式下仓库为只读，开启作弊模式后才能删除。'));var n}},'删除',8,ee)):(0,a.createCommentVNode)('v-if',!0)]),(0,a.createElementVNode)('p',null,'备注：'+(0,a.toDisplayString)(e.note),1)]))),128)),(0,a.unref)(un).length?(0,a.createCommentVNode)('v-if',!0):((0,a.openBlock)(),(0,a.createElementBlock)('p',te,'暂无物品'))],64)):(0,a.createCommentVNode)('v-if',!0)])]),(0,a.createElementVNode)('div',ne,[(0,a.createElementVNode)('section',ae,[(0,a.createElementVNode)('div',le,[(0,a.createElementVNode)('button',{type:'button',class:'ghost',disabled:(0,a.unref)(Bt)<=0,onClick:t[19]||(t[19]=e=>Bt.value--)},'上一页',8,re),(0,a.createElementVNode)('span',oe,'第 '+(0,a.toDisplayString)((0,a.unref)(Bt)+1)+' / '+(0,a.toDisplayString)((0,a.unref)(Pn).length)+' 页',1),(0,a.createElementVNode)('button',{type:'button',class:'ghost',disabled:(0,a.unref)(Bt)>=(0,a.unref)(Pn).length-1,onClick:t[20]||(t[20]=e=>Bt.value++)},' 下一页 ',8,se)]),(0,a.createElementVNode)('label',ie,[(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[21]||(t[21]=e=>(0,a.unref)(nn).autoFlipPage=e),type:'checkbox'},null,512),[[a.vModelCheckbox,(0,a.unref)(nn).autoFlipPage]]),t[91]||(t[91]=(0,a.createElementVNode)('span',null,'每次新对话自动翻到最新页',-1))])]),(0,a.unref)(bt)?((0,a.openBlock)(),(0,a.createElementBlock)('section',ce,[(0,a.createElementVNode)('div',ue,[(0,a.createElementVNode)('button',{type:'button',onClick:Rn},'读取酒馆预设/API'),(0,a.createElementVNode)('span',me,(0,a.toDisplayString)((0,a.unref)($t)),1)]),(0,a.createElementVNode)('label',de,[(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[22]||(t[22]=e=>(0,a.unref)(nn).useTavernPreset=e),type:'checkbox'},null,512),[[a.vModelCheckbox,(0,a.unref)(nn).useTavernPreset]]),t[92]||(t[92]=(0,a.createElementVNode)('span',null,'优先使用酒馆预设生成',-1))]),(0,a.createElementVNode)('label',null,[t[93]||(t[93]=(0,a.createElementVNode)('span',null,'Base URL',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[23]||(t[23]=e=>(0,a.unref)(nn).baseUrl=e),placeholder:'https://api.openai.com/v1'},null,512),[[a.vModelText,(0,a.unref)(nn).baseUrl,void 0,{trim:!0}]])]),(0,a.createElementVNode)('label',null,[t[94]||(t[94]=(0,a.createElementVNode)('span',null,'API Key',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[24]||(t[24]=e=>(0,a.unref)(nn).apiKey=e),type:'password',placeholder:'sk-...'},null,512),[[a.vModelText,(0,a.unref)(nn).apiKey,void 0,{trim:!0}]])]),(0,a.createElementVNode)('label',null,[t[95]||(t[95]=(0,a.createElementVNode)('span',null,'Model',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[25]||(t[25]=e=>(0,a.unref)(nn).model=e),list:'th-model-options',placeholder:'gpt-4.1-mini'},null,512),[[a.vModelText,(0,a.unref)(nn).model,void 0,{trim:!0}]]),(0,a.createElementVNode)('datalist',pe,[((0,a.openBlock)(!0),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)((0,a.unref)(an),e=>((0,a.openBlock)(),(0,a.createElementBlock)('option',{key:e,value:e},(0,a.toDisplayString)(e),9,ve))),128))])]),(0,a.createElementVNode)('div',ye,[(0,a.createElementVNode)('button',{type:'button',class:'ghost small',disabled:(0,a.unref)(ln),onClick:Kn},(0,a.toDisplayString)((0,a.unref)(ln)?'读取中...':'读取模型列表'),9,ge),(0,a.createElementVNode)('span',fe,(0,a.toDisplayString)((0,a.unref)(an).length?`已加载 ${(0,a.unref)(an).length} 个模型`:'填写URL和秘钥后可读取模型信息'),1)]),(0,a.createElementVNode)('label',null,[t[96]||(t[96]=(0,a.createElementVNode)('span',null,'System Prompt',-1)),(0,a.withDirectives)((0,a.createElementVNode)('textarea',{'onUpdate:modelValue':t[26]||(t[26]=e=>(0,a.unref)(nn).systemPrompt=e),rows:'3'},null,512),[[a.vModelText,(0,a.unref)(nn).systemPrompt]])]),(0,a.createElementVNode)('label',he,[(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[27]||(t[27]=e=>(0,a.unref)(nn).autoSummaryEnabled=e),type:'checkbox'},null,512),[[a.vModelCheckbox,(0,a.unref)(nn).autoSummaryEnabled]]),t[97]||(t[97]=(0,a.createElementVNode)('span',null,'开启自动大总结（每 5 层触发）',-1))]),(0,a.createElementVNode)('label',null,[t[98]||(t[98]=(0,a.createElementVNode)('span',null,'每几层触发一次大总结',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[28]||(t[28]=e=>(0,a.unref)(nn).summaryFloorsPerRun=e),type:'number',min:'1'},null,512),[[a.vModelText,(0,a.unref)(nn).summaryFloorsPerRun,void 0,{number:!0}]])]),(0,a.createElementVNode)('label',Ee,[(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[29]||(t[29]=e=>(0,a.unref)(nn).summaryUseCurrentApi=e),type:'checkbox'},null,512),[[a.vModelCheckbox,(0,a.unref)(nn).summaryUseCurrentApi]]),t[99]||(t[99]=(0,a.createElementVNode)('span',null,'大总结优先使用当前酒馆API',-1))]),(0,a.createElementVNode)('label',Ve,[t[100]||(t[100]=(0,a.createElementVNode)('span',null,'大总结提示词',-1)),(0,a.withDirectives)((0,a.createElementVNode)('textarea',{'onUpdate:modelValue':t[30]||(t[30]=e=>(0,a.unref)(nn).autoSummaryPrompt=e),rows:'4'},null,512),[[a.vModelText,(0,a.unref)(nn).autoSummaryPrompt]])]),(0,a.createElementVNode)('label',Ne,[(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[31]||(t[31]=e=>(0,a.unref)(nn).summaryUseVarApi=e),type:'checkbox'},null,512),[[a.vModelCheckbox,(0,a.unref)(nn).summaryUseVarApi]]),t[101]||(t[101]=(0,a.createElementVNode)('span',null,'大总结使用额外变量API',-1))]),(0,a.createElementVNode)('label',null,[t[102]||(t[102]=(0,a.createElementVNode)('span',null,'变量API URL',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[32]||(t[32]=e=>(0,a.unref)(nn).summaryVarApiUrl=e),placeholder:'https://your-api/vars'},null,512),[[a.vModelText,(0,a.unref)(nn).summaryVarApiUrl,void 0,{trim:!0}]])]),(0,a.createElementVNode)('label',null,[t[103]||(t[103]=(0,a.createElementVNode)('span',null,'变量API Key',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[33]||(t[33]=e=>(0,a.unref)(nn).summaryVarApiKey=e),type:'password',placeholder:'Bearer Token'},null,512),[[a.vModelText,(0,a.unref)(nn).summaryVarApiKey,void 0,{trim:!0}]])]),(0,a.createElementVNode)('label',ke,[t[104]||(t[104]=(0,a.createElementVNode)('span',null,'变量API请求体（JSON，可空）',-1)),(0,a.withDirectives)((0,a.createElementVNode)('textarea',{'onUpdate:modelValue':t[34]||(t[34]=e=>(0,a.unref)(nn).summaryVarApiPayload=e),rows:'3'},null,512),[[a.vModelText,(0,a.unref)(nn).summaryVarApiPayload]])]),(0,a.createElementVNode)('label',be,[(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[35]||(t[35]=e=>(0,a.unref)(nn).megaSummaryEnabled=e),type:'checkbox'},null,512),[[a.vModelCheckbox,(0,a.unref)(nn).megaSummaryEnabled]]),t[105]||(t[105]=(0,a.createElementVNode)('span',null,'开启超大总结',-1))]),(0,a.createElementVNode)('label',null,[t[106]||(t[106]=(0,a.createElementVNode)('span',null,'每几次大总结触发一次超大总结',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[36]||(t[36]=e=>(0,a.unref)(nn).megaSummaryEvery=e),type:'number',min:'1'},null,512),[[a.vModelText,(0,a.unref)(nn).megaSummaryEvery,void 0,{number:!0}]])]),(0,a.createElementVNode)('label',Se,[(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[37]||(t[37]=e=>(0,a.unref)(nn).megaSummaryUseCurrentApi=e),type:'checkbox'},null,512),[[a.vModelCheckbox,(0,a.unref)(nn).megaSummaryUseCurrentApi]]),t[107]||(t[107]=(0,a.createElementVNode)('span',null,'超大总结优先使用当前酒馆API',-1))]),(0,a.createElementVNode)('label',De,[t[108]||(t[108]=(0,a.createElementVNode)('span',null,'超大总结提示词',-1)),(0,a.withDirectives)((0,a.createElementVNode)('textarea',{'onUpdate:modelValue':t[38]||(t[38]=e=>(0,a.unref)(nn).megaSummaryPrompt=e),rows:'4'},null,512),[[a.vModelText,(0,a.unref)(nn).megaSummaryPrompt]])]),(0,a.createElementVNode)('label',we,[(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[39]||(t[39]=e=>(0,a.unref)(nn).megaSummaryUseVarApi=e),type:'checkbox'},null,512),[[a.vModelCheckbox,(0,a.unref)(nn).megaSummaryUseVarApi]]),t[109]||(t[109]=(0,a.createElementVNode)('span',null,'超大总结使用独立变量API',-1))]),(0,a.createElementVNode)('label',null,[t[110]||(t[110]=(0,a.createElementVNode)('span',null,'超大总结变量API URL',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[40]||(t[40]=e=>(0,a.unref)(nn).megaSummaryVarApiUrl=e),placeholder:'https://your-api/mega-vars'},null,512),[[a.vModelText,(0,a.unref)(nn).megaSummaryVarApiUrl,void 0,{trim:!0}]])]),(0,a.createElementVNode)('label',null,[t[111]||(t[111]=(0,a.createElementVNode)('span',null,'超大总结变量API Key',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[41]||(t[41]=e=>(0,a.unref)(nn).megaSummaryVarApiKey=e),type:'password',placeholder:'Bearer Token'},null,512),[[a.vModelText,(0,a.unref)(nn).megaSummaryVarApiKey,void 0,{trim:!0}]])]),(0,a.createElementVNode)('label',xe,[t[112]||(t[112]=(0,a.createElementVNode)('span',null,'超大总结变量API请求体（JSON，可空）',-1)),(0,a.withDirectives)((0,a.createElementVNode)('textarea',{'onUpdate:modelValue':t[42]||(t[42]=e=>(0,a.unref)(nn).megaSummaryVarApiPayload=e),rows:'3'},null,512),[[a.vModelText,(0,a.unref)(nn).megaSummaryVarApiPayload]])]),(0,a.createElementVNode)('div',Ce,[(0,a.createElementVNode)('button',{type:'button',onClick:Fn},'保存设置'),(0,a.createElementVNode)('button',{type:'button',class:'ghost',onClick:jn},'清空会话'),(0,a.createElementVNode)('button',{type:'button',class:'ghost',onClick:t[43]||(t[43]=e=>St.value=!(0,a.unref)(St))},(0,a.toDisplayString)((0,a.unref)(St)?'隐藏大总结中心':'打开大总结中心'),1)])])):(0,a.createCommentVNode)('v-if',!0),(0,a.unref)(St)?((0,a.openBlock)(),(0,a.createElementBlock)('section',Me,[(0,a.createElementVNode)('div',Ae,[t[113]||(t[113]=(0,a.createElementVNode)('strong',null,'记忆库',-1)),(0,a.createElementVNode)('span',Be,'已收录 '+(0,a.toDisplayString)((0,a.unref)(rn).length)+' 条，已隐藏至楼层 '+(0,a.toDisplayString)((0,a.unref)(yn)),1)]),(0,a.createElementVNode)('div',$e,[(0,a.createElementVNode)('button',{type:'button',class:'ghost',disabled:(0,a.unref)(pn)||(0,a.unref)(xt),onClick:na},(0,a.toDisplayString)((0,a.unref)(pn)?'总结中...':'立即大总结'),9,_e),(0,a.createElementVNode)('button',{type:'button',class:'ghost',disabled:(0,a.unref)(pn)||(0,a.unref)(xt),onClick:aa},(0,a.toDisplayString)((0,a.unref)(pn)?'总结中...':'立即超大总结'),9,Te),(0,a.createElementVNode)('button',{type:'button',class:'ghost',onClick:ta},'清空记忆库')]),((0,a.openBlock)(!0),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)((0,a.unref)(bn),e=>((0,a.openBlock)(),(0,a.createElementBlock)('article',{key:e.id,class:'memory-item'},[(0,a.createElementVNode)('header',null,[(0,a.createElementVNode)('strong',null,'楼层 '+(0,a.toDisplayString)(e.floorStart)+' - '+(0,a.toDisplayString)(e.floorEnd),1),(0,a.createElementVNode)('span',Pe,(0,a.toDisplayString)(ea(e.createdAt))+' / '+(0,a.toDisplayString)(e.extraVarNote),1)]),(0,a.createElementVNode)('pre',null,(0,a.toDisplayString)(e.summary),1)]))),128)),(0,a.unref)(rn).length?(0,a.createCommentVNode)('v-if',!0):((0,a.openBlock)(),(0,a.createElementBlock)('p',Ue,'暂无记忆。到第 '+(0,a.toDisplayString)((0,a.unref)(nn).summaryFloorsPerRun)+' 层周期会自动生成并压缩历史上下文。',1)),(0,a.createElementVNode)('div',Fe,[t[114]||(t[114]=(0,a.createElementVNode)('strong',null,'超大总结库',-1)),(0,a.createElementVNode)('span',Ie,'已生成 '+(0,a.toDisplayString)((0,a.unref)(on).length)+' 条',1)]),((0,a.openBlock)(!0),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)((0,a.unref)(Sn),e=>((0,a.openBlock)(),(0,a.createElementBlock)('article',{key:e.id,class:'memory-item mega'},[(0,a.createElementVNode)('header',null,[(0,a.createElementVNode)('strong',null,'超大总结（覆盖楼层 '+(0,a.toDisplayString)(e.floorStart)+' - '+(0,a.toDisplayString)(e.floorEnd)+'）',1),(0,a.createElementVNode)('span',je,(0,a.toDisplayString)(ea(e.createdAt))+' / '+(0,a.toDisplayString)(e.extraVarNote),1)]),(0,a.createElementVNode)('pre',null,(0,a.toDisplayString)(e.summary),1)]))),128))])):(0,a.createCommentVNode)('v-if',!0),(0,a.createElementVNode)('section',Le,[(0,a.createElementVNode)('button',{type:'button',disabled:(0,a.unref)(hn),onClick:t[44]||(t[44]=e=>Zn('我选择探索当前区域，给我三个可选行动。'))},'探索',8,Re),(0,a.createElementVNode)('button',{type:'button',disabled:(0,a.unref)(hn),onClick:t[45]||(t[45]=e=>Zn('我选择休整，恢复状态并给出后续风险。'))},'休整',8,Oe),(0,a.createElementVNode)('button',{type:'button',disabled:(0,a.unref)(hn),onClick:t[46]||(t[46]=e=>Zn('我选择推进主线，给出当前遭遇与判定。'))},'推进',8,Ke)]),(0,a.createElementVNode)('section',ze,[(0,a.createElementVNode)('div',qe,[((0,a.openBlock)(!0),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)((0,a.unref)(Un),e=>{return(0,a.openBlock)(),(0,a.createElementBlock)('article',{key:e.id,class:(0,a.normalizeClass)(['msg',`msg--${e.role}`])},[(0,a.createElementVNode)('header',null,(0,a.toDisplayString)((t=e.role,'user'===t?'玩家':'assistant'===t?'AI':'error'===t?'错误':'系统')),1),(0,a.createElementVNode)('pre',null,(0,a.toDisplayString)(Mn(e)),1)],2);var t}),128))]),(0,a.createElementVNode)('form',{class:'composer',onSubmit:(0,a.withModifiers)(Qn,['prevent'])},[(0,a.withDirectives)((0,a.createElementVNode)('textarea',{'onUpdate:modelValue':t[47]||(t[47]=e=>(0,a.isRef)(Mt)?Mt.value=e:null),rows:'3',disabled:(0,a.unref)(hn),placeholder:'输入行动。每次发送可自动翻到最新页。'},null,8,Je),[[a.vModelText,(0,a.unref)(Mt)]]),(0,a.createElementVNode)('div',He,[(0,a.createElementVNode)('span',Ge,(0,a.toDisplayString)((0,a.unref)(hn)?(0,a.unref)(fn):(0,a.unref)(n)),1),(0,a.createElementVNode)('button',{type:'submit',disabled:(0,a.unref)(hn)||!(0,a.unref)(Mt).trim()},'发送',8,Xe)])],32)]),(0,a.createElementVNode)('section',Ye,[(0,a.createElementVNode)('div',We,[t[115]||(t[115]=(0,a.createElementVNode)('strong',null,'NPC状态栏',-1)),(0,a.createElementVNode)('span',Qe,'在场角色 '+(0,a.toDisplayString)((0,a.unref)(sn).length)+' / 长期NPC '+(0,a.toDisplayString)((0,a.unref)(cn).length),1),(0,a.createElementVNode)('button',{type:'button',class:'ghost small',onClick:t[48]||(t[48]=e=>wt.value=!(0,a.unref)(wt))},(0,a.toDisplayString)((0,a.unref)(wt)?'收起NPC栏':'展开NPC栏'),1)]),(0,a.unref)(wt)?((0,a.openBlock)(),(0,a.createElementBlock)(a.Fragment,{key:0},[(0,a.createElementVNode)('div',Ze,[(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[49]||(t[49]=e=>(0,a.unref)(mn).name=e),placeholder:'NPC姓名'},null,512),[[a.vModelText,(0,a.unref)(mn).name,void 0,{trim:!0}]]),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[50]||(t[50]=e=>(0,a.unref)(mn).role=e),placeholder:'定位（例：战姬/教官）'},null,512),[[a.vModelText,(0,a.unref)(mn).role,void 0,{trim:!0}]]),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[51]||(t[51]=e=>(0,a.unref)(mn).relation=e),placeholder:'关系（例：信任/敌对）'},null,512),[[a.vModelText,(0,a.unref)(mn).relation,void 0,{trim:!0}]]),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[52]||(t[52]=e=>(0,a.unref)(mn).status=e),placeholder:'状态（例：待命/受伤）'},null,512),[[a.vModelText,(0,a.unref)(mn).status,void 0,{trim:!0}]]),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[53]||(t[53]=e=>(0,a.unref)(mn).tags=e),placeholder:'关系标签（/分隔）'},null,512),[[a.vModelText,(0,a.unref)(mn).tags,void 0,{trim:!0}]]),(0,a.createElementVNode)('label',et,[(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[54]||(t[54]=e=>(0,a.unref)(mn).toLongterm=e),type:'checkbox'},null,512),[[a.vModelCheckbox,(0,a.unref)(mn).toLongterm]]),t[116]||(t[116]=(0,a.createElementVNode)('span',null,'写入长期NPC',-1))]),(0,a.createElementVNode)('button',{type:'button',class:'ghost',onClick:la},'写入NPC栏')]),(0,a.createElementVNode)('div',tt,[(0,a.createElementVNode)('section',null,[t[117]||(t[117]=(0,a.createElementVNode)('h4',null,'当前在场角色',-1)),((0,a.openBlock)(!0),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)((0,a.unref)(sn),e=>((0,a.openBlock)(),(0,a.createElementBlock)('article',{key:e.id,class:'npc-card'},[(0,a.createElementVNode)('header',null,[(0,a.createElementVNode)('strong',null,(0,a.toDisplayString)(e.name),1),(0,a.createElementVNode)('button',{type:'button',class:'ghost small',onClick:t=>ra(e.id,'onstage')},'删除',8,nt)]),(0,a.createElementVNode)('p',null,'定位：'+(0,a.toDisplayString)(e.role),1),(0,a.createElementVNode)('p',null,'关系：'+(0,a.toDisplayString)(e.relation),1),(0,a.createElementVNode)('p',null,'状态：'+(0,a.toDisplayString)(e.status),1),(0,a.createElementVNode)('p',null,'标签：'+(0,a.toDisplayString)(e.tags),1)]))),128)),(0,a.unref)(sn).length?(0,a.createCommentVNode)('v-if',!0):((0,a.openBlock)(),(0,a.createElementBlock)('p',at,'暂无在场角色'))]),(0,a.createElementVNode)('section',null,[t[118]||(t[118]=(0,a.createElementVNode)('h4',null,'长期NPC列表',-1)),((0,a.openBlock)(!0),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)((0,a.unref)(cn),e=>((0,a.openBlock)(),(0,a.createElementBlock)('article',{key:e.id,class:'npc-card'},[(0,a.createElementVNode)('header',null,[(0,a.createElementVNode)('strong',null,(0,a.toDisplayString)(e.name),1),(0,a.createElementVNode)('button',{type:'button',class:'ghost small',onClick:t=>ra(e.id,'longterm')},'删除',8,lt)]),(0,a.createElementVNode)('p',null,'定位：'+(0,a.toDisplayString)(e.role),1),(0,a.createElementVNode)('p',null,'关系：'+(0,a.toDisplayString)(e.relation),1),(0,a.createElementVNode)('p',null,'状态：'+(0,a.toDisplayString)(e.status),1),(0,a.createElementVNode)('p',null,'标签：'+(0,a.toDisplayString)(e.tags),1)]))),128)),(0,a.unref)(cn).length?(0,a.createCommentVNode)('v-if',!0):((0,a.openBlock)(),(0,a.createElementBlock)('p',rt,'暂无长期NPC'))])])],64)):(0,a.createCommentVNode)('v-if',!0)])])])],64)):((0,a.openBlock)(),(0,a.createElementBlock)('section',B,[t[77]||(t[77]=(0,a.createElementVNode)('h2',null,'建卡 - 第3页（背景设定）',-1)),t[78]||(t[78]=(0,a.createElementVNode)('p',{class:'hint'},'可填写最多1000字背景。背景会进入变量提示并影响训练判定与叙事约束。',-1)),(0,a.createElementVNode)('label',null,[t[75]||(t[75]=(0,a.createElementVNode)('span',null,'默认背景模板',-1)),(0,a.withDirectives)((0,a.createElementVNode)('select',{'onUpdate:modelValue':t[10]||(t[10]=e=>(0,a.isRef)(zt)?zt.value=e:null)},[((0,a.openBlock)(),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)(Kt,e=>(0,a.createElementVNode)('option',{key:e.key,value:e.key},(0,a.toDisplayString)(e.label),9,T)),64))],512),[[a.vModelSelect,(0,a.unref)(zt)]])]),(0,a.createElementVNode)('div',P,[(0,a.createElementVNode)('button',{type:'button',class:'ghost',onClick:da},'载入模板到背景文本'),(0,a.createElementVNode)('span',U,'当前模板：'+(0,a.toDisplayString)((0,a.unref)(Qt)),1)]),(0,a.createElementVNode)('label',F,[t[76]||(t[76]=(0,a.createElementVNode)('span',null,'角色背景（0-1000字）',-1)),(0,a.withDirectives)((0,a.createElementVNode)('textarea',{'onUpdate:modelValue':t[11]||(t[11]=e=>(0,a.unref)(Rt).background=e),rows:'12',maxlength:'1000',placeholder:'写下你的身世、经历、受训情况、入学动机等。'},null,512),[[a.vModelText,(0,a.unref)(Rt).background]])]),(0,a.createElementVNode)('p',I,'已输入 '+(0,a.toDisplayString)((0,a.unref)(Rt).background.length)+'/1000',1),(0,a.createElementVNode)('div',j,[(0,a.createElementVNode)('button',{type:'button',class:'ghost',onClick:t[12]||(t[12]=e=>ht.value=2)},'上一步'),(0,a.createElementVNode)('button',{type:'button',onClick:pa},'进入主界面')])])):((0,a.openBlock)(),(0,a.createElementBlock)('section',S,[t[73]||(t[73]=(0,a.createElementVNode)('h2',null,'建卡 - 第2页（属性分配）',-1)),t[74]||(t[74]=(0,a.createElementVNode)('p',{class:'hint'},'初始属性均为 1，自由分配 5 点。人类属性上限为 5。',-1)),(0,a.createElementVNode)('p',D,'剩余可分配点数：'+(0,a.toDisplayString)((0,a.unref)(Ht)),1),(0,a.createElementVNode)('section',w,[((0,a.openBlock)(),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)(qt,e=>(0,a.createElementVNode)('article',{key:e.key,class:'attr-item'},[(0,a.createElementVNode)('header',null,[(0,a.createElementVNode)('strong',null,(0,a.toDisplayString)(e.key),1),(0,a.createElementVNode)('span',null,(0,a.toDisplayString)(e.desc),1)]),(0,a.createElementVNode)('div',x,[(0,a.createElementVNode)('button',{type:'button',class:'ghost',disabled:(0,a.unref)(Jt)[e.key]<=1,onClick:t=>{return n=e.key,void(Jt[n]<=1||(Jt[n]-=1));var n}},'-',8,C),(0,a.createElementVNode)('b',null,(0,a.toDisplayString)((0,a.unref)(Jt)[e.key]),1),(0,a.createElementVNode)('button',{type:'button',disabled:(0,a.unref)(Ht)<=0||(0,a.unref)(Jt)[e.key]>=5,onClick:t=>{return n=e.key,void(Ht.value<=0||Jt[n]>=5||(Jt[n]+=1));var n}},'+',8,M)])])),64))]),(0,a.createElementVNode)('div',A,[(0,a.createElementVNode)('button',{type:'button',class:'ghost',onClick:t[9]||(t[9]=e=>ht.value=1)},'上一步'),(0,a.createElementVNode)('button',{type:'button',onClick:ma},'下一步')])])):((0,a.openBlock)(),(0,a.createElementBlock)('section',u,[t[72]||(t[72]=(0,a.createElementVNode)('h2',null,'建卡 - 第1页',-1)),(0,a.createElementVNode)('label',null,[t[62]||(t[62]=(0,a.createElementVNode)('span',null,'姓名',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[2]||(t[2]=e=>(0,a.unref)(Rt).name=e),placeholder:'请输入角色姓名'},null,512),[[a.vModelText,(0,a.unref)(Rt).name,void 0,{trim:!0}]])]),(0,a.createElementVNode)('label',null,[t[63]||(t[63]=(0,a.createElementVNode)('span',null,'职业类别',-1)),(0,a.withDirectives)((0,a.createElementVNode)('select',{'onUpdate:modelValue':t[3]||(t[3]=e=>(0,a.unref)(Rt).profession=e),disabled:(0,a.unref)(Nt)},[((0,a.openBlock)(),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)(Pt,e=>(0,a.createElementVNode)('option',{key:e,value:e},(0,a.toDisplayString)(e),9,d)),64))],8,m),[[a.vModelSelect,(0,a.unref)(Rt).profession]])]),(0,a.unref)(Nt)?((0,a.openBlock)(),(0,a.createElementBlock)('section',p,[t[66]||(t[66]=(0,a.createElementVNode)('p',null,'异种开局身份（本地化重写）',-1)),(0,a.createElementVNode)('label',null,[t[65]||(t[65]=(0,a.createElementVNode)('span',null,'身份类别',-1)),(0,a.withDirectives)((0,a.createElementVNode)('select',{'onUpdate:modelValue':t[4]||(t[4]=e=>(0,a.isRef)(kt)?kt.value=e:null)},[...t[64]||(t[64]=[(0,a.createElementVNode)('option',{value:'再诞战姬'},'再诞战姬（高位格战斗个体）',-1),(0,a.createElementVNode)('option',{value:'异种指挥官'},'异种指挥官（高位格指挥个体）',-1)])],512),[[a.vModelSelect,(0,a.unref)(kt)]])]),t[67]||(t[67]=(0,a.createElementVNode)('p',{class:'hint'},'该路线会增强“异种认知滤镜”叙事权重，但不会取消风险与代价。',-1))])):(0,a.createCommentVNode)('v-if',!0),(0,a.createElementVNode)('label',v,[t[68]||(t[68]=(0,a.createElementVNode)('span',null,'职业说明（世界书原文）',-1)),(0,a.createElementVNode)('textarea',{value:(0,a.unref)(Xt),rows:'9',readonly:''},null,8,y)]),(0,a.createElementVNode)('label',null,[(0,a.createElementVNode)('span',null,'年龄（'+(0,a.toDisplayString)((0,a.unref)(Gt).min)+'-'+(0,a.toDisplayString)((0,a.unref)(Gt).max)+'）',1),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':t[5]||(t[5]=e=>(0,a.unref)(Rt).age=e),type:'number',min:(0,a.unref)(Gt).min,max:(0,a.unref)(Gt).max,placeholder:'请输入年龄'},null,8,g),[[a.vModelText,(0,a.unref)(Rt).age,void 0,{number:!0}]])]),(0,a.createElementVNode)('label',null,[t[69]||(t[69]=(0,a.createElementVNode)('span',null,'性别',-1)),(0,a.withDirectives)((0,a.createElementVNode)('select',{'onUpdate:modelValue':t[6]||(t[6]=e=>(0,a.unref)(Rt).gender=e),disabled:'战姬'===(0,a.unref)(Rt).profession},[((0,a.openBlock)(),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)(Ft,e=>(0,a.createElementVNode)('option',{key:e,value:e},(0,a.toDisplayString)(e),9,h)),64))],8,f),[[a.vModelSelect,(0,a.unref)(Rt).gender]])]),'战姬'===(0,a.unref)(Rt).profession?((0,a.openBlock)(),(0,a.createElementBlock)('label',E,[t[70]||(t[70]=(0,a.createElementVNode)('span',null,'战姬类型',-1)),(0,a.withDirectives)((0,a.createElementVNode)('select',{'onUpdate:modelValue':t[7]||(t[7]=e=>(0,a.unref)(Rt).warmaidType=e)},[((0,a.openBlock)(),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)(Ut,e=>(0,a.createElementVNode)('option',{key:e,value:e},(0,a.toDisplayString)(e),9,V)),64))],512),[[a.vModelSelect,(0,a.unref)(Rt).warmaidType]])])):(0,a.createCommentVNode)('v-if',!0),'战姬'===(0,a.unref)(Rt).profession?((0,a.openBlock)(),(0,a.createElementBlock)('label',N,[t[71]||(t[71]=(0,a.createElementVNode)('span',null,'战姬类型说明（世界书原文）',-1)),(0,a.createElementVNode)('textarea',{value:(0,a.unref)(Yt),rows:'10',readonly:''},null,8,k)])):(0,a.createCommentVNode)('v-if',!0),(0,a.createElementVNode)('div',b,[(0,a.createElementVNode)('button',{type:'button',class:'ghost',onClick:t[8]||(t[8]=e=>gt.value=!1)},'返回开始界面'),(0,a.createElementVNode)('button',{type:'button',onClick:ua},'下一步')])])):((0,a.openBlock)(),(0,a.createElementBlock)('section',l,[t[61]||(t[61]=(0,a.createElementVNode)('div',{class:'start-screen__veil'},null,-1)),(0,a.createElementVNode)('div',r,[t[56]||(t[56]=(0,a.createElementVNode)('p',{class:'start-card__kicker'},'LIBRARY NODE / LAYER SESSION',-1)),t[57]||(t[57]=(0,a.createElementVNode)('h2',null,'天启黎明',-1)),t[58]||(t[58]=(0,a.createElementVNode)('p',{class:'start-card__author'},'作者：未来',-1)),t[59]||(t[59]=(0,a.createElementVNode)('p',{class:'start-card__desc'},'同层流式界面已加载。进入后可在一个界面里完成输入、AI回复与翻页推进。',-1)),t[60]||(t[60]=(0,a.createElementVNode)('p',{class:'start-card__quote'},'[入此地者，祝你好运]',-1)),(0,a.createElementVNode)('p',o,'当前路线：'+(0,a.toDisplayString)((0,a.unref)(Nt)?`异种开局（${(0,a.unref)(kt)}）`:'常规开局'),1),(0,a.createElementVNode)('p',s,'当前建卡：'+(0,a.toDisplayString)((0,a.unref)(Et)?'作弊模式已开启':'标准模式'),1),(0,a.createElementVNode)('p',i,'当前叙事：'+(0,a.toDisplayString)((0,a.unref)(Vt)?'剧情模式':'自由模式'),1),(0,a.createElementVNode)('div',c,[(0,a.createElementVNode)('button',{type:'button',onClick:ia},'开始游戏'),(0,a.createElementVNode)('button',{type:'button',class:'xeno',onClick:ca},(0,a.toDisplayString)((0,a.unref)(Nt)?'异种开局：已选':'异种开局'),1),(0,a.createElementVNode)('button',{type:'button',class:'ghost',onClick:t[0]||(t[0]=e=>Vt.value=!(0,a.unref)(Vt))},(0,a.toDisplayString)((0,a.unref)(Vt)?'剧情模式：开启':'剧情模式：关闭'),1),(0,a.createElementVNode)('button',{type:'button',class:'ghost',onClick:t[1]||(t[1]=e=>Et.value=!(0,a.unref)(Et))},(0,a.toDisplayString)((0,a.unref)(Et)?'作弊模式：开启':'作弊模式：关闭'),1),(0,a.createElementVNode)('button',{type:'button',class:'ghost',onClick:Rn},'读取酒馆配置')])])])),(0,a.unref)(_t).length||(0,a.unref)(Tt).active?((0,a.openBlock)(),(0,a.createElementBlock)('section',ot,[(0,a.unref)(Tt).active?((0,a.openBlock)(),(0,a.createElementBlock)('article',st,[(0,a.createElementVNode)('header',null,[t[119]||(t[119]=(0,a.createElementVNode)('span',null,'数据库任务',-1)),(0,a.createElementVNode)('span',null,(0,a.toDisplayString)((0,a.unref)(Tt).completed?'完成':'运行中'),1)]),(0,a.unref)(Tt).completed?((0,a.openBlock)(),(0,a.createElementBlock)('div',ct,(0,a.toDisplayString)((0,a.unref)(Tt).label)+' 已完成，可继续游玩。 ',1)):((0,a.openBlock)(),(0,a.createElementBlock)('div',it,(0,a.toDisplayString)((0,a.unref)(Tt).label)+' · 已运行 '+(0,a.toDisplayString)((0,a.unref)(Tt).seconds)+' 秒 ',1))])):(0,a.createCommentVNode)('v-if',!0),((0,a.openBlock)(!0),(0,a.createElementBlock)(a.Fragment,null,(0,a.renderList)((0,a.unref)(_t),e=>((0,a.openBlock)(),(0,a.createElementBlock)('article',{key:e.id,class:'system-notice'},[(0,a.createElementVNode)('header',null,[t[120]||(t[120]=(0,a.createElementVNode)('span',null,'系统提示',-1)),(0,a.createElementVNode)('button',{type:'button',class:'ghost small',onClick:t=>An(e.id)},'关闭',8,ut)]),(0,a.createElementVNode)('div',null,(0,a.toDisplayString)(e.content),1)]))),128))])):(0,a.createCommentVNode)('v-if',!0)],512))}});const vt=(0,n(313).A)(pt,[['__scopeId','data-v-26213a16']]);async function yt(){'undefined'!=typeof window&&void 0!==window.SillyTavern&&$('#chat').length&&await async function(){try{const{mountStreamingMessages:e}=await Promise.resolve().then(n.bind(n,391)),{unmount:t}=e(()=>(0,a.createApp)(vt,{mode:'embedded'}));return $(window).on('pagehide',()=>t()),!0}catch(e){return console.warn('[同层测试] 酒馆同层挂载失败，自动回退为独立模式',e),!1}}()||(!function(){let e=document.querySelector('#app');e||(e=document.createElement('div'),e.id='app',document.body.append(e))}(),(0,a.createApp)(vt,{mode:'standalone'}).mount('#app'))}'loading'===document.readyState?document.addEventListener('DOMContentLoaded',()=>{yt()}):yt();
//# sourceMappingURL=index.js.map</script></head><body><div id="app"></div></body>